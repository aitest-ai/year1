<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Scratch é­”æ³•å¯¦é©—å®¤ (V16 å‹å–„èªæ°£ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* é…è‰²ä¿æŒæ´»æ½‘ä½†ä¸åˆºçœ¼ */
        :root { 
            --primary: #4C97FF; /* Scratch Blue */
            --accent: #FFAB19;  /* Scratch Orange */
            --danger: #FF6B6B;  
            --bg: #F7F9FC;
            --chat-bg: #ffffff;
        }
        body { margin: 0; display: flex; height: 100vh; font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background: var(--bg); overflow: hidden; }

        /* å·¦å´é¢æ¿ */
        .sidebar { 
            width: 320px; background: white; padding: 15px; 
            display: flex; flex-direction: column; border-right: 2px solid #E0E0E0; 
            z-index: 10; box-shadow: 4px 0 15px rgba(0,0,0,0.05);
        }
        
        .task-card {
            background: #E3F2FD; border-left: 6px solid var(--primary);
            padding: 15px; border-radius: 12px; margin-bottom: 15px; font-size: 1em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .cam-wrapper {
            position: relative; width: 100%; height: 180px; 
            background: #000; border-radius: 12px; overflow: hidden; 
            border: 3px solid #FFD54F;
            margin-bottom: 10px; display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .cam-placeholder { position: absolute; text-align: center; color: #fff; display: none; width: 100%; z-index: 5; }
        .retry-btn { background: var(--primary); border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; color: white; }

        .face-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.7); color: white; padding: 8px;
            text-align: center; font-size: 0.9em; border-radius: 0 0 10px 10px;
        }

        /* å„€è¡¨æ¿ */
        .monitor-panel {
            background: #fff; border: 2px solid #eee; border-radius: 15px;
            padding: 15px; margin-bottom: 10px;
        }
        .metric-row { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px; color: #555; }
        .high-stress { color: var(--danger); font-weight: bold; }
        .stress-bar-bg { height: 12px; background: #eee; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .stress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.5s, background 0.5s; border-radius: 10px; }

        /* å³å´ä¸»ç•«é¢ */
        .main-area { flex: 1; position: relative; display: flex; flex-direction: column; }
        .scratch-frame { flex: 1; width: 100%; border: none; }

        /* TA é¢æ¿ */
        .ta-panel {
            height: 300px; background: white; border-top: 2px solid #E0E0E0;
            display: flex; flex-direction: column; padding: 15px;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05); z-index: 20;
        }
        .ta-header { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 1.1em; }
        .ta-chat-box { flex: 1; overflow-y: auto; background: #FAFAFA; padding: 15px; border-radius: 12px; border: 2px solid #eee; font-size: 0.95em; margin-bottom: 10px; }
        
        .ta-input-row { display: flex; gap: 10px; align-items: center; }
        .ta-input { flex: 1; padding: 10px 15px; border: 2px solid #ddd; border-radius: 25px; outline: none; height: 40px; box-sizing: border-box; font-size: 1em; }
        .ta-input:focus { border-color: var(--primary); }
        .btn-icon { 
            background: #F0F0F0; border: none; width: 42px; height: 42px; 
            border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; 
            font-size: 1.4em; flex-shrink: 0; transition: 0.2s;
        }
        .btn-icon:hover { background: #E0E0E0; transform: scale(1.1); }
        .btn-send { 
            background: var(--primary); color: white; border: none; padding: 0 25px; 
            border-radius: 25px; cursor: pointer; font-weight: bold; height: 40px; flex-shrink: 0; font-size: 1em;
        }
        .btn-send:hover { background: #357abd; transform: translateY(-2px); }

        .msg { margin-bottom: 10px; padding: 10px 15px; border-radius: 15px; max-width: 95%; line-height: 1.5; word-wrap: break-word; }
        .msg.ai { background: #E3F2FD; color: #1565C0; align-self: flex-start; border-radius: 15px 15px 15px 2px; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-radius: 15px 15px 2px 15px; }
        .msg.system { background: #FFF3E0; color: #E65100; text-align: center; font-size: 0.9em; border: 1px solid #FFE0B2; align-self: center; width: 90%; border-radius: 10px; }

        /* æš–å¿ƒ AI å½ˆçª— */
        .empathy-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); 
            z-index: 9999; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .empathy-box {
            background: white; width: 480px; max-height: 85vh; 
            border-radius: 20px; overflow: hidden; display: flex; flex-direction: column;
            box-shadow: 0 20px 60px rgba(76, 151, 255, 0.2); animation: fadeIn 0.4s;
            border: 3px solid #FFD54F;
        }
        @keyframes fadeIn { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        .empathy-header { background: #FFF8E1; padding: 25px; display: flex; align-items: center; gap: 20px; border-bottom: 2px solid #FFE0B2; flex-shrink: 0; }
        .avatar-heart { font-size: 3.5em; } 
        
        .empathy-content { padding: 30px; color: #5D4037; line-height: 1.8; overflow-y: auto; flex: 1; font-size: 1.1em; }
        
        .empathy-actions { padding: 20px; background: #fff; border-top: 2px solid #f0f0f0; display: flex; flex-direction: column; gap: 12px; flex-shrink: 0; }
        .btn-comfort { padding: 15px 20px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; font-size: 1.1em; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-warm { background: #FFAB00; color: white; box-shadow: 0 5px 15px rgba(255, 171, 0, 0.3); }
        .btn-warm:hover { transform: scale(1.02); }
        .btn-close { background: #F5F5F5; color: #777; }
        .btn-close:hover { background: #EEEEEE; }

        #capture-video, #capture-canvas { display: none; }
    </style>
</head>
<body>

    <div id="empathy-modal" class="empathy-modal">
        <div class="empathy-box">
            <div class="empathy-header">
                <div class="avatar-heart">ğŸ§¡</div>
                <div>
                    <h2 style="margin:0; color:#F57F17; font-size:1.5em;">æ·±å‘¼å¸ï¼Œæ”¾é¬†ä¸€ä¸‹</h2>
                    <small style="color:#F9A825; font-size:1em;">æˆ‘æ˜¯ä½ çš„æš–å¿ƒå¤¥ä¼´</small>
                </div>
            </div>
            <div class="empathy-content" id="empathy-msg">
                Loading...
            </div>
            <div class="empathy-actions">
                <button class="btn-comfort btn-warm" onclick="handoverToTA()">ğŸ“¸ è«‹é­”æ³•å°å¸«å¹«æˆ‘çœ‹ç©æœ¨</button>
                <button class="btn-comfort btn-close" onclick="closeEmpathy()">æ²’äº‹ï¼Œæˆ‘å†è©¦è©¦çœ‹</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="margin:0 0 10px 0; color:#444;">ğŸ§© Scratch é­”æ³•å¯¦é©—å®¤</h3>
        
        <div class="task-card">
            <strong>ğŸš€ ä»Šå¤©çš„æŒ‘æˆ°ï¼šè·³è·³è²“</strong><br>
            1. æŒ‰ä¸‹ç©ºç™½éµ<br>
            2. å¾€ä¸Šè·³ (Y + 100)<br>
            3. ç­‰ä¸€ä¸‹ (0.5 ç§’)<br>
            4. æ‰ä¸‹ä¾† (Y - 100)
        </div>

        <div class="cam-wrapper">
            <video id="video" autoplay muted playsinline></video>
            <div id="cam-error" class="cam-placeholder">
                âš ï¸ ç›¸æ©Ÿæœªå•Ÿå‹•<br><button class="retry-btn" onclick="initSystem()">é»æ“Šå•Ÿç”¨</button>
            </div>
            <div class="face-overlay">å¿ƒæƒ…: <span id="emo-val">æº–å‚™ä¸­...</span></div>
        </div>

        <div class="monitor-panel">
            <div class="metric-row"><span>ğŸ˜Ÿ è¡¨æƒ…æŒ‡æ•¸</span><span id="score-face">0%</span></div>
            <div class="metric-row"><span>ğŸ–±ï¸ æ»‘é¼ é€Ÿåº¦</span><span id="score-mouse">0%</span></div>
            <div class="metric-row"><span>âŒ¨ï¸ éµç›¤åŠ›é“</span><span id="score-key">0%</span></div>
            <hr style="border:0; border-top:2px solid #eee; margin:10px 0;">
            <div style="display:flex; justify-content:space-between; font-size:1em; font-weight:bold; color:#444;">
                <span>å£“åŠ›æŒ‡æ•¸</span><span id="stress-val">0%</span>
            </div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-fill"></div></div>
        </div>

        <div style="font-size:0.85em; color:#888; margin-top:auto; line-height:1.5;">
            * å³ä¸‹è§’ï¼š<strong>é­”æ³•å°å¸«</strong> (è§£é¡Œ)<br>
            * å£“åŠ›å¤§æ™‚ï¼š<strong>æš–å¿ƒå¤¥ä¼´</strong> (é—œå¿ƒ)
        </div>
    </div>

    <div class="main-area">
        <iframe class="scratch-frame" src="https://stretch3.github.io/" allow="autoplay; camera; microphone; display-capture"></iframe>
        
        <div class="ta-panel">
            <div class="ta-header">
                <span>ğŸ§™â€â™‚ï¸ é­”æ³•å°å¸« (AI åŠ©æ•™)</span>
            </div>
            <div class="ta-chat-box" id="ta-chat">
                <div class="msg ai">å—¨ï¼æˆ‘æ˜¯é­”æ³•å°å¸«ã€‚å¯«ç¨‹å¼é‡åˆ°å•é¡Œå¾ˆæ­£å¸¸ï¼Œä½ å¯ä»¥æ‰“å­—å•æˆ‘ï¼Œæˆ–æ˜¯æŒ‰ç›¸æ©Ÿè®“æˆ‘çœ‹çœ‹ä½ çš„ç¨‹å¼å–”ï¼</div>
            </div>
            <div class="ta-input-row">
                <button class="btn-icon" title="æˆªåœ–çµ¦å°å¸«çœ‹" onclick="captureAndAnalyze('TA_NORMAL')">ğŸ“¸</button>
                <input type="text" id="ta-input" class="ta-input" placeholder="å•å°å¸«å•é¡Œ..." onkeypress="if(event.key==='Enter') sendTextChat()">
                <button class="btn-send" onclick="sendTextChat()">é€å‡º</button>
            </div>
        </div>
    </div>

    <video id="capture-video"></video>
    <canvas id="capture-canvas"></canvas>

    <script>
        const API_KEY = "AIzaSyBXZ7enyD8BdWbuE7lR8V_Akj1KFKucYl0"; // â˜…â˜…â˜… è«‹å‹™å¿…å¡«å…¥æ‚¨çš„ API Key â˜…â˜…â˜…

        let state = {
            stress: 0, faceScore: 0, mouseScore: 0, keyScore: 0,
            isInterventionActive: false,
            clickCount: 0, keyPressCount: 0, mousePositions: [],
            dominantStressor: '' 
        };

        // ==========================================
        // 1. è¡Œç‚ºåµæ¸¬ (æ»‘é¼ /éµç›¤)
        // ==========================================
        document.addEventListener('mousemove', (e) => {
            const now = Date.now();
            state.mousePositions.push({x: e.clientX, y: e.clientY, t: now});
            state.mousePositions = state.mousePositions.filter(p => now - p.t < 1000);
            if(state.mousePositions.length > 5) {
                let dist = 0;
                for(let i=1; i<state.mousePositions.length; i++) {
                    const p1 = state.mousePositions[i-1];
                    const p2 = state.mousePositions[i];
                    dist += Math.sqrt(Math.pow(p2.x-p1.x, 2) + Math.pow(p2.y-p1.y, 2));
                }
                if(dist > 2000) state.mouseScore = Math.min(100, state.mouseScore + 10);
            }
        });
        document.addEventListener('mousedown', () => { state.clickCount++; });
        document.addEventListener('keydown', () => { state.keyPressCount++; });

        setInterval(() => {
            if(state.clickCount > 3) state.mouseScore = Math.min(100, state.mouseScore + 20);
            else state.mouseScore = Math.max(0, state.mouseScore - 5);

            if(state.keyPressCount > 5) state.keyScore = Math.min(100, state.keyScore + 20);
            else state.keyScore = Math.max(0, state.keyScore - 5);

            state.clickCount = 0; state.keyPressCount = 0;
            updateMetricColor('score-mouse', state.mouseScore);
            updateMetricColor('score-key', state.keyScore);
        }, 1000);

        function updateMetricColor(id, score) {
            const el = document.getElementById(id);
            el.innerText = score + "%";
            if(score > 50) el.classList.add('high-stress'); else el.classList.remove('high-stress');
        }

        // ==========================================
        // 2. åˆå§‹åŒ–èˆ‡ç›¸æ©Ÿ
        // ==========================================
        window.onload = function() { initSystem(); };

        async function initSystem() {
            const video = document.getElementById('video');
            const errorMsg = document.getElementById('cam-error');
            const emoVal = document.getElementById('emo-val');

            try {
                errorMsg.style.display = 'none';
                emoVal.innerText = "æ­£åœ¨å‘¼å«ç›¸æ©Ÿ...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.onloadedmetadata = () => { video.play(); };

                emoVal.innerText = "æº–å‚™ä¸­...";
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                emoVal.innerText = "åµæ¸¬ä¸­...";
                startStressLoop();

            } catch(e) {
                console.error(e);
                errorMsg.style.display = 'block';
                emoVal.innerText = "ç„¡æ³•é–‹å•Ÿ";
            }
        }

        // ==========================================
        // 3. ç¶œåˆå£“åŠ›ç›£æ¸¬ (æ ¸å¿ƒä¿®æ­£)
        // ==========================================
        function startStressLoop() {
            const video = document.getElementById('video');
            const emoVal = document.getElementById('emo-val');
            
            setInterval(async () => {
                if(video.paused || video.ended || state.isInterventionActive) return;

                const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
                const dets = await faceapi.detectAllFaces(video, options).withFaceExpressions();
                
                if(dets.length > 0) {
                    const exps = dets[0].expressions;
                    const top = Object.keys(exps).reduce((a,b)=>exps[a]>exps[b]?a:b);
                    // ç¿»è­¯ - ä¸ç”¨ç–Šå­—
                    const map = {neutral:"å¹³éœ ğŸ™‚", happy:"é–‹å¿ƒ ğŸ˜„", sad:"é›£é ğŸ˜¢", angry:"ç”Ÿæ°£ ğŸ˜ ", fearful:"å®³æ€• ğŸ˜¨", disgusted:"è¨å­ ğŸ˜–", surprised:"é©šè¨ ğŸ˜²"};
                    emoVal.innerText = map[top] || top;
                    emoVal.style.color = "#fff";

                    if(['sad', 'angry', 'fearful', 'disgusted'].includes(top)) state.faceScore = Math.min(100, state.faceScore + 10); 
                    else if(top === 'happy') state.faceScore = Math.max(0, state.faceScore - 10); 
                    else state.faceScore = Math.max(0, state.faceScore - 2); 
                } else {
                    emoVal.innerText = "æ‰¾ä¸åˆ°è‡‰ ğŸ‘€";
                    emoVal.style.color = "#FFD54F";
                }
                
                updateMetricColor('score-face', state.faceScore);

                // åˆ¤æ–·ä¸»å› 
                if (state.faceScore >= state.mouseScore && state.faceScore >= state.keyScore) state.dominantStressor = 'FACE';
                else if (state.mouseScore >= state.keyScore) state.dominantStressor = 'MOUSE';
                else state.dominantStressor = 'KEY';

                state.stress = Math.max(state.faceScore, state.mouseScore, state.keyScore);
                document.getElementById('stress-val').innerText = state.stress + "%";
                const bar = document.getElementById('stress-bar');
                bar.style.width = state.stress + "%";
                
                if(state.stress < 50) document.getElementById('stress-bar').style.background = "#4C97FF";
                else if(state.stress < 80) document.getElementById('stress-bar').style.background = "#FFAB19";
                else document.getElementById('stress-bar').style.background = "#FF6B6B";

                if(state.stress > 80) triggerEmpathyAI(state.dominantStressor);

            }, 1000);
        }

        // ==========================================
        // 4. ç²¾æº–é—œæ‡·é‚è¼¯ (æˆç†Ÿå‹å–„ç‰ˆæ–‡æ¡ˆ)
        // ==========================================
        
        function triggerEmpathyAI(reason) {
            state.isInterventionActive = true;
            state.faceScore = 50; state.mouseScore = 0; state.keyScore = 0;
            
            const msgEl = document.getElementById('empathy-msg');
            let content = "";

            if (reason === 'FACE') {
                content = "ä½ çœ‹èµ·ä¾†æœ‰é»å›°æ“¾ï¼Œæ˜¯ä¸æ˜¯ç¨‹å¼å¡é—œäº†ï¼Ÿ<br>æ²’é—œä¿‚ï¼Œæˆ‘å€‘å…ˆæ·±å‘¼å¸ï¼Œæ”¾é¬†ä¸€ä¸‹ã€‚";
            } else if (reason === 'MOUSE') {
                content = "æˆ‘ç™¼ç¾ä½ çš„æ»‘é¼ ç§»å‹•å¾—æœ‰é»æ€¥å–”ï¼Œæ˜¯ä¸æ˜¯å¿ƒè£¡æœ‰é»è‘—æ€¥ï¼Ÿ<br>æ“ä½œå¤ªå¿«å®¹æ˜“å‡ºéŒ¯ï¼Œæˆ‘å€‘ç¨å¾®æ”¾æ…¢ä¸€é»ç¯€å¥ã€‚";
            } else if (reason === 'KEY') {
                content = "æ•²éµç›¤çš„åŠ›é“æœ‰é»å¤§å–”ï¼Œæ‰‹æœƒç— çš„ã€‚<br>å­¸ç¿’ç¨‹å¼é‡åˆ°å›°é›£æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œä¸ç”¨å¤ªç·Šç¹ƒã€‚";
            } else {
                content = "æ„Ÿè¦ºä½ ç¾åœ¨å£“åŠ›æœ‰é»å¤§ã€‚<br>æˆ‘å€‘å…ˆä¼‘æ¯ä¸€ä¸‹ï¼Œå–å£æ°´ï¼Œç­‰ä¸€ä¸‹å†ç¹¼çºŒæŒ‘æˆ°ï¼";
            }

            content += "<br><br>å¦‚æœä½ éœ€è¦å¹«å¿™ï¼Œå¯ä»¥è«‹ **é­”æ³•å°å¸«** å¹«ä½ çœ‹çœ‹ç¨‹å¼å“ªè£¡æœ‰å•é¡Œå–”ï¼";
            msgEl.innerHTML = content;

            document.getElementById('empathy-modal').style.display = 'flex';
        }

        function closeEmpathy() {
            document.getElementById('empathy-modal').style.display = 'none';
            setTimeout(() => { state.isInterventionActive = false; }, 5000);
        }

        function handoverToTA() {
            document.getElementById('empathy-modal').style.display = 'none';
            const taBox = document.getElementById('ta-chat');
            taBox.innerHTML += `<div class="msg system">âœ¨ æš–å¿ƒå¤¥ä¼´å·²é€šçŸ¥é­”æ³•å°å¸«...</div>`;
            
            captureAndAnalyze('TA_STRESSED_' + state.dominantStressor);
            
            setTimeout(() => { state.isInterventionActive = false; }, 5000);
        }

        // --- èŠå¤©èˆ‡æˆªåœ– ---
        async function sendTextChat() {
            const input = document.getElementById('ta-input');
            const val = input.value.trim();
            if(!val) return;
            const taBox = document.getElementById('ta-chat');
            taBox.innerHTML += `<div class="msg user">${val}</div>`;
            taBox.scrollTop = taBox.scrollHeight;
            input.value = "";
            await callGeminiText(val);
        }

        async function captureAndAnalyze(mode) {
            const taBox = document.getElementById('ta-chat');
            if(mode.includes('TA')) {
                taBox.innerHTML += `<div class="msg user">ğŸ“¸ å‚³é€æˆªåœ–ä¸­...</div>`;
            }

            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "never" }, audio: false, preferCurrentTab: true
                });
                const videoEl = document.getElementById('capture-video');
                videoEl.srcObject = stream;
                await new Promise(r => videoEl.onloadedmetadata = r);
                videoEl.play();
                await new Promise(r => setTimeout(r, 500)); 

                const canvas = document.getElementById('capture-canvas');
                canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
                canvas.getContext('2d').drawImage(videoEl, 0, 0);
                stream.getTracks().forEach(t => t.stop()); 
                const base64 = canvas.toDataURL('image/jpeg', 0.7);

                await callGeminiVision(mode, base64);

            } catch(e) {
                if(mode.includes('TA')) taBox.innerHTML += `<div class="msg ai">âš ï¸ æˆªåœ–å¤±æ•—ï¼Œè«‹è¨˜å¾—æŒ‰ã€Œåˆ†äº«ã€å–”ã€‚</div>`;
            }
        }

        // --- Gemini API (Text) ---
        async function callGeminiText(userText) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
            const taBox = document.getElementById('ta-chat');
            
            // â˜… AI äººè¨­ï¼šå‹å–„ã€é¼“å‹µã€ä¸èªªæ•™ â˜…
            const prompt = `ä½ æ˜¯ Scratch é­”æ³•å°å¸«ã€‚å°è±¡æ˜¯å°å­¸é«˜å¹´ç´šã€‚å­¸ç”Ÿå•ï¼š${userText}ã€‚è«‹ç”¨åƒæœ‹å‹ä¸€æ¨£çš„èªæ°£å›ç­”ï¼Œç°¡å–®æ˜“æ‡‚ã€‚ä¸è¦ç›´æ¥çµ¦ç­”æ¡ˆï¼Œè©¦è‘—å¼•å°ä»–æ€è€ƒã€‚ä¸è¦ç”¨ç–Šå­—ã€‚`;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                taBox.innerHTML += `<div class="msg ai">${marked.parse(reply)}</div>`;
                taBox.scrollTop = taBox.scrollHeight;
            } catch(e) {
                taBox.innerHTML += `<div class="msg ai">é­”æ³•é€£ç·šä¸­æ–·äº†...è«‹æª¢æŸ¥ç¶²è·¯ã€‚</div>`;
            }
        }

        // --- Gemini API (Vision) ---
        async function callGeminiVision(mode, image64) {
            const cleanBase64 = image64.split(',')[1];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            const taBox = document.getElementById('ta-chat');

            let systemPrompt = "";
            if (mode.startsWith('TA_STRESSED')) {
                const reason = mode.split('_')[2]; 
                let context = "";
                if(reason === 'MOUSE') context = "å­¸ç”Ÿå‰›å‰›å› ç‚ºæ»‘é¼ æ“ä½œå¤ªæ€¥è€Œæ„Ÿåˆ°æŒ«æŠ˜ã€‚";
                if(reason === 'KEY') context = "å­¸ç”Ÿå‰›å‰›å› ç‚ºéµç›¤æ•²æ“Šå¤ªå¿«è€Œæ„Ÿåˆ°ç„¦æ…®ã€‚";
                if(reason === 'FACE') context = "å­¸ç”Ÿçš„è¡¨æƒ…çœ‹èµ·ä¾†å¾ˆå›°æ“¾ã€‚";
                
                systemPrompt = `
                ä½ æ˜¯ Scratch é­”æ³•å°å¸«ã€‚å°è±¡æ˜¯å°å­¸é«˜å¹´ç´šã€‚
                **${context} æš–å¿ƒå¤¥ä¼´å·²ç¶“å®‰æ’«éä»–äº†ã€‚**
                è«‹ç”¨"éå¸¸æº«æŸ”ã€æœ‰è€å¿ƒ"çš„èªæ°£ã€‚ä¸è¦ç”¨ç–Šå­—ã€‚
                è«‹çœ‹æˆªåœ–(å¿½ç•¥å·¦å³å´ï¼Œå°ˆæ³¨ä¸­é–“ç©æœ¨å€)ï¼Œæª¢æŸ¥è·³è·³è²“ä»»å‹™(ç©ºç™½éµ->Y+100->ç­‰å¾…->Y-100)æ˜¯å¦æœ‰éŒ¯ï¼Ÿ
                çµ¦å‡ºä¸€å€‹æ˜ç¢ºçš„æç¤ºå³å¯ï¼Œå­—æ•¸ä¸ç”¨å¤šã€‚
                `;
            } else {
                systemPrompt = `ä½ æ˜¯ Scratch é­”æ³•å°å¸«ã€‚å°è±¡æ˜¯å°å­¸é«˜å¹´ç´šã€‚è«‹çœ‹æˆªåœ–(å°ˆæ³¨ä¸­é–“ç©æœ¨å€)ï¼Œæª¢æŸ¥ç¨‹å¼é‚è¼¯æ˜¯å¦ç¬¦åˆè·³è·³è²“ä»»å‹™ã€‚è«‹ç”¨ç°¡å–®æ¸…æ¥šçš„ä¸­æ–‡æŒ‡å‡ºå•é¡Œï¼Œä¸¦çµ¦äºˆé¼“å‹µã€‚`;
            }

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: systemPrompt },
                                { inlineData: { mimeType: "image/jpeg", data: cleanBase64 } }
                            ]
                        }]
                    })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                taBox.innerHTML += `<div class="msg ai">${marked.parse(reply)}</div>`;
                taBox.scrollTop = taBox.scrollHeight;
            } catch(e) {
                taBox.innerHTML += `<div class="msg ai">é­”æ³•é€£ç·šå¤±æ•—ã€‚</div>`;
            }
        }
    </script>
</body>
</html>
