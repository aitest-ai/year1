<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Scratch å¯¦é©—å®¤</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* ========================
           å…¨åŸŸè®Šæ•¸èˆ‡åŸºç¤è¨­å®š
           ======================== */
        :root { 
            --primary: #4C97FF; 
            --accent: #FFAB19; 
            --danger: #FF6B6B;  
            --bg: #F7F9FC; 
            --wood: #5D4037; /* æ·±æœ¨é ­è‰² */
            --gold: #FFD54F; /* é‡‘å±¬è£é£¾è‰² */
            --paper: #FFF8E1; /* ç¾Šçš®ç´™è‰² */
        }
        body { margin: 0; display: flex; height: 100vh; font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); overflow: hidden; }

        /* ========================
           1. æ©«å‘å·è»¸å‹•ç•«ç³»çµ± (Horizontal Scroll)
           ======================== */
        .mission-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.6); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: background 0.8s ease 4.5s;
            pointer-events: none; 
        }

        .scroll-container {
            position: relative;
            height: 300px; /* å±•é–‹æ™‚çš„å›ºå®šé«˜åº¦ */
            width: 0px;    /* åˆå§‹å¯¬åº¦ç‚º 0 */
            display: flex; flex-direction: row; /* â˜… æ”¹ç‚ºæ©«å‘æ’åˆ— */
            align-items: center;
            transition: all 1s cubic-bezier(0.25, 1, 0.5, 1);
            pointer-events: auto;
        }

        /* å·¦å³å…©æ ¹å·è»¸æ¡¿ */
        .scroll-handle {
            width: 18px; height: 110%; /* æ¯”ç´™å¼µç¨å¾®é•·ä¸€é» */
            background: linear-gradient(to right, #3E2723, var(--wood), #3E2723);
            border-radius: 10px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.4);
            position: relative; z-index: 2;
            flex-shrink: 0;
        }

        /* æ¡¿å­å…©ç«¯çš„é‡‘å±¬è£é£¾ (ä¸Šä¸‹) */
        .scroll-handle::before, .scroll-handle::after {
            content: ''; position: absolute; left: -3px; width: 24px; height: 15px;
            background: var(--gold); border-radius: 4px;
            box-shadow: inset 1px 1px 3px rgba(255,255,255,0.5), 0 2px 3px rgba(0,0,0,0.3);
        }
        .scroll-handle::before { top: -10px; }
        .scroll-handle::after { bottom: -10px; }

        /* ä¸­é–“çš„ç´™å¼µ */
        .scroll-body {
            background: var(--paper);
            height: 100%; 
            width: 0px; /* åˆå§‹å¯¬åº¦ */
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
            border-top: 2px solid #e0c090; border-bottom: 2px solid #e0c090;
            /* ç´™å¼µç´‹ç† */
            background-image: linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
            background-size: 20px 100%;
        }

        /* === å‹•ç•«ç‹€æ…‹ï¼šå±•é–‹ (Open) === */
        .scroll-container.open { width: 700px; } /* å±•é–‹ç¸½å¯¬åº¦ */
        .scroll-container.open .scroll-body { width: 100%; }

        /* === å‹•ç•«ç‹€æ…‹ï¼šæ”¶èµ·ä¸¦å®šä½åˆ°å·¦ä¸Š (Minimized) === */
        .scroll-container.minimized {
            position: fixed;
            /* â˜… é—œéµå®šä½ï¼šå°é½Š Sidebar (padding 15px) */
            top: 15px; left: 15px; 
            /* â˜… é—œéµå¯¬åº¦ï¼šSidebar 320px - padding 30px = 290px */
            width: 290px !important; 
            height: 160px; /* ç¸®å°å¾Œçš„é«˜åº¦ */
            transform: none !important;
            z-index: 50;
        }
        
        .scroll-container.minimized .scroll-handle { height: 100%; width: 12px; } /* æ¡¿å­è®Šç´° */
        .scroll-container.minimized .scroll-handle::before, 
        .scroll-container.minimized .scroll-handle::after { left: -2px; width: 16px; height: 8px; }
        
        .scroll-container.minimized .scroll-body {
            width: 100%;
            align-items: flex-start; /* å…§å®¹é å·¦ */
            padding: 10px;
            background: #FFFDE7; /* ç¨å¾®äº®ä¸€é» */
            border: 1px solid #FFD54F;
        }

        /* å…§å®¹æ¨£å¼ */
        .scroll-content { 
            opacity: 0; transition: opacity 0.5s 0.8s; width: 85%; 
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—åœ¨å±•é–‹å‰æ›è¡Œ */
        }
        .scroll-container.open .scroll-content { opacity: 1; white-space: normal; }
        .scroll-container.minimized .scroll-content { opacity: 1; white-space: normal; text-align: left; }

        .scroll-title { font-size: 2em; color: #E65100; margin-bottom: 20px; font-weight: bold; border-bottom: 2px dashed #E65100; display: inline-block; padding-bottom: 5px;}
        .scroll-container.minimized .scroll-title { font-size: 1.1em; margin-bottom: 8px; border: none; display: flex; align-items: center; gap: 5px; }
        
        .scroll-list { list-style: none; padding: 0; font-size: 1.2em; color: #5D4037; line-height: 1.8; text-align: left; display: inline-block; }
        .scroll-container.minimized .scroll-list { font-size: 0.9em; line-height: 1.4; display: block; }
        .scroll-container.minimized .scroll-list li { margin-bottom: 3px; padding-left: 5px; }


        /* ========================
           2. å·¦å´é¢æ¿ (Sidebar)
           ======================== */
        .sidebar { 
            width: 320px; background: white; padding: 15px; 
            display: flex; flex-direction: column; border-right: 2px solid #E0E0E0; 
            z-index: 10; box-shadow: 4px 0 15px rgba(0,0,0,0.05);
            /* â˜… é‡é»ï¼šé ç•™ä¸Šæ–¹ç©ºé–“çµ¦é£›å›ä¾†çš„å·è»¸ (160px é«˜åº¦ + 15px é–“è· + 15px top) */
            padding-top: 190px; 
            position: relative;
        }

        .cam-wrapper {
            position: relative; width: 100%; height: 180px; 
            background: #000; border-radius: 12px; overflow: hidden; 
            border: 3px solid #FFD54F; margin-bottom: 10px; 
            display: flex; justify-content: center; align-items: center; flex-shrink: 0;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .cam-placeholder { position: absolute; text-align: center; color: #fff; display: none; width: 100%; z-index: 5; }
        .retry-btn { background: var(--primary); border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; color: white; }
        .face-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.7); color: white; padding: 8px;
            text-align: center; font-size: 0.9em; border-radius: 0 0 10px 10px;
        }

        .monitor-panel {
            background: #fff; border: 2px solid #eee; border-radius: 15px;
            padding: 15px; margin-bottom: 10px; flex-shrink: 0;
        }
        .metric-row { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px; color: #555; }
        .high-stress { color: var(--danger); font-weight: bold; }
        .stress-bar-bg { height: 12px; background: #eee; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .stress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.5s, background 0.5s; border-radius: 10px; }

        /* ========================
           3. å³å´ä¸»ç•«é¢èˆ‡ TA é¢æ¿
           ======================== */
        .main-area { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .scratch-frame { flex: 1; width: 100%; border: none; }

        .ta-panel {
            height: 350px; 
            background: white; border-top: 2px solid #E0E0E0;
            display: flex; flex-direction: column; padding: 15px;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05); z-index: 20;
            flex-shrink: 0; 
            box-sizing: border-box;
        }
        .ta-header { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 1.1em; flex-shrink: 0; }
        
        .ta-chat-box { 
            flex: 1; overflow-y: auto; 
            background: #FAFAFA; padding: 15px; border-radius: 12px; border: 2px solid #eee; 
            font-size: 0.95em; margin-bottom: 10px; 
            min-height: 0; 
        }
        
        .ta-input-row { display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        .ta-input { flex: 1; padding: 10px 15px; border: 2px solid #ddd; border-radius: 25px; outline: none; height: 40px; box-sizing: border-box; font-size: 1em; }
        .ta-input:focus { border-color: var(--primary); }
        .btn-icon { background: #F0F0F0; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.4em; flex-shrink: 0; transition: 0.2s; }
        .btn-icon:hover { background: #E0E0E0; transform: scale(1.1); }
        .btn-send { background: var(--primary); color: white; border: none; padding: 0 25px; border-radius: 25px; cursor: pointer; font-weight: bold; height: 40px; flex-shrink: 0; font-size: 1em; }
        .btn-send:hover { background: #357abd; transform: translateY(-2px); }

        .msg { margin-bottom: 10px; padding: 10px 15px; border-radius: 15px; max-width: 95%; line-height: 1.5; word-wrap: break-word; }
        .msg.ai { background: #E3F2FD; color: #1565C0; align-self: flex-start; border-radius: 15px 15px 15px 2px; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-radius: 15px 15px 2px 15px; }
        .msg.system { background: #FFF3E0; color: #E65100; text-align: center; font-size: 0.9em; border: 1px solid #FFE0B2; align-self: center; width: 90%; border-radius: 10px; }

        /* ========================
           4. æš–å¿ƒ AI å½ˆçª—
           ======================== */
        .empathy-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); 
            z-index: 9999; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .empathy-box {
            background: white; width: 500px; height: 600px; max-height: 90vh; 
            border-radius: 20px; overflow: hidden; display: flex; flex-direction: column;
            box-shadow: 0 20px 60px rgba(76, 151, 255, 0.2); animation: fadeIn 0.4s;
            border: 3px solid #FFD54F;
        }
        @keyframes fadeIn { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        .empathy-header { background: #FFF8E1; padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 2px solid #FFE0B2; flex-shrink: 0; }
        .avatar-heart { font-size: 3em; } 
        .empathy-chat-area { padding: 20px; flex: 1; overflow-y: auto; background: #fff; display: flex; flex-direction: column; gap: 10px; }
        .msg.warm { background: #FFF3E0; color: #E65100; align-self: flex-start; border-radius: 15px 15px 15px 2px; }
        .empathy-input-area { padding: 15px; background: #FFFDE7; border-top: 2px solid #FFE0B2; display: flex; gap: 10px; align-items: center; flex-shrink: 0; }
        .emp-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #FFCC80; outline: none; }
        .empathy-actions { padding: 15px; background: #fff; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; align-items: center; }
        .btn-handoff { background: linear-gradient(135deg, #FFAB00, #FF6F00); color: white; padding: 12px 30px; border-radius: 30px; border: none; cursor: pointer; font-weight: bold; font-size: 1.1em; box-shadow: 0 4px 10px rgba(255, 111, 0, 0.3); width: 80%; transition: 0.2s; }
        .btn-handoff:hover { transform: scale(1.02); }
        .btn-close { background: transparent; color: #888; border: none; cursor: pointer; font-size: 0.9em; text-decoration: underline; }

        #capture-video, #capture-canvas { display: none; }
    </style>
</head>
<body>

    <div id="mission-overlay" class="mission-overlay">
        <div id="scroll-container" class="scroll-container">
            <div class="scroll-handle left"></div>
            <div class="scroll-body">
                <div class="scroll-content">
                    <div class="scroll-title">ğŸ“œ ä»Šå¤©çš„æŒ‘æˆ°ï¼šè·³è·³è²“</div>
                    <ul class="scroll-list">
                        <li>1. æŒ‰ä¸‹ç©ºç™½éµ</li>
                        <li>2. å¾€ä¸Šè·³ (Y + 100)</li>
                        <li>3. ç­‰å¾…ä¸€ä¸‹ (0.5 ç§’)</li>
                        <li>4. æ‰ä¸‹ä¾† (Y - 100)</li>
                    </ul>
                </div>
            </div>
            <div class="scroll-handle right"></div>
        </div>
    </div>

    <div id="empathy-modal" class="empathy-modal">
        <div class="empathy-box">
            <div class="empathy-header">
                <div class="avatar-heart">ğŸ§¡</div>
                <div>
                    <h2 style="margin:0; color:#F57F17; font-size:1.4em;">æ·±å‘¼å¸ï¼Œæˆ‘åœ¨é€™è£¡</h2>
                    <small style="color:#F9A825; font-size:0.9em;">æš–å¿ƒå¤¥ä¼´</small>
                </div>
            </div>
            
            <div class="empathy-chat-area" id="empathy-chat">
                </div>

            <div class="empathy-input-area">
                <input type="text" id="emp-input" class="emp-input" placeholder="è·Ÿæˆ‘èªªèªªæ€éº¼äº†å—ï¼Ÿ" onkeypress="if(event.key==='Enter') sendEmpathyChat()">
                <button class="btn-send" style="background:#FFB74D" onclick="sendEmpathyChat()">é€å‡º</button>
            </div>

            <div class="empathy-actions">
                <button class="btn-handoff" onclick="handoverToTA()">ğŸ“¸ å¿ƒæƒ…å¥½é»äº†ï¼Œè«‹ç©æœ¨å¤§å¸«å¹«æˆ‘çœ‹ç©æœ¨</button>
                <button class="btn-close" onclick="closeEmpathy()">æˆ‘æ²’äº‹äº†ï¼Œå›å»è©¦è©¦çœ‹</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="cam-wrapper">
            <video id="video" autoplay muted playsinline></video>
            <div id="cam-error" class="cam-placeholder">
                âš ï¸ ç›¸æ©Ÿæœªå•Ÿå‹•<br><button class="retry-btn" onclick="initSystem()">é»æ“Šå•Ÿç”¨</button>
            </div>
            <div class="face-overlay">å¿ƒæƒ…: <span id="emo-val">æº–å‚™ä¸­...</span></div>
        </div>

        <div class="monitor-panel">
            <div class="metric-row"><span>ğŸ˜Ÿ è¡¨æƒ…æŒ‡æ•¸</span><span id="score-face">0%</span></div>
            <div class="metric-row"><span>ğŸ–±ï¸ æ»‘é¼ é€Ÿåº¦</span><span id="score-mouse">0%</span></div>
            <div class="metric-row"><span>âŒ¨ï¸ éµç›¤åŠ›é“</span><span id="score-key">0%</span></div>
            <hr style="border:0; border-top:2px solid #eee; margin:10px 0;">
            <div style="display:flex; justify-content:space-between; font-size:1em; font-weight:bold; color:#444;">
                <span>å£“åŠ›æŒ‡æ•¸</span><span id="stress-val">0%</span>
            </div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-fill"></div></div>
        </div>

        <div style="font-size:0.85em; color:#888; margin-top:auto; line-height:1.5;">
            * å³ä¸‹è§’ï¼š<strong>ç©æœ¨å¤§å¸«</strong> (è§£é¡Œ)<br>
            * å£“åŠ›å¤§æ™‚ï¼š<strong>æš–å¿ƒå¤¥ä¼´</strong> (é™ªä½ èŠå¤©)
        </div>
    </div>

    <div class="main-area">
        <iframe class="scratch-frame" src="https://stretch3.github.io/" allow="autoplay; camera; microphone; display-capture"></iframe>
        
        <div class="ta-panel">
            <div class="ta-header">
                <span>ğŸ§™â€â™‚ï¸ ç©æœ¨å¤§å¸«</span>
            </div>
            <div class="ta-chat-box" id="ta-chat">
                <div class="msg ai">å—¨ï¼æˆ‘æ˜¯ç©æœ¨å¤§å¸«ã€‚å¯«ç¨‹å¼é‡åˆ°å•é¡Œå¾ˆæ­£å¸¸ï¼Œä½ å¯ä»¥æ‰“å­—å•æˆ‘ï¼Œæˆ–æ˜¯æŒ‰ç›¸æ©Ÿè®“æˆ‘çœ‹çœ‹ä½ çš„ç¨‹å¼å–”ï¼</div>
            </div>
            <div class="ta-input-row">
                <button class="btn-icon" title="æˆªåœ–çµ¦å°å¸«çœ‹" onclick="captureAndAnalyze('TA_NORMAL')">ğŸ“¸</button>
                <input type="text" id="ta-input" class="ta-input" placeholder="å•å°å¸«å•é¡Œ..." onkeypress="if(event.key==='Enter') sendTextChat()">
                <button class="btn-send" onclick="sendTextChat()">é€å‡º</button>
            </div>
        </div>
    </div>

    <video id="capture-video"></video>
    <canvas id="capture-canvas"></canvas>

    <script>
        const API_KEY = "AIzaSyDnVdlB1rjVqZ8HZcKhfmm-yv5Qafv0bCk"; // â˜…â˜…â˜… è«‹å‹™å¿…å¡«å…¥æ‚¨çš„ API Key â˜…â˜…â˜…
        
        const TA_SYSTEM_PROMPT = `
        ä½ æ˜¯ Scratch ç©æœ¨å¤§å¸«ã€‚å°è±¡æ˜¯å°å­¸é«˜å¹´ç´šã€‚
        **æ ¸å¿ƒè¦å‰‡ï¼š**
        1. **ç¦æ­¢ä¸€æ¬¡çµ¦å‡ºå®Œæ•´ç­”æ¡ˆ**ï¼šè«‹åƒå‰æ´‹è”¥ä¸€æ¨£ï¼Œä¸€æ¬¡åªæ•™ä¸€å€‹æ­¥é©Ÿã€‚
        2. **ä¸€æ­¥ä¸€æ­¥ä¾†**ï¼šæ¯æ¬¡å›ç­”åªèƒ½å°ˆæ³¨æ–¼é€™ä¸€æ­¥ï¼Œä¸è¦è·³åˆ°ä¸‹ä¸€æ­¥ã€‚
        3. **çŸ­å›ç­”**ï¼šæ¯æ¬¡å›ç­”è«‹æ§åˆ¶åœ¨ 50 å­—ä»¥å…§ï¼Œç°¡å–®æ˜“æ‡‚ã€‚
        4. **æå•å¼•å°**ï¼šæ¯è¬›å®Œä¸€å€‹è§€å¿µï¼Œè«‹ç”¨å•å¥çµå°¾ï¼Œç¢ºèªå­¸ç”Ÿæ‡‚äº†æ‰ç¹¼çºŒã€‚
        æ³¨æ„ï¼šå¦‚æœä½¿ç”¨è€…å‚³é€äº†åœ–ç‰‡ï¼Œé‚£æ˜¯ Scratch ç•«é¢çš„ã€Œæ”¾å¤§è£åˆ‡ã€æˆªåœ–ï¼Œè«‹å°ˆæ³¨æ–¼æª¢æŸ¥ç¨‹å¼é‚è¼¯æ˜¯å¦ç¬¦åˆè·³è·³è²“ä»»å‹™(ç©ºç™½éµ->Y+100->ç­‰å¾…->Y-100)ã€‚
        `;

        let state = {
            stress: 0, faceScore: 0, mouseScore: 0, keyScore: 0,
            isInterventionActive: false,
            clickCount: 0, keyPressCount: 0, mousePositions: [],
            dominantStressor: '',
            empathyChatHistory: [], 
            taChatHistory: []       
        };

        // ==========================================
        // 0. é–‹å ´å‹•ç•«é‚è¼¯ (æ©«å‘å·è»¸)
        // ==========================================
        window.onload = function() {
            const scroll = document.getElementById('scroll-container');
            const overlay = document.getElementById('mission-overlay');
            
            // 1. å±•é–‹å·è»¸ (Width Animation)
            setTimeout(() => {
                scroll.classList.add('open');
            }, 300);

            // 2. å•Ÿå‹•ç³»çµ± (èƒŒæ™¯)
            initSystem();

            // 3. 5ç§’å¾Œæ”¶èµ·ä¸¦é£›å¾€å·¦ä¸Šè§’
            setTimeout(() => {
                overlay.style.background = 'rgba(0,0,0,0)';
                overlay.style.pointerEvents = 'none'; 
                
                scroll.classList.remove('open');
                scroll.classList.add('minimized');
                
            }, 5500); 
        };

        // ==========================================
        // 1. è¡Œç‚ºåµæ¸¬
        // ==========================================
        document.addEventListener('mousemove', (e) => {
            const now = Date.now();
            state.mousePositions.push({x: e.clientX, y: e.clientY, t: now});
            state.mousePositions = state.mousePositions.filter(p => now - p.t < 1000);
            if(state.mousePositions.length > 5) {
                let dist = 0;
                for(let i=1; i<state.mousePositions.length; i++) {
                    const p1 = state.mousePositions[i-1];
                    const p2 = state.mousePositions[i];
                    dist += Math.sqrt(Math.pow(p2.x-p1.x, 2) + Math.pow(p2.y-p1.y, 2));
                }
                if(dist > 2000) state.mouseScore = Math.min(100, state.mouseScore + 10);
            }
        });
        document.addEventListener('mousedown', () => { state.clickCount++; });
        document.addEventListener('keydown', () => { state.keyPressCount++; });

        setInterval(() => {
            if(state.clickCount > 3) state.mouseScore = Math.min(100, state.mouseScore + 20);
            else state.mouseScore = Math.max(0, state.mouseScore - 5);

            if(state.keyPressCount > 5) state.keyScore = Math.min(100, state.keyScore + 20);
            else state.keyScore = Math.max(0, state.keyScore - 5);

            state.clickCount = 0; state.keyPressCount = 0;
            updateMetricColor('score-mouse', state.mouseScore);
            updateMetricColor('score-key', state.keyScore);
        }, 1000);

        function updateMetricColor(id, score) {
            const el = document.getElementById(id);
            el.innerText = score + "%";
            if(score > 50) el.classList.add('high-stress'); else el.classList.remove('high-stress');
        }

        // ==========================================
        // 2. åˆå§‹åŒ–èˆ‡ç›¸æ©Ÿ
        // ==========================================
        async function initSystem() {
            const video = document.getElementById('video');
            const errorMsg = document.getElementById('cam-error');
            const emoVal = document.getElementById('emo-val');

            try {
                errorMsg.style.display = 'none';
                emoVal.innerText = "æ­£åœ¨å‘¼å«ç›¸æ©Ÿ...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.onloadedmetadata = () => { video.play(); };

                emoVal.innerText = "æº–å‚™ä¸­...";
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                emoVal.innerText = "åµæ¸¬ä¸­...";
                startStressLoop();

            } catch(e) {
                console.error(e);
                errorMsg.style.display = 'block';
                emoVal.innerText = "ç„¡æ³•é–‹å•Ÿ";
            }
        }

        function startStressLoop() {
            const video = document.getElementById('video');
            const emoVal = document.getElementById('emo-val');
            
            setInterval(async () => {
                if(video.paused || video.ended || state.isInterventionActive) return;

                const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
                const dets = await faceapi.detectAllFaces(video, options).withFaceExpressions();
                
                if(dets.length > 0) {
                    const exps = dets[0].expressions;
                    const top = Object.keys(exps).reduce((a,b)=>exps[a]>exps[b]?a:b);
                    const map = {neutral:"å¹³éœ ğŸ™‚", happy:"é–‹å¿ƒ ğŸ˜„", sad:"é›£é ğŸ˜¢", angry:"ç”Ÿæ°£ ğŸ˜ ", fearful:"å®³æ€• ğŸ˜¨", disgusted:"è¨å­ ğŸ˜–", surprised:"é©šè¨ ğŸ˜²"};
                    emoVal.innerText = map[top] || top;
                    emoVal.style.color = "#fff";

                    if(['sad', 'angry', 'fearful', 'disgusted'].includes(top)) state.faceScore = Math.min(100, state.faceScore + 10); 
                    else if(top === 'happy') state.faceScore = Math.max(0, state.faceScore - 10); 
                    else state.faceScore = Math.max(0, state.faceScore - 2); 
                } else {
                    emoVal.innerText = "æ‰¾ä¸åˆ°è‡‰ ğŸ‘€";
                    emoVal.style.color = "#FFD54F";
                }
                
                updateMetricColor('score-face', state.faceScore);

                if (state.faceScore >= state.mouseScore && state.faceScore >= state.keyScore) state.dominantStressor = 'FACE';
                else if (state.mouseScore >= state.keyScore) state.dominantStressor = 'MOUSE';
                else state.dominantStressor = 'KEY';

                state.stress = Math.max(state.faceScore, state.mouseScore, state.keyScore);
                document.getElementById('stress-val').innerText = state.stress + "%";
                const bar = document.getElementById('stress-bar');
                bar.style.width = state.stress + "%";
                
                if(state.stress < 50) document.getElementById('stress-bar').style.background = "#4C97FF";
                else if(state.stress < 80) document.getElementById('stress-bar').style.background = "#FFAB19";
                else document.getElementById('stress-bar').style.background = "#FF6B6B";

                if(state.stress > 80) triggerEmpathyAI(state.dominantStressor);

            }, 1000);
        }

        // ==========================================
        // 4. æš–å¿ƒ AI
        // ==========================================
        function triggerEmpathyAI(reason) {
            state.isInterventionActive = true;
            state.faceScore = 50; state.mouseScore = 0; state.keyScore = 0;
            state.empathyChatHistory = [];
            
            const chatBox = document.getElementById('empathy-chat');
            chatBox.innerHTML = ''; 

            let openingMsg = "";
            if (reason === 'FACE') openingMsg = "ä½ çœ‹èµ·ä¾†æœ‰é»å›°æ“¾ï¼Œæ˜¯ä¸æ˜¯ç¨‹å¼å¡é—œäº†ï¼Ÿ";
            else if (reason === 'MOUSE') openingMsg = "æˆ‘ç™¼ç¾ä½ çš„æ»‘é¼ ç§»å‹•å¾—æœ‰é»æ€¥ï¼Œæ˜¯ä¸æ˜¯å¿ƒè£¡æœ‰é»è‘—æ€¥ï¼Ÿ";
            else if (reason === 'KEY') openingMsg = "æ•²éµç›¤çš„åŠ›é“æœ‰é»å¤§å–”ï¼Œæ‰‹æœƒç— çš„ã€‚";
            else openingMsg = "æ„Ÿè¦ºä½ ç¾åœ¨å£“åŠ›æœ‰é»å¤§ï¼Œæˆ‘å€‘å…ˆä¼‘æ¯ä¸€ä¸‹ã€‚";

            openingMsg += "<br>è·Ÿæˆ‘èªªèªªçœ‹ï¼Œç™¼ç”Ÿä»€éº¼äº‹äº†å—ï¼Ÿï¼ˆä½ å¯ä»¥æ‰“å­—è·Ÿæˆ‘èŠå¤©ï¼‰";
            
            addEmpathyMsg('warm', openingMsg);
            document.getElementById('empathy-modal').style.display = 'flex';
        }

        function addEmpathyMsg(type, text) {
            const box = document.getElementById('empathy-chat');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            
            state.empathyChatHistory.push({
                role: type === 'warm' ? 'model' : 'user',
                parts: [{ text: text }]
            });
        }

        async function sendEmpathyChat() {
            const input = document.getElementById('emp-input');
            const val = input.value.trim();
            if(!val) return;
            
            addEmpathyMsg('user', val);
            input.value = "";

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            const prompt = `
            ä½ æ˜¯ä¸€å€‹ã€Œæš–å¿ƒå¤¥ä¼´ã€ã€‚ä½¿ç”¨è€…æ˜¯å°å­¸é«˜å¹´ç´šå­¸ç”Ÿï¼Œç›®å‰å­¸ç¿’ç¨‹å¼é‡åˆ°æŒ«æŠ˜ï¼Œå£“åŠ›å¾ˆå¤§ã€‚
            ä½ çš„ä»»å‹™æ˜¯ï¼š
            1. **å°ˆæ³¨æ–¼åŒç†èˆ‡å‚¾è½**ï¼šä¸è¦æ€¥è‘—çµ¦ç¨‹å¼å»ºè­°ï¼Œå…ˆè½ä»–ç™¼ç‰¢é¨·ã€‚
            2. **èªæ°£**ï¼šåƒæœ‹å‹ä¸€æ¨£æº«æŸ”ï¼Œä¸ç”¨ç–Šå­—ï¼Œé©é‡ emojiã€‚
            3. **ç›®æ¨™**ï¼šå¼•å°ä»–å†·éœä¸‹ä¾†ï¼Œæœ€å¾Œé¼“å‹µä»–ã€Œå¦‚æœæº–å‚™å¥½äº†ï¼Œå¯ä»¥æŒ‰ä¸‹é¢çš„æŒ‰éˆ•è«‹ç©æœ¨å¤§å¸«å¹«å¿™ã€ã€‚
            `;

            const payload = {
                contents: [
                    { role: 'user', parts: [{ text: prompt }] },
                    ...state.empathyChatHistory
                ]
            };

            try {
                const res = await fetch(url, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                addEmpathyMsg('warm', marked.parse(reply));
            } catch(e) {
                addEmpathyMsg('warm', "ç¶²è·¯æœ‰é»å¡å¡çš„ï¼Œä½†æˆ‘é‚„æ˜¯åœ¨é€™è£¡é™ªä½ å–”ã€‚");
            }
        }

        function closeEmpathy() {
            document.getElementById('empathy-modal').style.display = 'none';
            setTimeout(() => { state.isInterventionActive = false; }, 5000);
        }

        function handoverToTA() {
            document.getElementById('empathy-modal').style.display = 'none';
            const taBox = document.getElementById('ta-chat');
            taBox.innerHTML += `<div class="msg system">âœ¨ æš–å¿ƒå¤¥ä¼´å·²é€šçŸ¥ç©æœ¨å¤§å¸«...</div>`;
            captureAndAnalyze('TA_STRESSED_' + state.dominantStressor);
            setTimeout(() => { state.isInterventionActive = false; }, 5000);
        }

        // ==========================================
        // â˜…â˜…â˜… ç©æœ¨å¤§å¸« AI é‚è¼¯ â˜…â˜…â˜…
        // ==========================================

        async function sendToGeminiTA() {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            const taBox = document.getElementById('ta-chat');

            try {
                const res = await fetch(url, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: state.taChatHistory })
                });
                const data = await res.json();
                
                if(data.error) {
                    console.error("API Error Detail:", data.error);
                    throw new Error(data.error.message);
                }

                const reply = data.candidates[0].content.parts[0].text;
                
                taBox.innerHTML += `<div class="msg ai">${marked.parse(reply)}</div>`;
                taBox.scrollTop = taBox.scrollHeight;

                state.taChatHistory.push({
                    role: 'model',
                    parts: [{ text: reply }]
                });

            } catch(e) {
                console.error("Gemini Connection Error:", e);
                taBox.innerHTML += `<div class="msg ai">é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>`;
                state.taChatHistory.pop();
            }
        }

        // --- å‚³é€æ–‡å­— ---
        async function sendTextChat() {
            const input = document.getElementById('ta-input');
            const val = input.value.trim();
            if(!val) return;
            
            const taBox = document.getElementById('ta-chat');
            taBox.innerHTML += `<div class="msg user">${val}</div>`;
            taBox.scrollTop = taBox.scrollHeight;
            input.value = "";

            let messageText = val;
            
            if (state.taChatHistory.length === 0) {
                messageText = TA_SYSTEM_PROMPT + "\n\nå­¸ç”Ÿå•ï¼š" + val;
            }

            state.taChatHistory.push({
                role: 'user',
                parts: [{ text: messageText }]
            });

            await sendToGeminiTA();
        }

        // --- å‚³é€æˆªåœ– (å«ç¸®åœ–é‚è¼¯) ---
        async function captureAndAnalyze(mode) {
            const taBox = document.getElementById('ta-chat');
            if(mode.includes('TA')) {
                taBox.innerHTML += `<div class="msg user">ğŸ“¸ å‚³é€æˆªåœ–ä¸­...</div>`;
            }

            let stream = null; 

            try {
                stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "never" }, audio: false, preferCurrentTab: true
                });
                
                const videoEl = document.getElementById('capture-video');
                videoEl.srcObject = stream;
                
                await new Promise(r => videoEl.onloadedmetadata = r);
                videoEl.play();
                await new Promise(r => setTimeout(r, 500)); 

                // --- è£åˆ‡ + ç¸®åœ–é‚è¼¯ ---
                const canvas = document.getElementById('capture-canvas');
                const w = videoEl.videoWidth;
                const h = videoEl.videoHeight;
                
                const cropX = w * 0.20; 
                const cropY = h * 0.10; 
                const cropW = w * 0.45; 
                const cropH = h * 0.80; 

                // å¼·åˆ¶ç¸®å°åˆ°å¯¬åº¦ 800px ä»¥å…§
                let finalW = cropW;
                let finalH = cropH;
                if (finalW > 800) {
                    const scale = 800 / finalW;
                    finalW = 800;
                    finalH = cropH * scale;
                }

                canvas.width = finalW;
                canvas.height = finalH;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoEl, cropX, cropY, cropW, cropH, 0, 0, finalW, finalH);
                
                const base64 = canvas.toDataURL('image/jpeg', 0.7);
                const cleanBase64 = base64.split(',')[1];

                let userPrompt = "é€™æ˜¯æˆ‘ç›®å‰çš„ç¨‹å¼ç©æœ¨ï¼Œè«‹ä¸€æ­¥ä¸€æ­¥æ•™æˆ‘ï¼Œä¸€æ¬¡åªè¬›ä¸€å€‹è§€å¿µã€‚";
                if (mode.startsWith('TA_STRESSED')) {
                    const reason = mode.split('_')[2]; 
                    userPrompt = `(æš–å¿ƒæ¨¡å¼å•Ÿå‹•ï¼šå­¸ç”Ÿå‰›å‰›å› ç‚º ${reason} æ„Ÿåˆ°æŒ«æŠ˜) è«‹éå¸¸æº«æŸ”åœ°å¹«æˆ‘çœ‹çœ‹ï¼Œä¸€æ¬¡åªæ”¹ä¸€å€‹åœ°æ–¹å°±å¥½ã€‚`;
                }

                if (state.taChatHistory.length === 0) {
                    userPrompt = TA_SYSTEM_PROMPT + "\n\n" + userPrompt;
                }

                state.taChatHistory.push({
                    role: 'user',
                    parts: [
                        { text: userPrompt },
                        { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }
                    ]
                });

                await sendToGeminiTA();

            } catch(e) {
                console.error(e);
                if(mode.includes('TA')) taBox.innerHTML += `<div class="msg ai">âš ï¸ æˆªåœ–å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚</div>`;
            } finally {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                const videoEl = document.getElementById('capture-video');
                videoEl.srcObject = null;
            }
        }
    </script>
</body>
</html>
