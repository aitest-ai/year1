<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç¬¬ä¸€å¹´ï¼šæƒ…ç·’åµæ¸¬èˆ‡ç©æœ¨ç¨‹å¼å­¸ç¿’ç³»çµ±</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/zh-hant.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* UI é¢¨æ ¼è¨­å®š */
        :root { 
            --bg-color: #f0f2f5; /* ç©æœ¨ç‰ˆæ”¹ç”¨äº®è‰²ç³»ï¼Œæ¯”è¼ƒåƒ Scratch é¢¨æ ¼ */
            --panel-bg: #ffffff; 
            --accent: #4c97ff; /* Scratch Motion Blue */
            --control: #ffbf00; /* Scratch Control Yellow */
            --events: #ffab19; 
            --text: #333; 
            --border: #ddd; 
        }
        @font-face {
            font-family: 'Iansui';
            src: url('https://cdn.jsdelivr.net/fontsource/fonts/iansui@latest/chinese-traditional-400-normal.woff2') format('woff2');
        }

        body { 
            background: var(--bg-color); 
            color: var(--text); 
            font-family: 'Iansui','Microsoft JhengHei', sans-serif; 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* å·¦å´åµæ¸¬é¢æ¿ */
        .panel-left { 
            width: 280px; 
            background: #2d3e50; /* æ·±è‰²å´é‚Šæ¬„ */
            color: white;
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .header { color: var(--accent); font-size: 1.2em; font-weight: bold; margin-bottom: 15px; }
        .cam-box { 
            width: 100%; height: 180px; background: #000; 
            border: 3px solid var(--accent); border-radius: 10px; 
            overflow: hidden; margin-bottom: 10px;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .status-box { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px; font-size: 0.9em; }
        
        .stress-bar-bg { height: 8px; background: #555; margin-top: 5px; border-radius: 4px; overflow:hidden; }
        .stress-bar { height: 100%; width: 0%; background: #ff5555; transition: width 0.5s; }

        /* å³å´ä¸»æ“ä½œå€ */
        .panel-right { flex: 1; display: flex; flex-direction: column; padding: 10px; overflow: hidden; }
        
        /* ç©æœ¨å·¥ä½œå€å®¹å™¨ */
        #blocklyDiv {
            height: 60%; 
            width: 100%; 
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* åº•éƒ¨ AI èŠå¤©å®¤ */
        #chat-panel { 
            height: 35%; 
            margin-top: 10px;
            border: 1px solid var(--border); 
            background: white; 
            border-radius: 8px;
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }
        #chat-msgs { flex: 1; overflow-y: auto; margin-bottom: 10px; font-size: 1em; background: #f9f9f9; padding:10px; border-radius:4px; }
        .msg { padding: 8px 12px; margin-bottom: 8px; border-radius: 15px; max-width: 85%; line-height: 1.4; }
        .msg.ai { color: #333; background: #e1f5fe; border-bottom-left-radius: 2px; align-self: flex-start; }
        .msg.user { color: white; background: var(--accent); border-bottom-right-radius: 2px; align-self: flex-end; margin-left: auto; }

        .btn-action { background: var(--accent); color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 20px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .btn-action:hover { background: #357abd; }

        /* æ¼¸é€²å¼å›é¥‹å½ˆçª— */
        .hint-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 9999; display: none; 
            justify-content: center; align-items: center; 
        }
        .hint-box { 
            background: white; width: 450px; padding: 30px; 
            border-radius: 15px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .cat-avatar { font-size: 50px; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

    <div id="hint-overlay" class="hint-overlay">
        <div class="hint-box">
            <span class="cat-avatar">ğŸ±</span>
            <h2 style="color:#333; margin:0 0 10px 0;">é‡åˆ°å›°é›£äº†å—ï¼Ÿ</h2>
            <p style="color:#666;">AI åµæ¸¬åˆ°æ‚¨ä¼¼ä¹æœ‰é»ç„¦æ…®ï¼Œéœ€è¦æˆ‘çœ‹çœ‹æ‚¨çš„ç©æœ¨ä¸¦çµ¦é»æç¤ºå—ï¼Ÿ</p>
            
            <div id="hint-content" style="text-align: left; background: #fff3cd; padding: 15px; margin: 15px 0; border-radius: 8px; color: #856404; font-size:0.95em;">
                (é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼ŒAI å°‡åˆ†ææ‚¨çš„ç©æœ¨...)
            </div>
            
            <div style="display: flex; justify-content: center; gap:15px;">
                <button class="btn-action" onclick="getAIHint()">ğŸ” å¹«æˆ‘çœ‹ç©æœ¨çµ¦æç¤º</button>
                <button class="btn-action" style="background:#aaa;" onclick="closeHint()">âŒ æˆ‘è‡ªå·±å†è©¦è©¦</button>
            </div>
        </div>
    </div>

    <div class="panel-left">
        <div class="header">Scratch å­¸ç¿’ç³»çµ±</div>
        <div class="cam-box"><video id="video" autoplay muted playsinline></video></div>
        
        <div class="status-box">
            <div>æƒ…ç·’: <span id="emo-val" style="color:#ffab19; font-weight:bold;">åµæ¸¬ä¸­...</span></div>
            <div style="margin-top:10px; font-size:0.8em; opacity:0.8;">ç„¦æ…®æŒ‡æ•¸ (AI è§¸ç™¼)</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-bar"></div></div>
        </div>

        <div style="margin-top:auto; font-size:0.8em; color:#ccc;">
            <p>ğŸ“‹ ä»»å‹™ç›®æ¨™ï¼š<br>ä½¿ç”¨ã€Œé‡è¤‡ã€ç©æœ¨è®“è²“å’ªèµ° 10 æ­¥ã€‚</p>
        </div>
    </div>

    <div class="panel-right">
        <div id="blocklyDiv"></div>

        <div id="chat-panel">
            <div style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px; font-weight:bold; color:#555;">
                ğŸ¤– AI æ™ºæ…§åŠ©æ•™ (Scratch å°ˆå®¶)
            </div>
            <div id="chat-msgs">
                <div class="msg ai">å—¨ï¼æˆ‘æ˜¯è²“å’ªåŠ©æ•™ã€‚è©¦è‘—å¾å·¦é‚Šæ‹–æ‹‰ç©æœ¨ï¼Œå¦‚æœå¡ä½äº†ï¼Œæˆ‘æœƒä¸»å‹•å‡ºä¾†å¹«ä½ å–”ï¼</div>
            </div>
            <div style="display:flex; gap:10px;">
                <input id="chat-input" style="flex:1; border:1px solid #ddd; padding:10px; border-radius:20px; outline:none;" placeholder="å•æˆ‘é—œæ–¼ç©æœ¨çš„å•é¡Œ..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="btn-action" style="padding: 8px 15px;" onclick="sendChat()">ç™¼é€</button>
            </div>
        </div>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="å‹•ä½œ (Motion)" colour="230">
            <block type="move_steps"></block>
            <block type="turn_right"></block>
        </category>
        <category name="æ§åˆ¶ (Control)" colour="45">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="controls_if"></block>
        </category>
        <category name="é‹ç®— (Operators)" colour="120">
            <block type="math_number"></block>
            <block type="logic_compare"></block>
        </category>
        <category name="è®Šæ•¸ (Variables)" colour="330" custom="VARIABLE"></category>
    </xml>

    <script>
        // ============================================
        // æ ¸å¿ƒé‚è¼¯
        // ============================================

        // è‡ªå®šç¾©ç©æœ¨ (æ¨¡æ“¬ Scratch çš„ Move 10 Steps)
        Blockly.Blocks['move_steps'] = {
            init: function() {
                this.appendDummyInput().appendField("ç§»å‹•").appendField(new Blockly.FieldNumber(10), "STEPS").appendField("é»");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip("è®“è§’è‰²ç§»å‹•");
            }
        };
        // å°æ‡‰çš„ Python ç”Ÿæˆä»£ç¢¼ (è®“ AI è®€æ‡‚)
        Blockly.Python['move_steps'] = function(block) {
            var number_steps = block.getFieldValue('STEPS');
            return 'sprite.move(' + number_steps + ')\n';
        };

        Blockly.Blocks['turn_right'] = {
            init: function() {
                this.appendDummyInput().appendField("å³è½‰").appendField(new Blockly.FieldNumber(15), "DEGREES").appendField("åº¦");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
            }
        };
        Blockly.Python['turn_right'] = function(block) {
            var deg = block.getFieldValue('DEGREES');
            return 'sprite.turn(' + deg + ')\n';
        };

        // åˆå§‹åŒ– Blockly
        var workspace = Blockly.inject('blocklyDiv', {
            media: 'https://unpkg.com/blockly/media/',
            toolbox: document.getElementById('toolbox'),
            zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 },
            trashcan: true
        });

        // GAS API (ç”¨æ–¼ AI å°è©±) - è«‹æ›¿æ›ç‚ºæ‚¨çš„ GAS URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzkAH1B96FAMUhSf-n6ET5x8h8BXtXpxgIApmQraqk39rIZOhgUuOi94zmy1AuZMXAqXg/exec";

        let isFaceLoaded = false;
        let stressLevel = 0;
        let hintLevel = 0; // 0=ç„¡, 1=æŠ½è±¡æç¤º, 2=å…·é«”ç©æœ¨æç¤º

        async function init() {
            // åˆå§‹åŒ– Face API
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
                isFaceLoaded = true;
                startVideo();
            } catch(e) { console.log("FaceAPI Error", e); }
        }

        async function startVideo() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            const videoEl = document.getElementById('video');
            videoEl.srcObject = stream;
            videoEl.addEventListener('play', () => {
                setInterval(detectEmotion, 1500); // ç¨å¾®æ”¾æ…¢åµæ¸¬é »ç‡
            });
        }

        async function detectEmotion() {
            if(!isFaceLoaded) return;
            const videoEl = document.getElementById('video');
            const detections = await faceapi.detectAllFaces(videoEl, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
            
            if(detections.length > 0) {
                const expressions = detections[0].expressions;
                const topEmo = Object.keys(expressions).reduce((a, b) => expressions[a] > expressions[b] ? a : b);
                
                // ç¿»è­¯æƒ…ç·’
                const emoMap = { neutral:"å¹³éœ", happy:"é–‹å¿ƒ", sad:"æ²®å–ª", angry:"ç”Ÿæ°£", fearful:"ç„¦æ…®", disgusted:"å­æƒ¡", surprised:"é©šè¨" };
                document.getElementById('emo-val').innerText = emoMap[topEmo] || topEmo;

                // å£“åŠ›é‚è¼¯
                if(['sad', 'angry', 'fearful', 'disgusted'].includes(topEmo)) {
                    stressLevel += 15; // ç´¯ç©è¼ƒå¿«
                } else {
                    stressLevel = Math.max(0, stressLevel - 5);
                }
                
                updateStressBar();
            }
        }

        function updateStressBar() {
            const bar = document.getElementById('stress-bar');
            bar.style.width = Math.min(100, stressLevel) + "%";
            
            // è§¸ç™¼é–¾å€¼
            if(stressLevel >= 80) {
                stressLevel = 0; // é‡ç½®
                showHintOverlay();
            }
        }

        function showHintOverlay() {
            document.getElementById('hint-overlay').style.display = 'flex';
            document.getElementById('hint-content').innerText = "(AI æº–å‚™è®€å–æ‚¨çš„ç©æœ¨çµæ§‹...)";
        }

        function closeHint() {
            document.getElementById('hint-overlay').style.display = 'none';
        }

        // é—œéµåŠŸèƒ½ï¼šè®“ AI çœ‹ç©æœ¨ä¸¦çµ¦æç¤º
        async function getAIHint() {
            const hintBox = document.getElementById('hint-content');
            hintBox.innerText = "ğŸ¤– æ­£åœ¨åˆ†æç©æœ¨é‚è¼¯...";
            
            // 1. å°‡ç©æœ¨è½‰æˆ Python ä»£ç¢¼ (é€™æ˜¯ç‚ºäº†è®“ AI è®€æ‡‚é‚è¼¯ï¼Œä¸æ˜¯çµ¦å­¸ç”Ÿçœ‹)
            const codeLogic = Blockly.Python.workspaceToCode(workspace);
            console.log("Generated Logic:", codeLogic);

            // 2. æ§‹å»º Prompt
            const prompt = `
            ä½ æ˜¯ä¸€å€‹ Scratch ç¨‹å¼è¨­è¨ˆè€å¸«ã€‚
            ç¾åœ¨å­¸ç”Ÿæ­£åœ¨å˜—è©¦è§£æ±ºé€™å€‹ä»»å‹™ï¼š[è®“è²“å’ªé‡è¤‡ç§»å‹• 10 æ¬¡]ã€‚
            
            ç›®å‰å­¸ç”Ÿå¯«å‡ºçš„ç©æœ¨é‚è¼¯ä»£ç¢¼å¦‚ä¸‹ï¼š
            \`\`\`python
            ${codeLogic || "ç›®å‰å·¥ä½œå€æ˜¯ç©ºçš„"}
            \`\`\`
            
            è«‹æ ¹æ“šå­¸ç”Ÿçš„ç¾ç‹€ï¼Œçµ¦äºˆä¸€å€‹ã€Œæ¼¸é€²å¼ã€çš„æç¤ºã€‚
            è¦å‰‡ï¼š
            1. ä¸è¦ç›´æ¥çµ¦ç¨‹å¼ç¢¼ã€‚
            2. è«‹ç”¨ã€Œç©æœ¨ã€çš„èªè¨€ï¼ˆä¾‹å¦‚ï¼šé»ƒè‰²çš„æ§åˆ¶ç©æœ¨ã€è—è‰²çš„å‹•ä½œç©æœ¨ï¼‰ã€‚
            3. å¦‚æœå·¥ä½œå€æ˜¯ç©ºçš„ï¼Œå»ºè­°ä»–å…ˆæ‰¾ä»€éº¼é¡è‰²çš„ç©æœ¨ã€‚
            4. å›ç­”è¦ç°¡çŸ­æº«æŸ”ï¼Œç¹é«”ä¸­æ–‡ã€‚
            `;

            // 3. å‘¼å« AI
            try {
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        type: 'CALL_GEMINI',
                        prompt: prompt
                    })
                });
                
                // æ¨¡æ“¬ AI å›æ‡‰ (å› ç‚º no-cors æ‹¿ä¸åˆ°å³æ™‚å›æ‡‰ï¼Œé€™è£¡ç”¨ setTimeout æ¨¡æ“¬å»¶é²æ•ˆæœ)
                // å¯¦éš›ä¸²æ¥æ™‚ï¼Œæ‚¨éœ€è¦å¾Œç«¯æ”¯æ´ CORS å›å‚³ï¼Œæˆ–ä½¿ç”¨ Firebase ç›£è½å›æ‡‰
                setTimeout(() => {
                    // é€™è£¡æ˜¯ä¸€å€‹æ¨¡æ“¬çš„æ™ºæ…§å›æ‡‰ï¼Œå¯¦éš›ä¸Šæœƒä¾†è‡ª GAS
                    let mockResponse = "";
                    if(!codeLogic) {
                        mockResponse = "æˆ‘çœ‹ä½ çš„å·¥ä½œå€é‚„æ˜¯ç©ºçš„ã€‚è¦ä¸è¦è©¦è©¦çœ‹å»ã€Œæ§åˆ¶ã€åˆ†é¡ï¼ˆé»ƒè‰²ï¼‰ï¼Œæ‰¾æ‰¾çœ‹æœ‰æ²’æœ‰ã€Œé‡è¤‡ã€çš„ç©æœ¨ï¼Ÿ";
                    } else if (codeLogic.includes("move") && !codeLogic.includes("for")) {
                        mockResponse = "ä½ å·²ç¶“æœ‰ç§»å‹•ç©æœ¨äº†ï¼Œå¾ˆæ£’ï¼ä½†æ˜¯é€™æ¨£åªæœƒå‹•ä¸€æ¬¡ã€‚è©¦è‘—ç”¨é»ƒè‰²çš„ã€Œé‡è¤‡ç„¡é™æ¬¡ã€æˆ–ã€Œé‡è¤‡10æ¬¡ã€ç©æœ¨æŠŠç§»å‹•åŒ…èµ·ä¾†çœ‹çœ‹ï¼Ÿ";
                    } else {
                        mockResponse = "çœ‹èµ·ä¾†çµæ§‹å¾ˆä¸éŒ¯å–”ï¼è©¦è‘—æŒ‰åŸ·è¡Œçœ‹çœ‹ï¼Œå¦‚æœä¸å°ï¼Œæª¢æŸ¥ä¸€ä¸‹ç§»å‹•çš„æ­¥æ•¸æ˜¯å¦å¤ªå°ï¼Ÿ";
                    }
                    
                    hintBox.innerHTML = `<strong>ğŸ’¡ AI å»ºè­°ï¼š</strong><br>${mockResponse}`;
                    addMsg('ai', `[ä¸»å‹•æç¤º] ${mockResponse}`);
                }, 2000);

            } catch(e) {
                hintBox.innerText = "é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            }
        }

        // ä¸€èˆ¬èŠå¤©
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if(!msg) return;
            
            addMsg('user', msg);
            input.value = "";
            
            // é€™è£¡åŒæ¨£å¯ä»¥æŠŠç›®å‰çš„ç©æœ¨ç‹€æ…‹å‚³çµ¦ AI
            const currentCode = Blockly.Python.workspaceToCode(workspace);
            
            // æ¨¡æ“¬ AI å›æ‡‰
            setTimeout(() => {
                addMsg('ai', `æ”¶åˆ°ï¼é—œæ–¼ã€Œ${msg}ã€ï¼Œä½ å¯ä»¥åƒè€ƒä¸Šé¢çš„ç©æœ¨å·¥å…·ç®±... (AI æ€è€ƒä¸­)`);
            }, 1000);
        }

        function addMsg(role, text) {
            const box = document.getElementById('chat-msgs');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = marked.parse(text);
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        init();
    </script>
</body>
</html>
