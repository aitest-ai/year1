<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Scratch è¦–è¦ºåŒ– AI è¼”å°ç³»çµ± (æˆªåœ–ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/msg/zh-hant.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* ä»¿ Scratch 3.0 ä»‹é¢é…è‰² */
        :root {
            --scratch-ui: #E9F1FC;
            --scratch-header: #4D97FF;
            --block-motion: #4C97FF;
            --block-control: #FFAB19;
            --block-events: #FFBF00;
        }

        body { margin: 0; height: 100vh; display: flex; font-family: sans-serif; background: var(--scratch-ui); overflow: hidden; }

        /* å·¦å´ï¼šç›£æ§å€ */
        .sidebar { width: 250px; background: white; border-right: 1px solid #ddd; padding: 10px; display: flex; flex-direction: column; }
        .cam-container { width: 100%; height: 180px; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px; border: 3px solid #ddd; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .status-box { padding: 10px; background: #f9f9f9; border-radius: 5px; font-size: 0.9em; }
        .stress-bar-bg { height: 8px; background: #eee; border-radius: 4px; margin-top: 5px; overflow: hidden; }
        .stress-bar { height: 100%; width: 0%; background: #FF5555; transition: width 0.5s; }

        /* ä¸­é–“ï¼šç©æœ¨å€ */
        .workspace { flex: 1; position: relative; }
        #blocklyDiv { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }

        /* å³å´ï¼šAI åŠ©æ‰‹å€ */
        .assistant-panel { width: 350px; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .chat-header { background: var(--scratch-header); color: white; padding: 10px; font-weight: bold; }
        .chat-body { flex: 1; padding: 10px; overflow-y: auto; background: #fcfcfc; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 90%; font-size: 0.9em; line-height: 1.4; }
        .msg.ai { background: #E6F7FF; border: 1px solid #B3E0FF; align-self: flex-start; }
        .msg.user { background: #4C97FF; color: white; align-self: flex-end; margin-left: auto; }
        
        /* æˆªåœ–é è¦½ (é™¤éŒ¯ç”¨ï¼Œå¯éš±è—) */
        .screenshot-preview { margin-top: 10px; border: 1px dashed #ccc; padding: 5px; text-align: center; }
        #preview-img { max-width: 100%; max-height: 150px; display: none; border: 1px solid #eee; }

        /* æ§åˆ¶æŒ‰éˆ• */
        .action-btn { 
            margin: 10px; padding: 10px; border: none; border-radius: 20px; 
            background: var(--block-control); color: white; font-weight: bold; cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }
        .action-btn:hover { opacity: 0.9; }
        .loading { opacity: 0.6; pointer-events: none; }

        /* å½ˆçª— */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal { background: white; width: 400px; padding: 20px; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>

    <div id="alert-overlay" class="overlay">
        <div class="modal">
            <h2 style="color: #FFAB19;">ğŸ± éœ€è¦å¹«å¿™å—ï¼Ÿ</h2>
            <p>åµæ¸¬åˆ°æ‚¨ä¼¼ä¹æœ‰é»å›°æƒ‘ã€‚AI å¯ä»¥å¹«æ‚¨ã€Œçœ‹ã€ä¸€ä¸‹ç¾åœ¨çš„ç©æœ¨ï¼Œä¸¦çµ¦å‡ºå»ºè­°å–”ï¼</p>
            <button class="action-btn" onclick="captureAndAnalyze('auto')">ğŸ“¸ æˆªåœ–ä¸¦åˆ†æ</button>
            <button class="action-btn" style="background:#ccc;" onclick="document.getElementById('alert-overlay').style.display='none'">æˆ‘è‡ªå·±è©¦è©¦</button>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="color: #4C97FF; margin: 0 0 10px 0;">Scratch å­¸ç¿’ç³»çµ±</h3>
        <div class="cam-container"><video id="video" autoplay muted playsinline></video></div>
        
        <div class="status-box">
            <div>æƒ…ç·’ç‹€æ…‹: <span id="emo-val" style="font-weight:bold; color:#FFAB19;">...</span></div>
            <div style="margin-top:5px;">ç„¦æ…®æŒ‡æ•¸:</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-bar"></div></div>
        </div>

        <div class="screenshot-preview">
            <small>AI è¦–é‡ (æˆªåœ–é è¦½)</small>
            <img id="preview-img" alt="ç©æœ¨æˆªåœ–">
        </div>
    </div>

    <div class="workspace">
        <div id="blocklyDiv"></div>
    </div>

    <div class="assistant-panel">
        <div class="chat-header">ğŸ¤– AI è¦–è¦ºåŠ©æ•™ (Gemini Vision)</div>
        <div class="chat-body" id="chat-box">
            <div class="msg ai">å—¨ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ•™ã€‚æˆ‘å¯ä»¥ç›´æ¥ã€Œçœ‹ã€ä½ çš„ç©æœ¨åœ–ç‰‡å–”ï¼åªè¦æŒ‰ä¸‹åˆ†ææŒ‰éˆ•ï¼Œæˆ‘å°±æœƒå¹«ä½ æª¢æŸ¥ã€‚</div>
        </div>
        <button id="analyze-btn" class="action-btn" onclick="captureAndAnalyze('manual')">ğŸ“¸ å‚³é€ç©æœ¨æˆªåœ–çµ¦ AI</button>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="å‹•ä½œ" colour="#4C97FF">
            <block type="move_steps"></block>
            <block type="turn_right"></block>
        </category>
        <category name="æ§åˆ¶" colour="#FFAB19">
            <block type="controls_repeat_ext">
                <value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
            </block>
            <block type="controls_if"></block>
        </category>
        <category name="äº‹ä»¶" colour="#FFBF00">
            <block type="event_flag"></block>
        </category>
        <category name="é‹ç®—" colour="#59C059">
            <block type="math_number"></block>
        </category>
    </xml>

    <script>
        // ==========================================
        // 1. è¨­å®šè‡ªå®šç¾©ç©æœ¨ (æ¨¡æ“¬ Scratch å¤–è§€)
        // ==========================================
        Blockly.Blocks['event_flag'] = {
            init: function() {
                this.jsonInit({ "message0": "ç•¶ ğŸ è¢«é»æ“Š", "nextStatement": null, "colour": "#FFBF00" });
            }
        };
        Blockly.Blocks['move_steps'] = {
            init: function() {
                this.jsonInit({ "message0": "ç§»å‹• %1 é»", "args0": [{"type": "field_number", "name": "STEPS", "value": 10}], "previousStatement": null, "nextStatement": null, "colour": "#4C97FF" });
            }
        };
        Blockly.Blocks['turn_right'] = {
            init: function() {
                this.jsonInit({ "message0": "å³è½‰ â†» %1 åº¦", "args0": [{"type": "field_number", "name": "DEG", "value": 15}], "previousStatement": null, "nextStatement": null, "colour": "#4C97FF" });
            }
        };

        // åˆå§‹åŒ– Blockly (é–‹å•Ÿ Scratch 3.0 é¢¨æ ¼)
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            renderer: 'zelos', // â˜… é—œéµï¼šé€™è®“ç©æœ¨çœ‹èµ·ä¾†åƒ Scratch
            zoom: { startScale: 0.9 },
            grid: { spacing: 20, length: 3, colour: '#ddd', snap: true }
        });

        // ==========================================
        // 2. æ ¸å¿ƒåŠŸèƒ½ï¼šæˆªåœ–ä¸¦å‚³é€çµ¦ AI
        // ==========================================
        
        // â˜… è«‹å¡«å…¥æ‚¨çš„ API Key (å¿…é ˆæœ‰ Gemini 1.5 Flash æ¬Šé™) â˜…
        const API_KEY = "AIzaSyBXZ7enyD8BdWbuE7lR8V_Akj1KFKucYl0"; 

        async function captureAndAnalyze(source) {
            const btn = document.getElementById('analyze-btn');
            btn.innerText = "ğŸ“¸ æˆªåœ–ä¸­...";
            btn.classList.add('loading');

            if(source === 'auto') document.getElementById('alert-overlay').style.display = 'none';

            try {
                // æ­¥é©Ÿ A: å°‡ç©æœ¨å€è½‰æ›ç‚ºåœ–ç‰‡ (Base64)
                // Blockly å…§å»ºå°‡ Workspace è½‰ SVGï¼Œæˆ‘å€‘å†è½‰ Canvas
                const imageBase64 = await workspaceToPngBase64(workspace);
                
                // é¡¯ç¤ºé è¦½åœ– (é™¤éŒ¯ç”¨)
                document.getElementById('preview-img').src = imageBase64;
                document.getElementById('preview-img').style.display = 'block';

                addMsg('user', 'ğŸ“¸ (å·²å‚³é€ç©æœ¨æˆªåœ–)');
                btn.innerText = "ğŸ¤– AI åˆ†æä¸­...";

                // æ­¥é©Ÿ B: å‘¼å« Gemini Vision API
                await callGeminiVision(imageBase64);

            } catch (e) {
                console.error(e);
                addMsg('ai', 'ç³»çµ±éŒ¯èª¤ï¼šæˆªåœ–æˆ–é€£ç·šå¤±æ•—ã€‚');
            } finally {
                btn.innerText = "ğŸ“¸ å‚³é€ç©æœ¨æˆªåœ–çµ¦ AI";
                btn.classList.remove('loading');
            }
        }

        // â˜… æŠ€è¡“æ ¸å¿ƒï¼šSVG è½‰ PNG Base64 â˜…
        function workspaceToPngBase64(ws) {
            return new Promise((resolve, reject) => {
                try {
                    // 1. å–å¾— SVG æ•¸æ“š
                    // ç‚ºäº†ç¾è§€ï¼Œæˆ‘å€‘ç¨å¾®èª¿æ•´ padding
                    const metrics = ws.getMetrics();
                    const width = metrics.viewWidth;
                    const height = metrics.viewHeight;
                    
                    // é€™æ˜¯ Blockly å…§å»ºçš„ SVG åŒ¯å‡ºæ–¹å¼ï¼Œæ¯”è¼ƒ hacky ä½†æœ‰æ•ˆ
                    const svg = ws.getParentSvg().cloneNode(true);
                    svg.removeAttribute('width');
                    svg.removeAttribute('height');
                    svg.removeAttribute('transform');
                    
                    // è™•ç† CSS æ¨£å¼ (Blockly çš„æ¨£å¼æ˜¯å¤–éƒ¨çš„ï¼Œæˆªåœ–éœ€è¦å…§è¯)
                    const style = document.createElement('style');
                    style.innerHTML = `.blocklyPath { fill: none; stroke-width: 1px; } .blocklyText { font-family: sans-serif; font-size: 11pt; fill: #fff; }`; // ç°¡å–®è£œä¸€äº›æ¨£å¼
                    svg.insertBefore(style, svg.firstChild);

                    const xml = new XMLSerializer().serializeToString(svg);
                    const svg64 = btoa(unescape(encodeURIComponent(xml)));
                    const image64 = 'data:image/svg+xml;base64,' + svg64;

                    // 2. ç¹ªè£½åˆ° Canvas
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        // å¡«æ»¿ç™½è‰²èƒŒæ™¯ (ä¸ç„¶æ˜¯é€æ˜çš„)
                        ctx.fillStyle = "#ffffff";
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL("image/png"));
                    };
                    img.onerror = reject;
                    img.src = image64;

                } catch (e) {
                    reject(e);
                }
            });
        }

        // æ­¥é©Ÿ C: å‘¼å« Gemini API
        async function callGeminiVision(base64Image) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            
            // å»æ‰ data:image/png;base64, å‰ç¶´
            const cleanBase64 = base64Image.split(',')[1];

            const prompt = `
            ä½ æ˜¯ä¸€å€‹ Scratch ç¨‹å¼è¨­è¨ˆè€å¸«ã€‚
            è«‹çœ‹é€™å¼µç©æœ¨æˆªåœ–ã€‚
            1. è«‹è§£é‡‹é€™æ®µç©æœ¨çš„é‚è¼¯åœ¨åšä»€éº¼ï¼Ÿ
            2. å¦‚æœç©æœ¨çœ‹èµ·ä¾†æ²’å•é¡Œï¼Œè«‹ç¨±è®šå­¸ç”Ÿã€‚
            3. å¦‚æœç©æœ¨æœ‰æ˜é¡¯é‚è¼¯éŒ¯èª¤ï¼ˆä¾‹å¦‚åªæœ‰ç§»å‹•æ²’æœ‰è¿´åœˆï¼Œæˆ–è€…æ²’æœ‰äº‹ä»¶ç©æœ¨ï¼‰ï¼Œè«‹çµ¦äºˆå¼•å°æç¤ºã€‚
            è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£è¦ªåˆ‡ã€‚
            `;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/png", data: cleanBase64 } }
                    ]
                }]
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            if(data.candidates && data.candidates[0].content) {
                const reply = data.candidates[0].content.parts[0].text;
                addMsg('ai', reply);
            } else {
                addMsg('ai', "AI ç„¡æ³•è¾¨è­˜åœ–ç‰‡ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }

        function addMsg(role, text) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = marked.parse(text);
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // ==========================================
        // 3. æƒ…ç·’åµæ¸¬ (Face API)
        // ==========================================
        let stress = 0;
        async function initMonitor() {
            const URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(URL);

            const video = document.getElementById('video');
            navigator.mediaDevices.getUserMedia({ video: {} }).then(s => video.srcObject = s);

            setInterval(async () => {
                const dets = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                if(dets.length) {
                    const exps = dets[0].expressions;
                    const top = Object.keys(exps).reduce((a,b)=>exps[a]>exps[b]?a:b);
                    
                    document.getElementById('emo-val').innerText = top;

                    if(['sad','angry','fearful'].includes(top)) stress += 15;
                    else stress = Math.max(0, stress - 2);

                    document.getElementById('stress-bar').style.width = Math.min(100, stress) + "%";

                    if(stress > 90) { // å£“åŠ›éå¤§
                        stress = 0;
                        document.getElementById('alert-overlay').style.display = 'flex';
                    }
                }
            }, 1000);
        }

        initMonitor();

    </script>
</body>
</html>
