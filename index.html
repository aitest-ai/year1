<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æƒ…ç·’åµæ¸¬å­¸ç¿’ç³»çµ±</title>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* =========================================
           1. å…¨å±€åŸºç¤è¨­å®š
           ========================================= */
        :root { 
            --bg-color: #050505; 
            --panel-bg: #101010; 
            --accent: #00ff9d; 
            --accent-dim: #005533; 
            --danger: #ff3333; 
            --warning: #ffcc00; 
            --text: #e0e0e0; 
            --border: #333; 
        }
        @font-face {
            font-family: 'Iansui';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src:
                url('https://cdn.jsdelivr.net/fontsource/fonts/iansui@latest/chinese-traditional-400-normal.woff2') format('woff2'),
                url('https://cdn.jsdelivr.net/fontsource/fonts/iansui@latest/chinese-traditional-400-normal.woff') format('woff');
        }

        body { 
            background: var(--bg-color); 
            color: var(--text); 
            font-family: 'Iansui','Microsoft JhengHei', sans-serif; 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* =========================================
           2. å·¦å´é¢æ¿ (ç›£æ¸¬å€)
           ========================================= */
        .panel-left { 
            width: 320px; 
            min-width: 320px; 
            background: var(--panel-bg); 
            border-right: 1px solid var(--border); 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            box-sizing: border-box; 
        }
        .header {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cam-box { 
            flex: 0 0 200px; 
            background: #000; 
            border: 2px solid var(--accent); 
            border-radius: 6px; 
            overflow: hidden; 
            position: relative; 
            margin-bottom: 10px; 
        }
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); 
        }
        .status-box { 
            flex: 0 0 auto; 
            background: #1a1a1a; 
            padding: 10px; 
            margin-bottom: 10px; 
            border-radius: 6px; 
            border: 1px solid #333; 
            font-size: 0.9em; 
        }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .val { font-weight: bold; color: var(--accent); }
        .stress-bar-bg { height: 6px; background: #333; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .stress-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.5s; }
        .log-header { flex: 0 0 auto; font-size: 0.8em; color: #666; margin-bottom: 5px; }
        
        /* æ—¥èªŒå€å¡Šæ¨£å¼èª¿æ•´ */
        #log-box { 
            flex: 1 1 auto; 
            background: #000; 
            padding: 8px; 
            font-family: monospace; 
            font-size: 0.75em; 
            color: #888; 
            overflow-y: auto; 
            border: 1px solid #333; 
            line-height: 1.4;
        }
        .log-entry { 
            margin-bottom: 4px; 
            border-bottom: 1px solid #222; 
            padding-bottom: 2px; 
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn { from { opacity:0; transform: translateY(-5px); } to { opacity:1; transform: translateY(0); } }

        /* =========================================
           3. å³å´é¢æ¿ (æ“ä½œå€)
           ========================================= */
        .panel-right { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 15px; flex: 0 0 auto; overflow-x: auto; }
        .tab-btn { 
            background: #222; 
            border: 1px solid #444; 
            color: #aaa; 
            padding: 8px 12px; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: 0.3s; 
            white-space: nowrap; 
            font-size: 0.9em; 
        }
        .tab-btn.active { background: var(--accent-dim); color: white; border-color: var(--accent); }
        .tab-btn.locked { opacity: 0.5; cursor: not-allowed; border-color: #333; background: #111; }
        .content-area { 
            display: none; 
            flex-direction: column; 
            flex: 1; 
            min-height: 0; 
            overflow-y: auto; 
            padding-right: 5px; 
            margin-bottom: 10px; 
        }
        .content-area.active { display: flex; }
        
        #chat-panel { 
            flex: 0 0 200px; 
            height: 200px; 
            border-top: 1px solid #333; 
            background: #080808; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            box-sizing: border-box; 
            overflow: hidden; 
        }
        #chat-msgs { flex: 1; overflow-y: auto; margin-bottom: 10px; min-height: 0; }

        /* UI å…ƒä»¶ */
        input, textarea, select { 
            width: 100%; 
            background: #1a1a1a; 
            border: 1px solid #333; 
            color: white; 
            padding: 10px; 
            border-radius: 4px; 
            box-sizing: border-box; 
            margin-bottom: 10px; 
        }
        textarea { resize: vertical; font-family: monospace; }
        .editor-container { 
            flex: 0 0 250px; 
            display: flex; 
            flex-direction: column; 
            border: 1px solid #333; 
            border-radius: 6px; 
            overflow: hidden; 
            margin-bottom: 10px; 
        }
        .code-area { 
            flex: 1; 
            background: #0c0c0c; 
            color: #ddd; 
            padding: 15px; 
            border: none; 
            outline: none; 
            font-family: 'Consolas', monospace; 
            resize: none; 
            font-size: 14px; 
        }
        .output-area { 
            height: 100px; 
            background: #000; 
            color: #aaa; 
            padding: 10px; 
            font-family: monospace; 
            border-top: 1px solid #333; 
            overflow-y: auto; 
            white-space: pre-wrap; 
        }
        .btn-action { 
            background: var(--accent-dim); 
            color: white; 
            border: 1px solid var(--accent); 
            padding: 8px 20px; 
            cursor: pointer; 
            border-radius: 4px; 
            flex: 0 0 auto; 
        }
        .btn-action:hover { background: var(--accent); color: black; }
        .btn-action:disabled { background: #333; border-color: #555; color: #777; cursor: not-allowed; }

        .video-wrapper { 
            position: relative; 
            padding-bottom: 56.25%; 
            height: 0; 
            overflow: hidden; 
            margin-bottom: 15px; 
            border: 1px solid #444; 
            border-radius: 8px; 
        }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        .msg { padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9em; max-width: 90%; word-wrap: break-word; line-height: 1.5; }
        .msg.ai { color: var(--accent); background: #112211; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { color: #fff; background: #004455; align-self: flex-end; }
        .typing-cursor::after { content: 'â–‹'; animation: blink 1s infinite; color: var(--accent); }
        @keyframes blink { 0%, 100% {opacity: 1;} 50% {opacity: 0;} }

        .diff-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 10px 20px; margin-right: 10px; cursor: pointer; border-radius: 20px; transition: 0.3s; }
        .diff-btn:hover { border-color: var(--accent); color: white; }
        .diff-btn.active { background: var(--accent); color: black; font-weight: bold; border-color: var(--accent); }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,5,0.95); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #face-lock-overlay { backdrop-filter: blur(10px); background: rgba(0,0,0,0.85); z-index: 3000; }
        .lock-icon { font-size: 50px; margin-bottom: 20px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
        .login-box { width: 350px; padding: 40px; border: 1px solid var(--accent); border-radius: 10px; background: #111; }

        /* AI é—œæ‡·èŠå¤©å®¤æ¨£å¼ */
        .therapy-box {
            background: #111;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid var(--accent);
            max-width: 500px;
            width: 90%;
            height: 600px; 
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0, 255, 157, 0.2);
        }
        #therapy-header {
            flex: 0 0 auto;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 10px;
            text-align: center;
        }
        #therapy-chat-area {
            flex: 1;
            overflow-y: auto;
            background: #080808;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            text-align: left;
        }
        #therapy-input-area {
            flex: 0 0 auto;
            display: flex;
            gap: 10px;
        }
        #btn-therapy-close {
            margin-top: 10px;
            background: #333;
            border-color: #555;
            color: #ddd;
            width: 100%;
        }
        #btn-therapy-close:hover {
            background: var(--accent-dim);
            color: white;
            border-color: var(--accent);
        }
        
        #retry-status { font-size: 0.8em; color: #ffcc00; display:none; margin-left:10px; animation: blink 1s infinite; }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay" style="display:flex;">
        <div class="login-box">
            <h2 style="color:var(--accent);">æƒ…ç·’åµæ¸¬å­¸ç¿’ç³»çµ±</h2>

            <input type="text" id="student-id-input" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" style="text-align:center;">
            <button class="btn-action" onclick="loginSystem()" style="width:100%;">å•Ÿå‹•ç³»çµ± â–¶</button>
        </div>
    </div>

    <div id="face-lock-overlay" class="overlay"><div class="lock-icon">âš ï¸</div><h2 style="color:var(--warning);">å­¸ç¿’æš«åœ</h2><p style="color:#ccc;">åµæ¸¬ä¸åˆ°è‡‰éƒ¨ï¼Œè«‹å›åˆ°åº§ä½ä»¥ç¹¼çºŒå­¸ç¿’ã€‚</p></div>
    
    <div id="therapy-overlay" class="overlay">
        <div class="therapy-box">
            <div id="therapy-header">
                <h2 style="color:var(--accent); margin:0;">ğŸ¤– å¿ƒæƒ…å……é›»ç«™</h2>
                <p style="color:#aaa; font-size:0.9em; margin:5px 0 0 0;">ä¼‘æ¯ä¸€ä¸‹ï¼Œæˆ‘å€‘èŠèŠå§ï¼</p>
            </div>
            
            <div id="therapy-chat-area">
                <div class="msg ai">æ­£åœ¨åˆ†æå­¸ç¿’ç‹€æ…‹...</div>
            </div>
            
            <div id="therapy-input-area">
                <input id="therapy-input" placeholder="æƒ³èªªä»€éº¼éƒ½å¯ä»¥..." style="margin-bottom:0;" onkeypress="if(event.key==='Enter') sendTherapyChat()">
                <button class="btn-action" onclick="sendTherapyChat()">é€å‡º</button>
            </div>
            
            <button class="btn-action" id="btn-therapy-close" onclick="stopTherapy()">ğŸ˜Š æˆ‘å¿ƒæƒ…å¥½å¤šäº†ï¼Œå›åˆ°èª²ç¨‹</button>
        </div>
    </div>

    <div class="panel-left">
        <div class="header">
            æƒ…ç·’åµæ¸¬å­¸ç¿’ç³»çµ±
        </div>
        <div id="display-student-id" style="text-align:center; color:#888; margin-bottom:10px;">æœªç™»å…¥</div>
        <div class="cam-box"><video id="video" autoplay muted playsinline></video></div>
        <div class="status-box">
            <div class="metric-row"><span>æƒ…ç·’ (Emotion):</span> <span id="emo-val" class="val">--</span></div>
            <div class="metric-row"><span>ç‹€æ…‹ (Status):</span> <span id="act-val" class="val" style="color:gray">æ­£å¸¸</span></div>
            <div style="margin-top:5px; font-size:0.8em; color:gray;">å­¸ç¿’å£“åŠ›æŒ‡æ•¸ (Stress Index)</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-bar"></div></div>
        </div>
        <div class="log-header">ç³»çµ±æ—¥èªŒ <span id="retry-status">AI é€£ç·šé‡è©¦ä¸­...</span></div>
        <div id="log-box"></div>
    </div>

    <div class="panel-right">
        <div class="nav-tabs">
            <button class="tab-btn active" id="tab-learning" onclick="switchPhase('learning')">1. æ•™æå­¸ç¿’ (Learning)</button>
            <button class="tab-btn locked" id="tab-assignment" onclick="switchPhase('assignment')">2. å–®å…ƒä½œæ¥­ (Assignment)</button>
        </div>

        <div id="phase-learning" class="content-area active">
            <div style="background:#151515; padding:20px; border-radius:8px; border-left:4px solid var(--accent);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 id="lesson-title">è®€å–èª²ç¨‹ä¸­...</h2>
                    <span id="reading-timer" style="color:#888; font-family:monospace;">00:00</span>
                </div>
                <div class="video-wrapper"><div id="youtube-player"></div></div>
                <p id="material-summary">...</p>
                <pre id="material-code" style="background:#222; padding:10px; color:#aaa; margin-top:0;">...</pre>
                <hr style="border-color:#333; margin:20px 0;">
                <button class="btn-action" onclick="finishLearning()">âœ… å­¸ç¿’å®Œç•¢ï¼Œé€²å…¥ä½œæ¥­å€</button>
            </div>
        </div>

        <div id="phase-assignment" class="content-area">
            <h3>ğŸ“ å°è©¦èº«æ‰‹</h3>
            <p style="color:#aaa;">è«‹å®Œæˆä¸‹æ–¹æŒ‡å®šçš„ç¨‹å¼ä½œæ¥­ï¼Œå¯ä»¥ä¾ç…§è‡ªå·±çš„å­¸ç¿’ç‹€æ³é¸æ“‡æŒ‘æˆ°é›£åº¦ã€‚</p>
            
            <div id="ex-gen-section"><button class="btn-action" onclick="loadAssignment()" id="btn-gen-ex">ğŸ“¥ è¼‰å…¥ç·´ç¿’é¡Œ</button></div>
            
            <div id="ex-solve-section" style="display:none; margin-top:20px;">
                <div style="margin-bottom:15px;">
                    <button class="diff-btn" onclick="selectDifficulty('low')" id="btn-low">ğŸŸ¢ åŸºç¤é¡Œ</button>
                    <button class="diff-btn" onclick="selectDifficulty('mid')" id="btn-mid">ğŸŸ¡ é€²éšé¡Œ</button>
                    <button class="diff-btn" onclick="selectDifficulty('high')" id="btn-high">ğŸ”´ æŒ‘æˆ°é¡Œ</button>
                </div>
                <div style="border:1px solid #444; padding:20px; border-radius:8px; background:#111;">
                    <h4 id="ex-q-title" style="color:var(--accent); margin-top:0;">è«‹é¸æ“‡é¡Œç›®</h4>
                    <p id="ex-q-desc" style="white-space: pre-wrap;">...</p>
                    <div class="editor-container">
                        <textarea id="ex-code-editor" class="code-area" placeholder="# è«‹åœ¨æ­¤è¼¸å…¥ Python ç¨‹å¼ç¢¼..."></textarea>
                        <div id="ex-output" class="output-area">ç­‰å¾…åŸ·è¡Œ...</div>
                    </div>
                    <p id="ex-hint-text" style="color: #888; font-size: 0.9em; margin-top: 5px; background: #222; padding: 5px; border-radius: 4px; display:none;"></p>
                    
                    <div style="display:flex; justify-content:space-between;">
                        <button class="btn-action" style="background:#444;" onclick="executePythonCode('ex-code-editor', 'ex-output')">â–¶ æ¸¬è©¦åŸ·è¡Œ</button>
                        <button class="btn-action" onclick="checkAssignment()" id="btn-check-ex">ğŸ“ æäº¤ä½œæ¥­ (AI è©•é‡)</button>
                    </div>
                </div>
                <div id="ex-feedback" style="margin-top:15px; display:none; padding:15px; border-radius:6px; background:#222; border-left:4px solid #fff;">
                    <strong>AI å›é¥‹ï¼š</strong> <span id="ex-result-text"></span><br><br>
                    <button class="btn-action" id="btn-finish-unit" style="display:none;" onclick="finishUnit()">ğŸ‰ å®Œæˆæœ¬å–®å…ƒ</button>
                </div>
            </div>
        </div>

        <div id="chat-panel">
            <div id="chat-msgs"></div>
            <div style="display:flex; gap:10px;">
                <input id="chat-input" placeholder="è¼¸å…¥å•é¡Œè«‹ AI æ™ºæ…§å¤¥ä¼´å¹«å¿™" onkeypress="if(event.key==='Enter') sendChat()">
                <button class="btn-action" onclick="sendChat()">ç™¼é€</button>
            </div>
        </div>
    </div>

    <script>
        // ===============================================
        // ç³»çµ±æ ¸å¿ƒä»£ç¢¼
        // ===============================================

        const CUSTOM_CHAT_PROMPT = `
        ä½ ç¾åœ¨æ˜¯ä¸€ä½ç¨‹å¼è¨­è¨ˆå°å¸«ï¼Œä½ çš„ç›®æ¨™æ˜¯å”åŠ©å­¸ç”Ÿå®Œæˆ Python ä½œæ¥­ã€‚
        1. è«‹æ¡ç”¨ã€Œæ¼¸é€²å¼å›é¥‹ã€(Progressive Feedback) ç­–ç•¥ã€‚
        2. ç•¶å­¸ç”Ÿæå•æ™‚ï¼Œä¸è¦ç›´æ¥çµ¦ç­”æ¡ˆï¼Œå…ˆæä¾›ç°¡å–®çš„ç·šç´¢æˆ–æ€è€ƒæ–¹å‘ã€‚
        `;

        window.LESSON_CONFIG = { youtubeId: "PqFKRqpHrjw", title: "Python åŸºç¤æ•™å­¸", summary: "æœ¬å–®å…ƒä»‹ç´¹ Python åŸºç¤èªæ³•èˆ‡è®Šæ•¸æ‡‰ç”¨ã€‚", code: "print('Hello World')" };
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzkAH1B96FAMUhSf-n6ET5x8h8BXtXpxgIApmQraqk39rIZOhgUuOi94zmy1AuZMXAqXg/exec"; 
        
        let studentId = "";
        let currentPhase = 'learning';
        let isFaceLoaded = false, isPaused = false, pyodide = null;
        let stressScore = 0, faceMissingDuration = 0, learningStartTime = 0;
        let mouseDist = 0, lastMouseX = 0, lastMouseY = 0, backspaceCount = 0, lastEmotion = "";
        let chatHistory = [];
        let therapyHistory = [];
        let ytPlayer = null;
        let readTimerInterval = null;
        let readSeconds = 0;
        let generatedProblems = null; 
        let currentDifficulty = ''; 
        
        let unlockedPhases = { 'learning': true, 'assignment': false };
        const phaseOrder = ['learning', 'assignment'];

        // === log å‡½å¼ï¼šç›´æ¥é¡¯ç¤ºåœ¨ç•«é¢ ===
        function log(tag, message) {
            const logBox = document.getElementById('log-box');
            const now = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            const newLog = document.createElement('div');
            newLog.className = 'log-entry';
            newLog.innerHTML = `<span style="color:#555">[${now}]</span> <strong style="color:var(--accent)">${tag}</strong> ${message}`;
            logBox.prepend(newLog);
            if(logBox.children.length > 50) {
                logBox.removeChild(logBox.lastChild);
            }
        }

        async function safeCallAI(prompt, system, buttonId, retryCount = 0) {
            const MAX_RETRIES = 3;
            const btn = document.getElementById(buttonId);
            const statusEl = document.getElementById('retry-status');
            
            if(btn) { 
                if (retryCount === 0) { btn.innerText = "æ€è€ƒä¸­..."; btn.disabled = true; }
                else { btn.innerText = `é‡è©¦ä¸­...`; statusEl.style.display = 'inline'; }
            }
            try {
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("è«‹æ±‚è¶…æ™‚")), 20000));
                const result = await Promise.race([ callGemini(prompt, system), timeoutPromise ]);
                if(btn) { btn.innerText = "æˆåŠŸï¼"; setTimeout(()=>btn.innerText="é€å‡º", 1000); btn.disabled = false; }
                statusEl.style.display = 'none';
                return result;
            } catch(e) {
                if (retryCount < MAX_RETRIES) {
                    await new Promise(r => setTimeout(r, 2000));
                    return safeCallAI(prompt, system, buttonId, retryCount + 1);
                } else {
                    if(btn) { btn.innerText = "é‡è©¦"; btn.disabled = false; }
                    alert("AI é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    throw e;
                }
            }
        }

        async function executePythonCode(editorId, outputId) {
            const code = document.getElementById(editorId).value;
            const outputBox = document.getElementById(outputId);
            outputBox.innerText = "Running...\n";
            log('CODE', 'åŸ·è¡Œ Python ä»£ç¢¼');
            if (!pyodide) { outputBox.innerText += "Python loading...\n"; return; }
            try {
                pyodide.setStdout({ batched: (msg) => { outputBox.innerText += msg + "\n"; outputBox.scrollTop = outputBox.scrollHeight; } });
                await pyodide.runPythonAsync(code);
                outputBox.innerText += "\n[åŸ·è¡ŒçµæŸ]";
            } catch(err) { outputBox.innerText += "\nError:\n" + err; }
        }

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtube-player', {
                height: '100%', width: '100%',
                videoId: window.LESSON_CONFIG.youtubeId,
                playerVars: { 'playsinline': 1, 'rel': 0 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }
        window.loadYoutubeAPI = function() {
            if(window.YT) return;
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }
        function onPlayerStateChange(event) {
            if(event.data === YT.PlayerState.PLAYING) {
                startReadTimer();
                log('VIDEO', 'æ’­æ”¾å½±ç‰‡');
            } else if (event.data === YT.PlayerState.PAUSED) {
                stopReadTimer();
                log('VIDEO', 'æš«åœå½±ç‰‡');
            } else if (event.data === YT.PlayerState.ENDED) {
                stopReadTimer();
                log('VIDEO', 'å½±ç‰‡æ’­æ”¾å®Œç•¢');
            }
        }
        function startReadTimer() {
            if(readTimerInterval) return;
            readTimerInterval = setInterval(() => {
                readSeconds++;
                const m = Math.floor(readSeconds / 60).toString().padStart(2, '0');
                const s = (readSeconds % 60).toString().padStart(2, '0');
                document.getElementById('reading-timer').innerText = `å­¸ç¿’æ™‚é–“: ${m}:${s}`;
            }, 1000);
        }
        function stopReadTimer() { if(readTimerInterval) { clearInterval(readTimerInterval); readTimerInterval = null; } }

        async function loadAssignment() {
            log('TASK', 'æ­£åœ¨ç”Ÿæˆä½œæ¥­...');
            const prompt = `[ä»»å‹™] æ ¹æ“šæ•™æè¨­è¨ˆ 3 é“ Python ä½œæ¥­ï¼ˆä½ä¸­é«˜é›£åº¦ï¼‰ã€‚\næ•™æ:${window.LESSON_CONFIG.summary}\nç¯„ä¾‹:${window.LESSON_CONFIG.code}\nå›å‚³JSON:{"low":{"title":"","desc":"","hint":""},"mid":{...},"high":{...}}`;
            try {
                const r = await safeCallAI(prompt, "You are a JSON generator.", "btn-gen-ex");
                generatedProblems = JSON.parse(extractJSON(r));
                document.getElementById('ex-gen-section').style.display = 'none';
                document.getElementById('ex-solve-section').style.display = 'block';
                selectDifficulty('low');
                typeWriterMsg('ai', 'ä½œæ¥­å·²è¼‰å…¥ï¼Œè«‹é¸æ“‡é©åˆä½ çš„é›£åº¦é–‹å§‹ç·´ç¿’ã€‚');
                log('TASK', 'ä½œæ¥­ç”Ÿæˆå®Œç•¢ï¼ŒAI åŠ©æ•™å·²åŒæ­¥è³‡è¨Š');
            } catch(e) { console.error(e); }
        }
        
        function selectDifficulty(level) {
            if(!generatedProblems || !generatedProblems[level]) { alert("ä½œæ¥­è¼‰å…¥ä¸å®Œæ•´ï¼Œè«‹é‡è©¦"); return; }
            currentDifficulty = level;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${level}`).classList.add('active');
            const p = generatedProblems[level];
            document.getElementById('ex-q-title').innerText = `${p.title} (${level.toUpperCase()})`;
            document.getElementById('ex-q-desc').innerText = p.desc;
            document.getElementById('ex-code-editor').value = ""; 
            document.getElementById('ex-hint-text').innerText = "ğŸ’¡ æç¤ºï¼š" + (p.hint || "ç„¡"); 
            document.getElementById('ex-hint-text').style.display = "none";
            document.getElementById('ex-result-text').innerText = "";
            document.getElementById('ex-feedback').style.display = "none";
            log('NAV', `é¸æ“‡é›£åº¦: ${level}`);
        }
        
        async function checkAssignment() {
            const c = document.getElementById('ex-code-editor').value; const p = generatedProblems[currentDifficulty];
            log('TASK', 'æäº¤ä½œæ¥­æª¢æŸ¥');
            const prompt = `[é¡Œç›®] ${p.title}\n[æè¿°] ${p.desc}\n[ä»£ç¢¼] ${c}\nåˆ¤æ–·ç¨‹å¼ç¢¼æ˜¯å¦æ­£ç¢ºå®Œæˆéœ€æ±‚ã€‚å›å‚³JSON:{"correct":true/false,"feedback":"(è«‹çµ¦äºˆå…·é«”å»ºè­°)"}`;
            try {
                const r = await safeCallAI(prompt, "You are a Python Tutor.", "btn-check-ex");
                const json = JSON.parse(extractJSON(r));
                document.getElementById('ex-feedback').style.display = 'block';
                document.getElementById('ex-result-text').innerText = json.feedback;
                if(json.correct) { 
                    document.getElementById('ex-feedback').style.borderColor = "#00ff9d"; 
                    document.getElementById('btn-finish-unit').style.display = 'inline-block'; 
                    log('TASK', 'ä½œæ¥­é€šé (PASS)');
                } else { 
                    document.getElementById('ex-feedback').style.borderColor = "#ff3333";
                    document.getElementById('ex-hint-text').style.display = "block";
                    log('TASK', 'ä½œæ¥­æœªé€šé (FAIL)');
                }
            } catch(e) { console.error(e); }
        }

        function finishUnit() { alert("æ­å–œï¼æ‚¨å·²å®Œæˆæœ¬å–®å…ƒçš„æ‰€æœ‰å­¸ç¿’æ´»å‹•ã€‚"); log('SYS', 'å–®å…ƒå®Œæˆ'); }

        async function finishLearning() {
            if((Date.now()-learningStartTime)/1000 < 5) { stressScore+=20; log('WARN', 'é–±è®€æ™‚é–“éçŸ­'); return typeWriterMsg('ai', 'è«‹ç¢ºå¯¦è§€çœ‹å½±ç‰‡å…§å®¹å¾Œå†ç¹¼çºŒã€‚'); }
            if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo();
            unlockPhase('assignment'); 
            switchPhase('assignment');
            log('SYS', 'å®Œæˆå­¸ç¿’éšæ®µ');
        }

        // ===============================================
        // â˜… ä¿®æ”¹é‡é»ï¼šè®“èŠå¤© AI çŸ¥é“ä½œæ¥­é¡Œç›® â˜…
        // ===============================================
        async function sendChat() { 
            const v=document.getElementById('chat-input').value; if(!v)return; 
            document.getElementById('chat-msgs').innerHTML+=`<div class="msg user">${v}</div>`; 
            document.getElementById('chat-input').value=""; 
            
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(chatHistory.length - 20);

            // 1. å»ºç«‹åŒ…å«é¡Œç›®è³‡è¨Šçš„ System Prompt
            let contextInfo = `System: ${CUSTOM_CHAT_PROMPT}\nPhase=${currentPhase}`;
            
            // â˜… å¦‚æœå·²ç¶“ç”Ÿæˆé¡Œç›®ï¼ŒæŠŠé¡Œç›®è³‡è¨ŠçŒçµ¦ AI
            if (generatedProblems) {
                contextInfo += `\n\n[ç•¶å‰å·²ç”Ÿæˆçš„ä½œæ¥­é¡Œç›® (è«‹ä¾æ­¤å›ç­”å­¸ç”Ÿå•é¡Œ)]:\n`;
                contextInfo += JSON.stringify(generatedProblems, null, 2); 
                if (currentDifficulty) {
                    contextInfo += `\n\n[å­¸ç”Ÿç›®å‰é¸æ“‡çš„é›£åº¦]: ${currentDifficulty.toUpperCase()}`;
                }
            }

            const userMessage = {role:"user", parts:[{text: `${contextInfo}\n\nUser Question: ${v}`}]};
            log('CHAT', 'ç™¼é€è¨Šæ¯çµ¦ AI (å«é¡Œç›®è³‡è¨Š)');
            
            const r = await callGeminiChat([...chatHistory, userMessage]); 
            typeWriterMsg('ai', r); 
            chatHistory.push(userMessage);
            chatHistory.push({role:"model", parts:[{text:r}]});
        }
        
        async function callGeminiChat(messages) { 
            if(!GAS_URL.startsWith("http")) return "API Error"; 
            try {
                const r = await fetch(GAS_URL, { method: 'POST', mode: 'cors', body: JSON.stringify({ type: 'CALL_GEMINI_CHAT', messages: messages }) });
                return (await r.json()).text;
            } catch(e) { console.error("Chat Error:", e); return "AI é€£ç·šå¿™ç¢Œä¸­..."; } 
        }
        async function callGemini(u,s) { 
            if(!GAS_URL.startsWith("http")) return "API Error"; 
            try{ const r=await fetch(GAS_URL,{method:'POST',mode:'cors',body:JSON.stringify({type:'CALL_GEMINI',prompt:s+"\n"+u})}); return(await r.json()).text; } catch(e){return"Error";} 
        }
        
        function loginSystem() { 
            if(!document.getElementById('student-id-input').value) return alert("è¼¸å…¥å­¸è™Ÿ"); 
            studentId = document.getElementById('student-id-input').value; 
            document.getElementById('display-student-id').innerText = "ID: "+studentId; 
            document.getElementById('login-overlay').style.display='none'; 
            chatHistory = [];
            log('SYS', `å­¸ç”Ÿ ${studentId} ç™»å…¥`);
            init(); 
        }
        
        async function init() {
            window.loadYoutubeAPI(); 
            document.getElementById('lesson-title').innerText = window.LESSON_CONFIG.title;
            document.getElementById('material-summary').innerText = window.LESSON_CONFIG.summary;
            document.getElementById('material-code').innerText = window.LESSON_CONFIG.code;
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try { await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)]); isFaceLoaded = true; log('SYS', 'è‡‰éƒ¨åµæ¸¬æ¨¡çµ„å°±ç·’'); } catch(e){ log('ERR', 'è‡‰éƒ¨æ¨¡çµ„è¼‰å…¥å¤±æ•—'); }
            try { const s = await navigator.mediaDevices.getUserMedia({ video: {} }); document.getElementById('video').srcObject = s; document.getElementById('video').addEventListener('play', ()=>setInterval(monitorLoop, 1000)); log('SYS', 'æ”å½±æ©Ÿå·²å•Ÿå‹•'); } catch(e){ log('ERR', 'æ”å½±æ©Ÿå­˜å–å¤±æ•—'); }
            try { pyodide = await loadPyodide(); log('SYS', 'Python ç’°å¢ƒå°±ç·’'); } catch(e){ log('ERR', 'Pyodide è¼‰å…¥å¤±æ•—'); }
            document.addEventListener('mousemove', (e) => { if(lastMouseX!==0) mouseDist+=Math.sqrt(Math.pow(e.clientX-lastMouseX,2)+Math.pow(e.clientY-lastMouseY,2)); lastMouseX=e.clientX; lastMouseY=e.clientY; });
            document.addEventListener('keydown', (e)=> { if(e.key==='Backspace') backspaceCount++; });
            typeWriterMsg('ai', `æ­¡è¿ä½¿ç”¨ Python å­¸ç¿’ç³»çµ±ï¼Œè«‹å…ˆé–±è®€æ•™æã€‚`); learningStartTime = Date.now(); 
        }
        
        // ç›£æ§è¿´åœˆ
        async function monitorLoop() {
            if(isPaused) return; let emoDelta=0, actDelta=0, status="æ­£å¸¸", statusClass="val";
            if(isFaceLoaded) {
                const det = await faceapi.detectAllFaces(document.getElementById('video'), new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                if(det.length>0) { 
                    faceMissingDuration=0; document.getElementById('face-lock-overlay').style.display='none';
                    const top = Object.entries(det[0].expressions).sort((a,b)=>b[1]-a[1])[0][0]; 
                    document.getElementById('emo-val').innerText = top; 
                    if(top !== lastEmotion) {
                        log('EMO', `æƒ…ç·’è®ŠåŒ–: ${top}`);
                        lastEmotion = top;
                    }
                    if(['sad','angry','fearful'].includes(top)) emoDelta+=5; 
                } else { faceMissingDuration++; if(faceMissingDuration>3) document.getElementById('face-lock-overlay').style.display='flex'; }
            }
            if(mouseDist>4000 || backspaceCount>10) { 
                actDelta+=10; status="ç„¦æ…®"; statusClass="val bad"; 
                if(document.getElementById('act-val').innerText !== "ç„¦æ…®") log('STAT', 'åµæ¸¬åˆ°ç„¦æ…®è¡Œç‚º');
            }
            document.getElementById('act-val').innerText = status; document.getElementById('act-val').className = statusClass;
            stressScore = Math.min(100, Math.max(0, stressScore + emoDelta + actDelta - 2));
            const bar = document.getElementById('stress-bar'); bar.style.width = stressScore+"%"; bar.style.background = stressScore>85?"red":stressScore>50?"orange":"#00ff9d";
            
            if(stressScore>85) triggerAIIntervention();
            mouseDist=0; backspaceCount=0;
        }

        function switchPhase(p) { 
            if(!unlockedPhases[p]) return;
            currentPhase=p; 
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
            document.querySelectorAll('.content-area').forEach(c=>c.classList.remove('active')); 
            const idx=phaseOrder.indexOf(p); 
            document.querySelectorAll('.tab-btn')[idx].classList.add('active'); 
            document.querySelectorAll('.content-area')[idx].classList.add('active'); 
            log('NAV', `åˆ‡æ›è‡³éšæ®µ: ${p}`);
        }
        function unlockPhase(p) { unlockedPhases[p] = true; const btn = document.getElementById(`tab-${p}`); if(btn) btn.classList.remove('locked'); }
        function typeWriterMsg(r,t) { const box = document.getElementById('chat-msgs'); const div = document.createElement('div'); div.className = `msg ${r} typing-cursor`; box.appendChild(div); let i = 0; const tm = setInterval(()=>{ text = t || ""; div.innerHTML = marked.parse(text.substring(0, i++)); box.scrollTop = 99999; if(i>text.length){ clearInterval(tm); div.classList.remove('typing-cursor'); } }, 20); }
        function extractJSON(s) { const a=s.indexOf('{'),b=s.lastIndexOf('}'); return (a!=-1&&b!=-1)?s.substring(a,b+1):"{}"; }

        // AI é—œæ‡·æ¨¡å¼
        async function triggerAIIntervention() { 
            if(isPaused) return; 
            isPaused = true; 
            document.getElementById('therapy-overlay').style.display='flex'; 
            if(ytPlayer) ytPlayer.pauseVideo(); 
            log('WARN', 'å£“åŠ›éé«˜ï¼Œè§¸ç™¼ AI é—œæ‡·');

            let reason = "ä½ çš„å£“åŠ›æŒ‡æ•¸ä¼¼ä¹æœ‰é»é«˜";
            if (lastEmotion === 'sad') reason = "æˆ‘åµæ¸¬åˆ°ä½ ä¼¼ä¹ä¸å¤ªé–‹å¿ƒ";
            else if (lastEmotion === 'angry') reason = "ä½ çœ‹èµ·ä¾†æœ‰é»ç”Ÿæ°£ï¼Œæ˜¯é‡åˆ°å›°é›£äº†å—ï¼Ÿ";
            else if (lastEmotion === 'fearful') reason = "ä½ çœ‹èµ·ä¾†æœ‰é»ç„¦æ…®";
            else if (mouseDist > 3000) reason = "æˆ‘æ³¨æ„åˆ°ä½ çš„æ»‘é¼ ç§»å‹•æœ‰é»æ€¥ä¿ƒï¼Œæ˜¯ä¸æ˜¯ä¸çŸ¥æ‰€æªï¼Ÿ";
            
            document.getElementById('therapy-chat-area').innerHTML = `<div class="msg ai">æ­£åœ¨é—œå¿ƒæ‚¨çš„ç‹€æ…‹...</div>`;
            therapyHistory = []; 

            const systemPrompt = `
            ä½ ç¾åœ¨æ˜¯ä¸€ä½æº«æš–ã€å–„è§£äººæ„çš„AIè¼”å°è€å¸«ã€‚
            ä½ è§€å¯Ÿåˆ°å­¸ç”Ÿçš„ç‹€æ…‹æ˜¯ï¼š${reason}ã€‚
            è«‹ç”¨ç°¡çŸ­ã€è¦ªåˆ‡çš„å£èªï¼ˆ30å­—å…§ï¼‰ä¸»å‹•é—œå¿ƒå­¸ç”Ÿï¼Œèªªæ˜ä½ è§€å¯Ÿåˆ°äº†ä»€éº¼ï¼Œä¸¦è©¢å•ä»–é‚„å¥½å—ã€‚
            ä¸è¦çµ¦ç¨‹å¼å»ºè­°ï¼Œå…ˆè™•ç†æƒ…ç·’ã€‚
            `;
            
            const firstMsg = await callGemini("", systemPrompt);
            document.getElementById('therapy-chat-area').innerHTML = `<div class="msg ai">${marked.parse(firstMsg)}</div>`;
            therapyHistory.push({role: "model", parts: [{text: firstMsg}]});
        }

        async function sendTherapyChat() {
            const inputEl = document.getElementById('therapy-input');
            const v = inputEl.value;
            if(!v) return;
            const chatBox = document.getElementById('therapy-chat-area');
            chatBox.innerHTML += `<div class="msg user">${v}</div>`;
            inputEl.value = "";
            chatBox.scrollTop = chatBox.scrollHeight;

            therapyHistory.push({role: "user", parts: [{text: v}]});
            const systemPrompt = "ä½ æ˜¯ä¸€ä½æº«æš–çš„AIè¼”å°è€å¸«ã€‚è«‹ç¹¼çºŒèˆ‡å­¸ç”Ÿå°è©±ï¼Œå®‰æ’«ä»–çš„æƒ…ç·’ã€‚å¦‚æœä»–æ„Ÿè¦ºå¥½å¤šäº†ï¼Œå¯ä»¥é¼“å‹µä»–æŒ‰ä¸‹ã€Œå›åˆ°èª²ç¨‹ã€æŒ‰éˆ•ã€‚è«‹ä¿æŒå›æ‡‰ç°¡çŸ­ï¼ˆ50å­—å…§ï¼‰ã€‚";
            const messagesToSend = [{role: "user", parts: [{text: `System: ${systemPrompt}`}]}, ...therapyHistory];

            const r = await callGeminiChat(messagesToSend);
            chatBox.innerHTML += `<div class="msg ai">${marked.parse(r)}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
            therapyHistory.push({role: "model", parts: [{text: r}]});
        }

        function stopTherapy() { 
            document.getElementById('therapy-overlay').style.display='none'; 
            stressScore = 40; 
            isPaused = false; 
            log('SYS', 'çµæŸ AI é—œæ‡·ï¼Œå›åˆ°èª²ç¨‹');
        }
        
    </script>
</body>
</html>
