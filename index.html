<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å­¸ç”Ÿå­¸ç¿’ç³»çµ± (ç›¸æ©Ÿä¿®å¾©ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* =========================================
           1. å…¨å±€åŸºç¤è¨­å®š
           ========================================= */
        :root { 
            --bg-color: #050505; 
            --panel-bg: #101010; 
            --accent: #00ff9d; 
            --accent-dim: #005533; 
            --danger: #ff3333; 
            --warning: #ffcc00; 
            --text: #e0e0e0; 
            --border: #333; 
        }
        /* âœ… å­—é«”ï¼šèŠ«è½ Iansuiï¼ˆç¹ä¸­ï¼‰ */
        @font-face {
            font-family: 'Iansui';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src:
                url('https://cdn.jsdelivr.net/fontsource/fonts/iansui@latest/chinese-traditional-400-normal.woff2') format('woff2'),
                url('https://cdn.jsdelivr.net/fontsource/fonts/iansui@latest/chinese-traditional-400-normal.woff') format('woff');
        }

        body { 
            background: var(--bg-color); 
            color: var(--text); 
            font-family: 'Iansui','Microsoft JhengHei', sans-serif; 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* =========================================
           2. å·¦å´é¢æ¿ (ç›£æ¸¬å€)
           ========================================= */
        .panel-left { 
            width: 320px; 
            min-width: 320px; 
            background: var(--panel-bg); 
            border-right: 1px solid var(--border); 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            box-sizing: border-box; 
        }
        .header {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cam-box { 
            flex: 0 0 200px; 
            background: #000; 
            border: 2px solid var(--accent); 
            border-radius: 6px; 
            overflow: hidden; 
            position: relative; 
            margin-bottom: 10px; 
        }
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ */ 
        }
        .status-box { 
            flex: 0 0 auto; 
            background: #1a1a1a; 
            padding: 10px; 
            margin-bottom: 10px; 
            border-radius: 6px; 
            border: 1px solid #333; 
            font-size: 0.9em; 
        }
        .metric-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .val { font-weight: bold; color: var(--accent); }
        .stress-bar-bg { height: 6px; background: #333; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .stress-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.5s; }
        .log-header { flex: 0 0 auto; font-size: 0.8em; color: #666; margin-bottom: 5px; }
        #log-box { 
            flex: 1 1 auto; 
            background: #000; 
            padding: 5px; 
            font-family: monospace; 
            font-size: 0.75em; 
            color: #888; 
            overflow-y: auto; 
            border: 1px solid #333; 
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #222; padding-bottom: 2px; }

        /* =========================================
           3. å³å´é¢æ¿ (æ“ä½œå€)
           ========================================= */
        .panel-right { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            overflow: hidden; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        
        /* åˆ†é æ¨™ç±¤ */
        .nav-tabs { display: flex; gap: 8px; margin-bottom: 15px; flex: 0 0 auto; overflow-x: auto; }
        .tab-btn { 
            background: #222; 
            border: 1px solid #444; 
            color: #aaa; 
            padding: 8px 12px; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: 0.3s; 
            white-space: nowrap; 
            font-size: 0.9em; 
        }
        .tab-btn.active { background: var(--accent-dim); color: white; border-color: var(--accent); }
        /* é–å®šç‹€æ…‹æ¨£å¼ */
        .tab-btn.locked { opacity: 0.5; cursor: not-allowed; border-color: #333; background: #111; }

        /* ä¸­é–“å…§å®¹å€ */
        .content-area { 
            display: none; 
            flex-direction: column; 
            flex: 1; 
            min-height: 0; 
            overflow-y: auto; 
            padding-right: 5px; 
            margin-bottom: 10px; 
        }
        .content-area.active { display: flex; }

        /* åº•éƒ¨èŠå¤©å®¤ */
        #chat-panel { 
            flex: 0 0 200px; 
            height: 200px; 
            border-top: 1px solid #333; 
            background: #080808; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            box-sizing: border-box; 
            overflow: hidden; 
        }
        #chat-msgs { flex: 1; overflow-y: auto; margin-bottom: 10px; min-height: 0; }

        /* UI å…ƒä»¶ */
        input, textarea, select { 
            width: 100%; 
            background: #1a1a1a; 
            border: 1px solid #333; 
            color: white; 
            padding: 10px; 
            border-radius: 4px; 
            box-sizing: border-box; 
            margin-bottom: 10px; 
        }
        textarea { resize: vertical; font-family: monospace; }
        
        .editor-container { 
            flex: 0 0 250px; 
            display: flex; 
            flex-direction: column; 
            border: 1px solid #333; 
            border-radius: 6px; 
            overflow: hidden; 
            margin-bottom: 10px; 
        }
        .code-area { 
            flex: 1; 
            background: #0c0c0c; 
            color: #ddd; 
            padding: 15px; 
            border: none; 
            outline: none; 
            font-family: 'Consolas', monospace; 
            resize: none; 
            font-size: 14px; 
        }
        .output-area { 
            height: 100px; 
            background: #000; 
            color: #aaa; 
            padding: 10px; 
            font-family: monospace; 
            border-top: 1px solid #333; 
            overflow-y: auto; 
            white-space: pre-wrap; 
        }
        
        .btn-action { 
            background: var(--accent-dim); 
            color: white; 
            border: 1px solid var(--accent); 
            padding: 8px 20px; 
            cursor: pointer; 
            border-radius: 4px; 
            flex: 0 0 auto; 
        }
        .btn-action:hover { background: var(--accent); color: black; }
        .btn-action:disabled { background: #333; border-color: #555; color: #777; cursor: not-allowed; }

        /* å½±ç‰‡èˆ‡å•ç­” */
        .video-wrapper { 
            position: relative; 
            padding-bottom: 56.25%; 
            height: 0; 
            overflow: hidden; 
            margin-bottom: 15px; 
            border: 1px solid #444; 
            border-radius: 8px; 
        }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .qa-section { background: #1a1a1a; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #0099ff; }

        /* è©•åˆ†è¡¨ */
        .score-table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        .score-table td, .score-table th { border: 1px solid #333; padding: 8px; text-align: center; vertical-align: middle; }
        .score-table th { background: #222; color: var(--accent); width: 20%; }
        .score-table td.comment-cell { text-align: left; vertical-align: top; white-space: pre-wrap; height: 80px;}

        /* è¨Šæ¯æ°£æ³¡ */
        .msg { padding: 8px 12px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9em; max-width: 90%; word-wrap: break-word; line-height: 1.5; }
        .msg.ai { color: var(--accent); background: #112211; border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.user { color: #fff; background: #004455; align-self: flex-end; }
        .typing-cursor::after { content: 'â–‹'; animation: blink 1s infinite; color: var(--accent); }
        @keyframes blink { 0%, 100% {opacity: 1;} 50% {opacity: 0;} }

        /* é›£åº¦æŒ‰éˆ• */
        .diff-btn { background: #222; border: 1px solid #444; color: #ccc; padding: 10px 20px; margin-right: 10px; cursor: pointer; border-radius: 20px; transition: 0.3s; }
        .diff-btn:hover { border-color: var(--accent); color: white; }
        .diff-btn.active { background: var(--accent); color: black; font-weight: bold; border-color: var(--accent); }

        /* è¦†è“‹å±¤ (Overlays) */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5,5,5,0.95); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        #face-lock-overlay { backdrop-filter: blur(10px); background: rgba(0,0,0,0.85); z-index: 3000; }
        .lock-icon { font-size: 50px; margin-bottom: 20px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }
        .login-box { width: 350px; padding: 40px; border: 1px solid var(--accent); border-radius: 10px; background: #111; }

        /* æ²»ç™‚æ¨¡å¼æ¨£å¼ (å›ºå®šå¤§å°ã€å¯æ²å‹•) */
        .therapy-box {
            background: #111;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--danger);
            max-width: 500px;
            width: 80%;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 51, 51, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #therapy-text {
            color: #fff;
            margin: 20px 0;
            font-size: 1.3em;
            line-height: 1.6;
            min-height: 60px;
            max-height: 300px;
            overflow-y: auto;
            width: 100%;
        }
        
        /* è‡ªå‹•é‡è©¦æŒ‡ç¤ºç‡ˆ */
        #retry-status { font-size: 0.8em; color: #ffcc00; display:none; margin-left:10px; animation: blink 1s infinite; }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay" style="display:flex;">
        <div class="login-box">
            <h2 style="color:var(--accent);">å­¸ç”Ÿå­¸ç¿’ç³»çµ±</h2>
            <p style="color:#888;">è«‹è¼¸å…¥å­¸è™Ÿå•Ÿå‹•ç³»çµ±</p>
            <input type="text" id="student-id-input" placeholder="å­¸è™Ÿ" style="text-align:center;">
            <button class="btn-action" onclick="loginSystem()" style="width:100%;">ä¸‹ä¸€æ­¥ â–¶</button>
        </div>
    </div>

    <div id="camera-permission-overlay" class="overlay" style="display:none; z-index: 2000;">
        <div class="login-box" style="text-align:center;">
            <h2 style="color:var(--accent);">ğŸ“· å•Ÿå‹•æƒ…ç·’åµæ¸¬</h2>
            <p style="color:#aaa; line-height: 1.6;">
                ç‚ºäº†è®“ AI èƒ½åˆ¤æ–·å­¸ç¿’å£“åŠ›ï¼Œ<br>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚
            </p>
            <button class="btn-action" onclick="activateCamera()" style="width:100%; font-size:1.1em; padding:15px;">
                å…è¨±ä¸¦å•Ÿå‹•ç³»çµ± â–¶
            </button>
        </div>
    </div>

    <div id="face-lock-overlay" class="overlay"><div class="lock-icon">âš ï¸</div><h2 style="color:var(--warning);">ç³»çµ±æš«åœ</h2><p style="color:#ccc;">åµæ¸¬ä¸åˆ°è‡‰éƒ¨ï¼Œè«‹å›åˆ°åº§ä½ã€‚</p></div>
    
    <div id="therapy-overlay" class="overlay">
        <div class="therapy-box">
            <h2 style="color:var(--danger); margin-top:0;">âš ï¸ å£“åŠ›éè¼‰</h2>
            <p style="color:#aaa;">åµæ¸¬åˆ°é«˜åº¦ç„¦æ…®ï¼Œä¼‘æ¯ä¸€ä¸‹å§ã€‚</p>
            <div id="therapy-text">æ­£åœ¨è¼‰å…¥ç¬‘è©±...</div>
            <button class="btn-action" id="btn-resume" onclick="stopTherapy()" style="opacity:0; margin-top:20px; width:100%;">ğŸ˜… å¥½çš„ï¼Œæˆ‘å¿ƒæƒ…å¥½å¤šäº† (ç¹¼çºŒ)</button>
        </div>
    </div>

    <div class="panel-left">
        <div class="header">
            å­¸ç”Ÿå­¸ç¿’ç³»çµ± 
        </div>
        <div id="display-student-id" style="text-align:center; color:#888; margin-bottom:10px;">æœªç™»å…¥</div>
        <div class="cam-box"><video id="video" autoplay muted playsinline></video></div>
        <div class="status-box">
            <div class="metric-row"><span>æƒ…ç·’:</span> <span id="emo-val" class="val">--</span></div>
            <div class="metric-row"><span>ç‹€æ…‹:</span> <span id="act-val" class="val" style="color:gray">æ­£å¸¸</span></div>
            <div style="margin-top:5px; font-size:0.8em; color:gray;">å£“åŠ›æŒ‡æ•¸ (Stress)</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-bar"></div></div>
        </div>
        <div class="log-header">ç³»çµ±æ—¥èªŒ <span id="retry-status">AI é€£ç·šé‡è©¦ä¸­...</span></div>
        <div id="log-box"></div>
    </div>

    <div class="panel-right">
        <div class="nav-tabs">
            <button class="tab-btn active" id="tab-learning" onclick="switchPhase('learning')">1. å­¸ç¿’ (LN)</button>
            <button class="tab-btn locked" id="tab-exercise" onclick="switchPhase('exercise')">2. ç·´ç¿’ (EX)</button>
            <button class="tab-btn locked" id="tab-posing" onclick="switchPhase('posing')">3. æ“¬é¡Œ (PP)</button>
            <button class="tab-btn locked" id="tab-ai-review" onclick="switchPhase('ai-review')">4. AI è©•æˆ‘ (PA)</button> 
            <button class="tab-btn locked" id="tab-human-review" onclick="switchPhase('human-review')">5. è©•åŒå„• (HR)</button> 
            <button class="tab-btn locked" id="tab-reflection" onclick="switchPhase('reflection')">6. åæ€ (RF)</button>
        </div>

        <div id="phase-learning" class="content-area active">
            <div style="background:#151515; padding:20px; border-radius:8px; border-left:4px solid var(--accent);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 id="lesson-title">è®€å–èª²ç¨‹ä¸­...</h2>
                    <span id="reading-timer" style="color:#888; font-family:monospace;">00:00</span>
                </div>
                <div class="video-wrapper"><div id="youtube-player"></div></div>
                <p id="material-summary">...</p>
                <pre id="material-code" style="background:#222; padding:10px; color:#aaa; margin-top:0;">...</pre>
                <hr style="border-color:#333; margin:20px 0;">
                <button class="btn-action" onclick="finishLearning()">âœ… å½±ç‰‡çœ‹å®Œï¼Œé€²å…¥ç·´ç¿’é¡Œ</button>
            </div>
        </div>

        <div id="phase-exercise" class="content-area">
            <h3>ğŸ‹ï¸â€â™‚ï¸ å¯¦ä½œç·´ç¿’ï¼šAI å‡ºé¡Œ</h3>
            <p style="color:#aaa;">AI å°‡æ ¹æ“šå½±ç‰‡å…§å®¹ç”Ÿæˆä¸‰ç¨®é›£åº¦çš„é¡Œç›®ã€‚è«‹è‡³å°‘å®Œæˆä¸€é¡Œä»¥è§£é–ä¸‹ä¸€éšæ®µã€‚</p>
            <div id="ex-gen-section"><button class="btn-action" onclick="generatePracticeProblems()" id="btn-gen-ex">ğŸ¤– è®“ AI ç”Ÿæˆé¡Œç›®</button></div>
            <div id="ex-solve-section" style="display:none; margin-top:20px;">
                <div style="margin-bottom:15px;">
                    <button class="diff-btn" onclick="selectDifficulty('low')" id="btn-low">ğŸŸ¢ åŸºç¤é¡Œ</button>
                    <button class="diff-btn" onclick="selectDifficulty('mid')" id="btn-mid">ğŸŸ¡ é€²éšé¡Œ</button>
                    <button class="diff-btn" onclick="selectDifficulty('high')" id="btn-high">ğŸ”´ æŒ‘æˆ°é¡Œ</button>
                </div>
                <div style="border:1px solid #444; padding:20px; border-radius:8px; background:#111;">
                    <h4 id="ex-q-title" style="color:var(--accent); margin-top:0;">è«‹é¸æ“‡é›£åº¦</h4>
                    <p id="ex-q-desc" style="white-space: pre-wrap;">...</p>
                    <div class="editor-container">
                        <textarea id="ex-code-editor" class="code-area" placeholder="# åœ¨é€™è£¡å¯«ä¸‹ä½ çš„ç¨‹å¼ç¢¼..."></textarea>
                        <div id="ex-output" class="output-area">ç­‰å¾…åŸ·è¡Œ...</div>
                    </div>
                    <p id="ex-hint-text" style="color: #888; font-size: 0.9em; margin-top: 5px; background: #222; padding: 5px; border-radius: 4px;"></p>
                    <div style="display:flex; justify-content:space-between;">
                        <button class="btn-action" style="background:#444;" onclick="executePythonCode('ex-code-editor', 'ex-output')">â–¶ æ¸¬è©¦åŸ·è¡Œ</button>
                        <button class="btn-action" onclick="checkExAnswer()" id="btn-check-ex">ğŸ“ æäº¤çµ¦ AI æª¢æŸ¥</button>
                    </div>
                </div>
                <div id="ex-feedback" style="margin-top:15px; display:none; padding:15px; border-radius:6px; background:#222; border-left:4px solid #fff;">
                    <strong>AI æª¢æŸ¥çµæœï¼š</strong> <span id="ex-result-text"></span><br><br>
                    <button class="btn-action" id="btn-next-phase" style="display:none;" onclick="finishExercise()">å‰å¾€æ“¬é¡Œéšæ®µ â¡</button>
                </div>
            </div>
        </div>

        <div id="phase-posing" class="content-area">
            <label>é¡Œç›®åç¨±</label><input id="pp-title" placeholder="ä¾‹å¦‚ï¼šåˆ¤æ–·å¥‡å¶æ•¸">
            <label>é¡Œç›®æ•˜è¿°</label><textarea id="pp-desc" style="height:80px;"></textarea>
            <label>åƒè€ƒè§£ç­”ä»£ç¢¼</label>
            <div class="editor-container"><textarea id="code-editor" class="code-area" placeholder="print('Hello World')"></textarea><div id="output" class="output-area">ç­‰å¾…åŸ·è¡Œ...</div></div>
            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                 <button class="btn-action" style="background:#444;" onclick="executePythonCode('code-editor', 'output')">â–¶ åŸ·è¡Œä»£ç¢¼</button>
                 <button class="btn-action" onclick="finishPosing()">æš«å­˜ä¸¦æäº¤çµ¦ AI â¡</button>
            </div>
        </div>

        <div id="phase-ai-review" class="content-area">
            <h3>ğŸ¤– AI è©•åˆ†ä½ çš„é¡Œç›®</h3>
            <button class="btn-action" onclick="triggerAIReview()" id="btn-ai-review">å•Ÿå‹• AI è©•åˆ†</button>
            <div id="ai-result" style="display:none; margin-top:15px;">
                <table class="score-table">
                    <tr><th>å‘åº¦</th><th>å¾—åˆ† (1-5)</th><th>AI è©•èª</th></tr>
                    <tr><td>é¡Œç›®æ­£ç¢ºæ€§</td><td id="ai-s1">-</td><td rowspan="5" id="ai-comment-cell" class="comment-cell"></td></tr>
                    <tr><td>é‚è¼¯è¤‡é›œåº¦</td><td id="ai-s2">-</td></tr>
                    <tr><td>å¯¦ç”¨æ€§</td><td id="ai-s3">-</td></tr>
                    <tr><td>ä»£ç¢¼æ­£ç¢ºæ€§</td><td id="ai-s4">-</td></tr>
                    <tr><td>ä»£ç¢¼å¯è®€æ€§</td><td id="ai-s5">-</td></tr>
                </table>
                <br><button class="btn-action" onclick="switchPhase('human-review')">å‰å¾€åŒå„•äº’è©• â¡</button>
            </div>
        </div>

        <div id="phase-human-review" class="content-area">
            <h3>ğŸ‘¥ è©•åˆ†å…¶ä»–åŒå­¸çš„é¡Œç›®</h3>
            <div style="background:#222; padding:10px; margin-bottom:15px; border-radius:4px; font-size:0.9em; color:#aaa;">
                <span style="color:var(--accent)">â˜… è¦å‰‡èªªæ˜ï¼š</span> ç‚ºäº†ç¢ºä¿è©•åˆ†å…¬æ­£ï¼Œè«‹å…ˆè©¦è‘—è§£å‡ºåŒå­¸çš„é¡Œç›®ã€‚
            </div>
            <button class="btn-action" onclick="loadPeerProblem()" style="background:#444; margin-bottom:15px;">ğŸ“¥ è¼‰å…¥åŒå„•æŒ‘æˆ°</button>
            <div id="human-review-container" style="display:none; border:1px solid #333; padding:15px; border-radius:6px;">
                <h4 id="hr-title" style="color:var(--accent); margin-top:0;"></h4>
                <p id="hr-desc" style="color:#aaa; background:#111; padding:10px; border-radius:4px; margin-bottom:20px;"></p>
                <div id="hr-stage-1-solve">
                    <label style="color:#fff;">è«‹å…ˆè©¦è‘—è§£é¡Œ (Testing Zone)ï¼š</label>
                    <div class="editor-container"><textarea id="hr-attempt-editor" class="code-area" placeholder="# è©¦å¯«..."></textarea><div id="hr-attempt-output" class="output-area">ç­‰å¾…æ¸¬è©¦...</div></div>
                    <div style="display:flex; justify-content:space-between;"><button class="btn-action" style="background:#444;" onclick="executePythonCode('hr-attempt-editor', 'hr-attempt-output')">â–¶ æ¸¬è©¦æˆ‘çš„ä»£ç¢¼</button><button class="btn-action" onclick="revealPeerGrading()">ğŸ‘€ æˆ‘è©¦éäº†ï¼Œé¡¯ç¤ºè§£ç­”èˆ‡è©•åˆ†</button></div>
                </div>
                <div id="hr-stage-2-grade" style="display:none; margin-top:20px; border-top:1px solid #333; padding-top:20px;">
                    <label style="color:var(--warning);">åŒå­¸çš„åƒè€ƒè§£ç­”ï¼š</label><pre id="hr-code" style="background:#222; padding:10px; overflow-x:auto; margin-bottom:20px;"></pre>
                    <label>çµ¦äºˆè©•åˆ†ï¼š</label>
                    <table class="score-table"><tr><th>æ­£ç¢º</th><th>è¤‡é›œ</th><th>å¯¦ç”¨</th><th>ä»£ç¢¼</th><th>å¯è®€</th></tr><tr><td><input type="number" id="hr-s1" value="3"></td><td><input type="number" id="hr-s2" value="3"></td><td><input type="number" id="hr-s3" value="3"></td><td><input type="number" id="hr-s4" value="3"></td><td><input type="number" id="hr-s5" value="3"></td></tr></table>
                    <textarea id="hr-comment" style="margin-top:10px; height:60px;" placeholder="è©•èª..."></textarea><button class="btn-action" onclick="submitHumanReview()">ğŸ“¤ é€å‡ºè©•åˆ†</button>
                </div>
            </div>
        </div>

        <div id="phase-reflection" class="content-area">
            <h3>ğŸ¤” å­¸ç¿’åæ€</h3>
            <textarea id="rf-content" style="height:150px;"></textarea>
            <button class="btn-action" onclick="submitAll()">âœ… æäº¤æ‰€æœ‰æˆæœ</button>
        </div>

        <div id="chat-panel">
            <div id="chat-msgs"></div>
            <div style="display:flex; gap:10px;">
                <input id="chat-input" placeholder="è·Ÿæ™ºæ…§åŠ©æ•™å°è©±..." onkeypress="if(event.key==='Enter') sendChat()">
                <button class="btn-action" onclick="sendChat()">ç™¼é€</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, orderBy, limit, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ============================================
        // â˜…â˜…â˜… è«‹åœ¨ä¸‹æ–¹è²¼ä¸Šæ‚¨çš„ Firebase Config â˜…â˜…â˜…
        // ============================================
        const firebaseConfig = {
              apiKey: "AIzaSyBgx03WUCJhe3ymWhecEYfiyShmcy9bCkg",
              authDomain: "code-a1ef3.firebaseapp.com",
              projectId: "code-a1ef3",
              storageBucket: "code-a1ef3.firebasestorage.app",
              messagingSenderId: "733626558270",
              appId: "1:733626558270:web:6d0ffcae5a5b329b212e6f",
              measurementId: "G-547WFQWRHZ"
        };

        // åˆå§‹åŒ– Firebase (è‹¥æœªå¡« Config å‰‡è·³é)
        if (firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // 1. è®€å–æ•™æå‡½å¼
            window.loadLessonFromCloud = async function() {
                console.log("æ­£åœ¨å¾é›²ç«¯è®€å–æ•™æ...");
                const q = query(collection(db, "units"), where("isActive", "==", true), orderBy("order", "asc"), limit(1));
                
                try {
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const data = querySnapshot.docs[0].data();
                        window.LESSON_CONFIG = { youtubeId: data.youtubeId, title: data.title, summary: data.summary, code: data.code };
                        document.getElementById('lesson-title').innerText = data.title;
                        document.getElementById('material-summary').innerText = data.summary;
                        document.getElementById('material-code').innerText = data.code;
                        window.loadYoutubeAPI(); 
                    } else {
                        console.log("ç„¡å•Ÿç”¨èª²ç¨‹ï¼Œè¼‰å…¥é è¨­");
                        window.loadYoutubeAPI(); // è¼‰å…¥é è¨­
                    }
                } catch(e) {
                    console.error("Firebase è®€å–å¤±æ•—:", e);
                    alert("ç„¡æ³•é€£ç·šåˆ°èª²ç¨‹è³‡æ–™åº«ï¼Œå°‡ä½¿ç”¨é è¨­æ•™æã€‚");
                    window.loadYoutubeAPI();
                }
            };

            // 2. ä¸Šå‚³å­¸ç¿’ç´€éŒ„å‡½å¼ (è®“æ•™å¸«å¾Œå°çœ‹å¾—åˆ°æ•¸æ“š)
            window.uploadToFirebase = async function(dataPayload) {
                try {
                    // åŠ ä¸Šä¼ºæœå™¨æ™‚é–“æˆ³è¨˜ (æ¨¡æ“¬)
                    dataPayload.createdAt = new Date();
                    // å¯«å…¥ 'records' é›†åˆ
                    await addDoc(collection(db, "records"), dataPayload);
                    console.log("Firebase ä¸Šå‚³æˆåŠŸ:", dataPayload.type);
                } catch (e) {
                    console.error("Firebase ä¸Šå‚³å¤±æ•—:", e);
                }
            };
            
            // â˜…â˜…â˜… 3. è‡ªå‹•æ¢å¾©é€²åº¦å‡½å¼ â˜…â˜…â˜…
            window.restoreStudentProgress = async function(studentId) {
                console.log("æ­£åœ¨æ¢å¾©å­¸ç”Ÿé€²åº¦...", studentId);
                // æŸ¥è©¢è©²å­¸ç”Ÿæœ€æ–°çš„é€²åº¦ç´€éŒ„ (åªæŸ¥ PHASE_ é–‹é ­çš„)
                const q = query(
                    collection(db, "records"), 
                    where("studentId", "==", studentId), 
                    orderBy("createdAt", "desc") // å¾æœ€æ–°é–‹å§‹æ‰¾
                );
                
                try {
                    const snap = await getDocs(q);
                    let latestPhase = null;
                    
                    // éæ­·æ‰¾å‡ºæœ€æ–°çš„æœ‰æ•ˆéšæ®µ (æ’é™¤ MONITOR_LOG, CHAT_LOG)
                    for (const doc of snap.docs) {
                        const type = doc.data().type;
                        if (type && type.startsWith('PHASE_')) {
                            latestPhase = type;
                            break; // æ‰¾åˆ°æœ€æ–°çš„å°±åœ
                        }
                    }
                    
                    if (latestPhase) {
                        console.log("æ‰¾åˆ°æœ€æ–°é€²åº¦:", latestPhase);
                        // å®šç¾©ç‹€æ…‹æ©Ÿï¼šå¦‚æœæ‰¾åˆ°äº† keyï¼Œå°±æ‡‰è©²è·³åˆ° value çš„é é¢
                        const phaseMap = {
                            'PHASE_1_LEARNING': 'exercise', // å®Œæˆå½±ç‰‡ -> å»ç·´ç¿’
                            'PHASE_2_EXERCISE': 'posing',   // å®Œæˆç·´ç¿’ -> å»æ“¬é¡Œ
                            'PHASE_3_POSING': 'ai-review',  // å®Œæˆæ“¬é¡Œ -> å»AIè©•åˆ†
                            'PHASE_4_AI': 'human-review',   // å®ŒæˆAI -> å»äº’è©•
                            'PHASE_5_PEER': 'reflection',   // å®Œæˆäº’è©• -> å»åæ€
                            'PHASE_6_REFLECTION': 'reflection' // å…¨éƒ¨å®Œæˆ
                        };
                        
                        const targetPhase = phaseMap[latestPhase];
                        if (targetPhase) {
                            // ä¾åºè§£é–ç›´åˆ°ç›®æ¨™éšæ®µ
                            const phases = ['learning', 'exercise', 'posing', 'ai-review', 'human-review', 'reflection'];
                            for (const p of phases) {
                                unlockPhase(p); // å‘¼å«å…¨åŸŸçš„è§£é–å‡½å¼
                                if (p === targetPhase) break;
                            }
                            // åˆ‡æ›åˆ°è©²é é¢
                            switchPhase(targetPhase);
                            typeWriterMsg('ai', `æ­¡è¿å›ä¾†ï¼ç³»çµ±å·²ç‚ºæ‚¨æ¢å¾©åˆ°ã€${targetPhase}ã€‘éšæ®µã€‚`);
                        }
                    }
                } catch (e) {
                    console.error("æ¢å¾©é€²åº¦å¤±æ•—:", e);
                }
            };

            // åŸ·è¡Œè®€å–
            window.loadLessonFromCloud();
        } else {
            console.log("Firebase Config æœªè¨­å®šï¼Œä½¿ç”¨é è¨­æ•™æ");
            window.loadYoutubeAPI();
            // å®šç¾©ç©ºå‡½å¼ï¼Œé¿å…å ±éŒ¯
            window.uploadToFirebase = async function() {};
            window.restoreStudentProgress = async function() {};
        }
    </script>

    <script>
        // ===============================================
        // ç³»çµ±æ ¸å¿ƒä»£ç¢¼
        // ===============================================

        // â˜…â˜…â˜… V12.0: è‡ªè¨‚èŠå¤©å®¤é¢¨æ ¼ (Prompt) â˜…â˜…â˜…
        const CUSTOM_CHAT_PROMPT = `
        ä½ ç¾åœ¨æ˜¯ä¸€ä½å¯Œæœ‰è€å¿ƒçš„ç¨‹å¼è¨­è¨ˆå°å¸« (Socratic Tutor)ã€‚
        1. è«‹ç”¨å¼•å°çš„æ–¹å¼å›ç­”å­¸ç”Ÿçš„å•é¡Œï¼Œä¸è¦ç›´æ¥çµ¦å‡ºå®Œæ•´ç¨‹å¼ç¢¼ã€‚
        2. é¼“å‹µå­¸ç”Ÿæ€è€ƒï¼Œé©æ™‚ä½¿ç”¨åå•å¥ã€‚
        3. å›ç­”è¦ç°¡æ½”ï¼Œé©åˆåˆå­¸è€…é–±è®€ï¼Œä¸€æ¬¡è¼¸å‡ºä¸è¶…é300å­—ã€‚
        4. å°è©±é¢¨è¶£å¹½é»˜ï¼Œè®“äººé¡˜æ„é–±è®€ä¸‹å»ã€‚
        `;

        window.LESSON_CONFIG = { youtubeId: "PqFKRqpHrjw", title: "é è¨­æ•™æ", summary: "é è¨­æ‘˜è¦", code: "print('Hello')" };
        // â˜…â˜…â˜… å‹™å¿…æª¢æŸ¥æ­¤ GAS URL æ˜¯å¦æ­£ç¢º â˜…â˜…â˜…
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzkAH1B96FAMUhSf-n6ET5x8h8BXtXpxgIApmQraqk39rIZOhgUuOi94zmy1AuZMXAqXg/exec"; 
        
        let studentId = "";
        let currentPhase = 'learning';
        let isFaceLoaded = false, isPaused = false, pyodide = null;
        let sessionData = { probTitle:"", probDesc:"", probCode:"", aiScores:[], aiComment:"", reflection:"" };
        let currentPeerProblemTitle = "";
        let currentPeerRefCode = ""; 
        let stressScore = 0, tabSwitchCount = 0, faceMissingDuration = 0, learningStartTime = 0;
        let mouseDist = 0, lastMouseX = 0, lastMouseY = 0, backspaceCount = 0, lastEmotion = "";
        let chatHistory = [];
        let ytPlayer = null;
        let readTimerInterval = null;
        let readSeconds = 0;
        let generatedProblems = null; 
        let currentDifficulty = ''; 
        let lastUploadTime = 0; // æ§åˆ¶ä¸Šå‚³é »ç‡
        
        // â˜…â˜…â˜… éšæ®µè§£é–ç‹€æ…‹ (V13.1) â˜…â˜…â˜…
        let unlockedPhases = {
            'learning': true,
            'exercise': false,
            'posing': false,
            'ai-review': false,
            'human-review': false,
            'reflection': false
        };
        const phaseOrder = ['learning', 'exercise', 'posing', 'ai-review', 'human-review', 'reflection'];

        // Prompt Tuning: Ensure ARRAY format
        const PROMPT_STRICT_GRADING = `
        ä½ ç¾åœ¨æ˜¯ä¸€ä½é›»è…¦ç§‘å­¸å°ˆå®¶ã€‚è«‹å°å­¸ç”Ÿçš„é¡Œç›®èˆ‡ä»£ç¢¼é€²è¡Œè©•åˆ†ã€‚
        è«‹å›å‚³åš´æ ¼çš„ JSON æ ¼å¼ï¼š
        {
            "scores": [åˆ†æ•¸1, åˆ†æ•¸2, åˆ†æ•¸3, åˆ†æ•¸4, åˆ†æ•¸5],
            "comment": "ä½ çš„å…·é«”è©•èª..."
        }
        åˆ†æ•¸å‘åº¦(1-5åˆ†)ï¼š1.é¡Œç›®æ­£ç¢ºæ€§ 2.é‚è¼¯è¤‡é›œåº¦ 3.å¯¦ç”¨æ€§ 4.ä»£ç¢¼æ­£ç¢ºæ€§ 5.ä»£ç¢¼å¯è®€æ€§ã€‚
        `;
        
        // â˜…â˜…â˜… ä¿®æ­£å¾Œçš„æ²»ç™‚ Prompt (é™åˆ¶é•·åº¦) â˜…â˜…â˜…
        const PROMPT_THERAPY_STYLE = `ä½¿ç”¨è€…å£“åŠ›éé«˜ã€‚è«‹è¬›ä¸€å€‹ã€Œ30å­—ä»¥å…§ã€çš„æ¥µçŸ­å·¥ç¨‹å¸«ç¬‘è©±æˆ–é¼“å‹µçš„è©±ã€‚ä¸€å®šè¦çŸ­ã€‚`;

        // === API å‘¼å«é˜²å‘†æ©Ÿåˆ¶ (Timeout Wrapper + Auto Retry) ===
        async function safeCallAI(prompt, system, buttonId, retryCount = 0) {
            const MAX_RETRIES = 3; // æœ€å¤šé‡è©¦ 3 æ¬¡
            const btn = document.getElementById(buttonId);
            const statusEl = document.getElementById('retry-status');
            
            if(btn) { 
                if (retryCount === 0) { btn.innerText = "æ€è€ƒä¸­..."; btn.disabled = true; }
                else { 
                    btn.innerText = `é€£ç·šä¸ç©©ï¼Œè‡ªå‹•é‡è©¦ä¸­ (${retryCount}/${MAX_RETRIES})...`;
                    statusEl.style.display = 'inline';
                    statusEl.innerText = `AI é€£ç·šé‡è©¦ä¸­... (${retryCount})`;
                }
            }
            
            try {
                // æœ€é•·ç­‰å¾… 20 ç§’
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("è«‹æ±‚è¶…æ™‚")), 20000));
                
                const result = await Promise.race([
                    callGemini(prompt, system),
                    timeoutPromise
                ]);
                
                if(btn) { btn.innerText = "æˆåŠŸï¼"; setTimeout(()=>btn.innerText="é€å‡º", 1000); btn.disabled = false; }
                statusEl.style.display = 'none';
                return result;

            } catch(e) {
                console.warn(`Attempt ${retryCount + 1} failed:`, e);
                
                if (retryCount < MAX_RETRIES) {
                    // ç­‰å¾… 2 ç§’å¾Œé‡è©¦
                    await new Promise(r => setTimeout(r, 2000));
                    return safeCallAI(prompt, system, buttonId, retryCount + 1);
                } else {
                    alert("AI é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚\n" + e.message);
                    if(btn) { btn.innerText = "é‡è©¦ / é€å‡º"; btn.disabled = false; }
                    statusEl.style.display = 'none';
                    throw e; // è®“å¤–å±¤ catch è™•ç†
                }
            }
        }

        // === â˜…â˜…â˜… Python çµ±ä¸€åŸ·è¡Œæ ¸å¿ƒ (V12.0: Ultimate Input Fix) â˜…â˜…â˜… ===
        async function executePythonCode(editorId, outputId) {
            const code = document.getElementById(editorId).value;
            const outputBox = document.getElementById(outputId);
            
            outputBox.innerText = "Running...\n";
            if (!pyodide) { outputBox.innerText += "Python loading...\n"; return; }

            try {
                // 1. è¨­å®šæ¨™æº–è¼¸å‡º (Print)
                // é€™è£¡æ”¹ç”¨ direct appendï¼Œé¿å… pyodide çš„ batched å°è‡´å»¶é²
                pyodide.setStdout({
                    batched: (msg) => { 
                        outputBox.innerText += msg + "\n"; 
                        outputBox.scrollTop = outputBox.scrollHeight; // Auto scroll
                    }
                });

                // 2. æ³¨å…¥æ ¸å¿ƒè¦†å¯«ä»£ç¢¼ (Fix Input & Output Flushing)
                const coreOverrideCode = `
import js
import builtins
import time
import sys

# å¼·åˆ¶ stdout è¡Œç·©è¡ï¼Œç¢ºä¿ print ç«‹å³è¼¸å‡º
sys.stdout.reconfigure(line_buffering=True)

def custom_input(prompt_text=""):
    if prompt_text:
        print(prompt_text, end="")
    
    # â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šæš«åœ 0.5 ç§’ï¼Œç¢ºä¿ç€è¦½å™¨æœ‰è¶³å¤ æ™‚é–“åˆ·æ–°ç•«é¢ï¼Œé¿å…è¼¸å…¥æ¡†å¡æ­»æ„Ÿè¦º â˜…â˜…â˜…
    time.sleep(0.5)
    
    # å‘¼å«ç€è¦½å™¨åŸç”Ÿ prompt
    val = js.prompt(prompt_text if prompt_text else "Python è«‹æ±‚è¼¸å…¥ (Input):")
    
    # è™•ç†å–æ¶ˆ
    if val is None:
        raise KeyboardInterrupt("ä½¿ç”¨è€…å–æ¶ˆè¼¸å…¥")
    
    # å›é¡¯è¼¸å…¥å…§å®¹
    print(val)
    return str(val)

builtins.input = custom_input
`;
                await pyodide.runPythonAsync(coreOverrideCode);
                await pyodide.runPythonAsync(code);
                outputBox.innerText += "\n[åŸ·è¡ŒçµæŸ]";

            } catch(err) {
                if(err.message.includes("ä½¿ç”¨è€…å–æ¶ˆè¼¸å…¥") || err.message.includes("KeyboardInterrupt")) {
                    outputBox.innerText += "\n[å·²å–æ¶ˆè¼¸å…¥ (User Cancelled)]";
                } else {
                    outputBox.innerText += "\nError:\n" + err;
                }
            }
        }

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtube-player', {
                height: '100%', width: '100%',
                videoId: window.LESSON_CONFIG.youtubeId,
                playerVars: { 'playsinline': 1, 'rel': 0 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }
        
        // æ­¤å‡½å¼ç”±ä¸Šæ–¹çš„ Firebase æ¨¡çµ„å‘¼å«
        window.loadYoutubeAPI = function() {
            if(window.YT) return; // é¿å…é‡è¤‡è¼‰å…¥
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        function onPlayerStateChange(event) {
            let stateStr = "";
            switch(event.data) {
                case YT.PlayerState.PLAYING: stateStr = "VIDEO_PLAY"; startReadTimer(); break;
                case YT.PlayerState.PAUSED: stateStr = "VIDEO_PAUSE"; stopReadTimer(); break;
                case YT.PlayerState.ENDED: stateStr = "VIDEO_END"; stopReadTimer(); break;
            }
            if(stateStr) log('ACT', `${stateStr} at ${Math.floor(ytPlayer.getCurrentTime())}s`);
        }
        function startReadTimer() {
            if(readTimerInterval) return;
            readTimerInterval = setInterval(() => {
                readSeconds++;
                const m = Math.floor(readSeconds / 60).toString().padStart(2, '0');
                const s = (readSeconds % 60).toString().padStart(2, '0');
                document.getElementById('reading-timer').innerText = `å­¸ç¿’æ™‚é–“: ${m}:${s}`;
            }, 1000);
        }
        function stopReadTimer() { if(readTimerInterval) { clearInterval(readTimerInterval); readTimerInterval = null; } }

        // ===============================================
        // Phase 2: ç·´ç¿’å€
        // ===============================================
        async function generatePracticeProblems() {
            const prompt = `[ä»»å‹™] æ ¹æ“šæ•™æè¨­è¨ˆ 3 é“ Python ç·´ç¿’é¡Œï¼ˆä½ä¸­é«˜ï¼‰ã€‚\næ•™æ:${window.LESSON_CONFIG.summary}\nç¯„ä¾‹:${window.LESSON_CONFIG.code}\nå›å‚³JSON:{"low":{"title":"","desc":"","hint":""},"mid":{...},"high":{...}}`;
            try {
                const r = await safeCallAI(prompt, "You are a JSON generator.", "btn-gen-ex");
                console.log("Raw AI Response:", r); // Debug log
                generatedProblems = JSON.parse(extractJSON(r));
                document.getElementById('ex-gen-section').style.display = 'none';
                document.getElementById('ex-solve-section').style.display = 'block';
                selectDifficulty('low');
                typeWriterMsg('ai', 'é¡Œç›®å·²ç”Ÿæˆï¼Œè«‹é–‹å§‹æŒ‘æˆ°ï¼');
            } catch(e) { console.error(e); }
        }
        function selectDifficulty(level) {
            if(!generatedProblems || !generatedProblems[level]) {
                console.error("ç”Ÿæˆé¡Œç›®è³‡æ–™ä¸å…¨:", generatedProblems);
                alert("é¡Œç›®ç”Ÿæˆä¼¼ä¹ä¸å®Œæ•´ï¼Œè«‹é‡æ–°é»é¸ã€Œè®“ AI ç”Ÿæˆé¡Œç›®ã€");
                document.getElementById('ex-gen-section').style.display = 'block';
                document.getElementById('ex-solve-section').style.display = 'none';
                return;
            }
            
            currentDifficulty = level;
            document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${level}`).classList.add('active');
            const p = generatedProblems[level];
            document.getElementById('ex-q-title').innerText = `${p.title} (${level.toUpperCase()})`;
            document.getElementById('ex-q-desc').innerText = p.desc;
            document.getElementById('ex-code-editor').value = ""; // æ¸…ç©º
            document.getElementById('ex-hint-text').innerText = "ğŸ’¡ æç¤ºï¼š" + (p.hint || "ç„¡"); // æç¤ºåœ¨ä¸‹æ–¹
            document.getElementById('ex-result-text').innerText = "";
            document.getElementById('ex-feedback').style.display = "none";
        }
        
        async function runExPython() { await executePythonCode('ex-code-editor', 'ex-output'); }
        
        async function checkExAnswer() {
            const c = document.getElementById('ex-code-editor').value; const p = generatedProblems[currentDifficulty]; const btn = document.getElementById('btn-check-ex');
            const prompt = `[é¡Œç›®] ${p.title}\n[æè¿°] ${p.desc}\n[ä»£ç¢¼] ${c}\nåˆ¤æ–·å°éŒ¯å›å‚³JSON:{"correct":true/false,"feedback":"..."}`;
            try {
                const r = await safeCallAI(prompt, "You are a Tutor.", "btn-check-ex");
                const json = JSON.parse(extractJSON(r));
                document.getElementById('ex-feedback').style.display = 'block';
                document.getElementById('ex-result-text').innerText = json.feedback;
                await sendToGAS({ type: 'PHASE_2_EXERCISE', studentId, difficulty: currentDifficulty, title: p.title, code: c, passed: json.correct?"PASS":"FAIL", feedback: json.feedback });
                if(json.correct) { 
                    document.getElementById('ex-feedback').style.borderColor = "#00ff9d"; 
                    document.getElementById('btn-next-phase').style.display = 'inline-block'; 
                    // è‡ªå‹•è§£é–ä¸‹ä¸€éšæ®µ
                    unlockPhase('posing');
                } 
                else { document.getElementById('ex-feedback').style.borderColor = "#ff3333"; }
            } catch(e) { console.error(e); }
        }
        function finishExercise() { switchPhase('posing'); typeWriterMsg('ai', 'å¤ªæ£’äº†ï¼ç¾åœ¨è©¦è‘—è‡ªå·±å‡ºé¡Œå§ï¼'); }

        // ===============================================
        // Phase 5: Peer Review (Load & Solve)
        // ===============================================
        async function loadPeerProblem() {
            const btn = document.querySelector('#phase-human-review button'); btn.innerText = "é€£ç·šä¸­..."; btn.disabled = true;
            try { 
                const res = await fetch(`${GAS_URL}?studentId=${studentId}&t=${Date.now()}`); 
                const json = await res.json(); 
                if(json.status === 'success') { 
                    const p = json.problem; 
                    document.getElementById('hr-title').innerText = p.title; document.getElementById('hr-desc').innerText = p.desc; 
                    currentPeerRefCode = p.code; currentPeerProblemTitle = p.title; 
                    document.getElementById('human-review-container').style.display = 'block';
                    document.getElementById('hr-stage-1-solve').style.display = 'block'; 
                    document.getElementById('hr-stage-2-grade').style.display = 'none'; 
                    document.getElementById('hr-attempt-editor').value = ""; document.getElementById('hr-attempt-output').innerText = "...";
                    if(json.note) alert(json.note); 
                } else { alert(json.message); } 
            } catch(e) { alert("é€£ç·šå¤±æ•—"); } 
            btn.innerText = "ğŸ“¥ è¼‰å…¥åŒå„•æŒ‘æˆ°"; btn.disabled = false;
        }
        async function runPeerAttempt() { await executePythonCode('hr-attempt-editor', 'hr-attempt-output'); }
        function revealPeerGrading() { if(document.getElementById('hr-attempt-editor').value.trim().length < 5) return alert("è«‹å…ˆè©¦å¯«ä»£ç¢¼ï¼"); document.getElementById('hr-stage-1-solve').style.display = 'none'; document.getElementById('hr-stage-2-grade').style.display = 'block'; document.getElementById('hr-code').innerText = currentPeerRefCode; }
        async function submitHumanReview() {
            const s = [1,2,3,4,5].map(i=>document.getElementById(`hr-s${i}`).value); const c = document.getElementById('hr-comment').value; if(!c) return alert("è«‹å¯«è©•èª");
            await sendToGAS({ type:'PHASE_5_PEER', studentId, targetTitle:currentPeerProblemTitle, scores:s, comment:c }); 
            alert("è©•åˆ†å·²é€å‡º"); document.getElementById('human-review-container').style.display='none'; 
            unlockPhase('reflection'); // è§£é–
            switchPhase('reflection');
        }

        // ===============================================
        // Phase Transitions & AI Scoring Fix
        // ===============================================
        async function finishLearning() {
            if((Date.now()-learningStartTime)/1000 < 5) { stressScore+=20; return typeWriterMsg('ai', 'è®€å¤ªå¿«äº†ï¼è«‹å°ˆå¿ƒçœ‹å®Œå½±ç‰‡ã€‚'); }
            if(ytPlayer && ytPlayer.pauseVideo) ytPlayer.pauseVideo();
            await sendToGAS({ type: 'PHASE_1_LEARNING', studentId, readingTime: readSeconds });
            log('LN',`å®Œæˆ - é–±è®€æ™‚é•·: ${readSeconds}s`); 
            unlockPhase('exercise'); // è§£é–
            switchPhase('exercise');
        }
        async function finishPosing() {
            const t = document.getElementById('pp-title').value; const c = document.getElementById('code-editor').value;
            if(!t) return alert("è«‹å¡«å¯«é¡Œç›®");
            sessionData.probTitle = t; sessionData.probDesc = document.getElementById('pp-desc').value; sessionData.probCode = c;
            
            // â˜…â˜…â˜… è‡ªå‹•æŠ“å–æ•™æåˆ†é¡ (V14.0) â˜…â˜…â˜…
            await sendToGAS({ 
                type: 'PHASE_3_POSING', 
                studentId, 
                probTitle: t, 
                probDesc: sessionData.probDesc, 
                probCode: c,
                unitTitle: window.LESSON_CONFIG.title || "é è¨­æ•™æ"
            });
            
            unlockPhase('ai-review'); // è§£é–
            switchPhase('ai-review'); 
        }
        
        async function triggerAIReview() {
            document.getElementById('ai-result').style.display='block'; document.getElementById('ai-comment-cell').innerText = "AI è©•åˆ†ä¸­...";
            const prompt = `${PROMPT_STRICT_GRADING} é¡Œç›®ï¼š${sessionData.probTitle} æ•˜è¿°ï¼š${sessionData.probDesc} ä»£ç¢¼ï¼š${sessionData.probCode}`;
            try { 
                const r = await safeCallAI(prompt, "You are a JSON generator.", "btn-ai-review"); 
                const json = JSON.parse(extractJSON(r)); 
                sessionData.aiScores = json.scores; sessionData.aiComment = json.comment;
                
                // ä¿®æ­£ï¼šç¢ºä¿ scores æ˜¯é™£åˆ—
                if (Array.isArray(json.scores) && json.scores.length >= 5) {
                    for(let i=0; i<5; i++) {
                        document.getElementById(`ai-s${i+1}`).innerText = json.scores[i];
                    }
                } else {
                    document.getElementById('ai-comment-cell').innerText += " (åˆ†æ•¸æ ¼å¼è§£æéŒ¯èª¤)";
                }

                await sendToGAS({ type: 'PHASE_4_AI', studentId, probTitle: sessionData.probTitle, aiScores: json.scores, aiComment: json.comment });
                
                document.getElementById('ai-comment-cell').innerText = ""; 
                typeWriterText(document.getElementById('ai-comment-cell'), json.comment); 
                
                // AI è©•å®Œåˆ†å¾Œï¼Œè§£é–ä¸‹ä¸€é—œ
                setTimeout(() => {
                    unlockPhase('human-review');
                }, 2000);

            } catch(e) { document.getElementById('ai-comment-cell').innerText = "AI Error: " + e.message; }
        }

        async function submitAll() {
            const r = document.getElementById('rf-content').value; if(!r) return alert("è«‹å¯«åæ€");
            await sendToGAS({ type:'PHASE_6_REFLECTION', studentId, reflection: r });
            alert("å…¨èª²ç¨‹å®Œæˆï¼");
        }

        // ===============================================
        // Core System (Login, Monitor, Chat)
        // ===============================================
        
        // V13.1: èŠå¤©å®¤ç©©å®šæ€§ä¿®å¾© (é™åˆ¶é•·åº¦ & éŒ¯èª¤é™¤éŒ¯ & å‚³é€ä¸Šä¸‹æ–‡)
        async function sendChat() { 
            const v=document.getElementById('chat-input').value; if(!v)return; 
            document.getElementById('chat-msgs').innerHTML+=`<div class="msg user">${v}</div>`; 
            document.getElementById('chat-input').value=""; 
            
            // é™åˆ¶åªå‚³é€æœ€å¾Œ 10 å¥
            if (chatHistory.length > 20) chatHistory = chatHistory.slice(chatHistory.length - 20);
            
            // å°‡æœ¬æ¬¡å•é¡ŒåŠ å…¥æ­·å²
            const userMessage = {role:"user", parts:[{text: `System: ${CUSTOM_CHAT_PROMPT}\nPhase=${currentPhase}\nUser Question: ${v}`}]};
            
            // å‘¼å« AI æ™‚ï¼Œå‚³å…¥å®Œæ•´çš„ chatHistory + æœ¬æ¬¡å•é¡Œ
            const r = await callGeminiChat([...chatHistory, userMessage]); 
            
            typeWriterMsg('ai', r); 
            
            // æ›´æ–°æ­·å²ç´€éŒ„
            chatHistory.push(userMessage);
            chatHistory.push({role:"model", parts:[{text:r}]});
            
            sendToGAS({type:'CHAT_LOG',studentId,userMsg:v,aiMsg:r}); 
        }
        
        // V13.1 ä¿®æ­£ï¼šç›´æ¥å‚³é messages é™£åˆ—
        async function callGeminiChat(messages) { 
            if(!GAS_URL.startsWith("http")) return "API Error: URL Invalid"; 
            try {
                const r = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    body: JSON.stringify({
                        type: 'CALL_GEMINI_CHAT',
                        messages: messages // ç›´æ¥å‚³é€æ•´å€‹é™£åˆ—
                    })
                });
                return (await r.json()).text;
            } catch(e) {
                console.error("Chat Error:", e);
                return "é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            } 
        }
        
        async function callGemini(u,s) { if(!GAS_URL.startsWith("http"))return"API Error"; try{const r=await fetch(GAS_URL,{method:'POST',mode:'cors',body:JSON.stringify({type:'CALL_GEMINI',prompt:s+"\n"+u})});return(await r.json()).text;}catch(e){return"Error";} }
        
        // è¬ä¸€å¡æ­»ï¼Œæ‰‹å‹•é‡ç½® UI
        function forceResetUI() {
            document.querySelectorAll('button').forEach(b => {
                b.disabled = false;
                if(b.innerText.includes("...")) b.innerText = "é‡è©¦";
            });
            alert("ä»‹é¢å·²å¼·åˆ¶é‡ç½®");
        }
        
        function loginSystem() { 
            if(!document.getElementById('student-id-input').value) return alert("è¼¸å…¥å­¸è™Ÿ"); 
            studentId = document.getElementById('student-id-input').value; 
            document.getElementById('display-student-id').innerText = "ID: "+studentId; 
            document.getElementById('login-overlay').style.display='none'; 
            
            // V13.0: ç™»å…¥æ™‚æ¸…é™¤å°è©±æ­·å²
            chatHistory = [];
            
            // â˜…â˜…â˜… V14.0: è‡ªå‹•æ¢å¾©é€²åº¦ â˜…â˜…â˜…
            if (window.restoreStudentProgress) {
                window.restoreStudentProgress(studentId);
            }
            
            // â˜…â˜…â˜… ä¿®æ”¹ï¼šä¸ç›´æ¥å‘¼å« init()ï¼Œè€Œæ˜¯é¡¯ç¤ºç›¸æ©Ÿå•Ÿå‹•è¦†è“‹å±¤ â˜…â˜…â˜…
            document.getElementById('camera-permission-overlay').style.display = 'flex';
        }

        // â˜…â˜…â˜… æ–°å¢ï¼šç”±ä½¿ç”¨è€…é»æ“ŠæŒ‰éˆ•ä¾†è§¸ç™¼ç›¸æ©Ÿæ¬Šé™ â˜…â˜…â˜…
        async function activateCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                document.getElementById('video').srcObject = stream;
                document.getElementById('camera-permission-overlay').style.display = 'none';
                
                // æˆåŠŸå–å¾—æ¬Šé™å¾Œï¼Œæ‰é–‹å§‹åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
                init();
            } catch (e) {
                alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + e.message + "\nè«‹ç¢ºä¿æ‚¨å·²å…è¨±ç€è¦½å™¨ä½¿ç”¨ç›¸æ©Ÿæ¬Šé™ã€‚");
            }
        }
        
        async function init() {
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            
            try { await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)]); isFaceLoaded = true; } catch(e){}
            
            // â˜…â˜…â˜… ä¿®æ”¹ï¼šç§»é™¤é€™è£¡çš„ getUserMediaï¼Œå› ç‚ºåœ¨ activateCamera ä¸­å·²ç¶“åšéäº† â˜…â˜…â˜…
            // try { const s = await navigator.mediaDevices.getUserMedia({ video: {} }); document.getElementById('video').srcObject = s; document.getElementById('video').addEventListener('play', ()=>setInterval(monitorLoop, 1000)); } catch(e){}
            
            // åªéœ€è¦è¨­å®š play ç›£è½
            const videoEl = document.getElementById('video');
            if (videoEl.srcObject) {
                // å¦‚æœå·²ç¶“æœ‰ä¸²æµï¼Œç›´æ¥è¨­å®šç›£è½
                setInterval(monitorLoop, 1000);
            } else {
                videoEl.addEventListener('play', ()=>setInterval(monitorLoop, 1000));
            }

            try { pyodide = await loadPyodide(); } catch(e){}
            document.addEventListener('mousemove', (e) => { if(lastMouseX!==0) mouseDist+=Math.sqrt(Math.pow(e.clientX-lastMouseX,2)+Math.pow(e.clientY-lastMouseY,2)); lastMouseX=e.clientX; lastMouseY=e.clientY; });
            document.addEventListener('keydown', (e)=> { if(e.key==='Backspace') backspaceCount++; });
            setInterval(() => tabSwitchCount=0, 5000); typeWriterMsg('ai', `ä½ å¥½ï¼è«‹é–‹å§‹å­¸ç¿’ã€‚`); learningStartTime = Date.now(); 
        }
        
        // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šæƒ…ç·’èˆ‡å£“åŠ›ä¸Šå‚³è¿´åœˆ â˜…â˜…â˜…
        async function monitorLoop() {
            if(isPaused) return; let emoDelta=0, actDelta=0, status="æ­£å¸¸", statusClass="val";
            if(isFaceLoaded) {
                const det = await faceapi.detectAllFaces(document.getElementById('video'), new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                if(det.length>0) { 
                    faceMissingDuration=0; document.getElementById('face-lock-overlay').style.display='none';
                    const top = Object.entries(det[0].expressions).sort((a,b)=>b[1]-a[1])[0][0]; document.getElementById('emo-val').innerText = top; lastEmotion = top;
                    if(['sad','angry','fearful'].includes(top)) emoDelta+=5; 
                } else { faceMissingDuration++; if(faceMissingDuration>3) document.getElementById('face-lock-overlay').style.display='flex'; }
            }
            if(mouseDist>4000 || backspaceCount>10 || tabSwitchCount>4) { actDelta+=10; status="ç„¦æ…®"; statusClass="val bad"; }
            document.getElementById('act-val').innerText = status; document.getElementById('act-val').className = statusClass;
            stressScore = Math.min(100, Math.max(0, stressScore + emoDelta + actDelta - 2));
            const bar = document.getElementById('stress-bar'); bar.style.width = stressScore+"%"; bar.style.background = stressScore>85?"red":stressScore>50?"orange":"#00ff9d";
            if(stressScore>85) triggerTherapy();
            mouseDist=0; backspaceCount=0;

            // â˜… æ¯ 10 ç§’ä¸Šå‚³ä¸€æ¬¡ç›£æ¸¬æ•¸æ“š â˜…
            const now = Date.now();
            if (now - lastUploadTime > 10000 && window.uploadToFirebase) {
                window.uploadToFirebase({
                    type: 'MONITOR_LOG',
                    studentId: studentId,
                    stress: stressScore,
                    emotion: lastEmotion || "neutral",
                    phase: currentPhase
                });
                lastUploadTime = now;
            }
        }

        function switchPhase(p) { 
            // æª¢æŸ¥æ˜¯å¦è§£é–
            if(!unlockedPhases[p]) return;
            
            tabSwitchCount++; 
            currentPhase=p; 
            
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); 
            document.querySelectorAll('.content-area').forEach(c=>c.classList.remove('active')); 
            
            const idx=phaseOrder.indexOf(p); 
            document.querySelectorAll('.tab-btn')[idx].classList.add('active'); 
            document.querySelectorAll('.content-area')[idx].classList.add('active'); 
            log('NAV',p); 
        }
        
        function unlockPhase(p) {
            unlockedPhases[p] = true;
            const btn = document.getElementById(`tab-${p}`);
            if(btn) btn.classList.remove('locked');
        }

        function typeWriterMsg(r,t) { const box = document.getElementById('chat-msgs'); const div = document.createElement('div'); div.className = `msg ${r} typing-cursor`; box.appendChild(div); let i = 0; const tm = setInterval(()=>{ text = t || ""; div.innerHTML = marked.parse(text.substring(0, i++)); box.scrollTop = 99999; if(i>text.length){ clearInterval(tm); div.classList.remove('typing-cursor'); } }, 20); }
        function typeWriterText(e,t) { let i = 0; const tm = setInterval(()=>{ e.innerHTML = marked.parse(t.substring(0, i++)); if(i>t.length) clearInterval(tm); }, 15); }
        function extractJSON(s) { const a=s.indexOf('{'),b=s.lastIndexOf('}'); return (a!=-1&&b!=-1)?s.substring(a,b+1):"{}"; }
        async function sendToGAS(d) { 
            if(window.uploadToFirebase) window.uploadToFirebase(d); 
            if(GAS_URL.startsWith("http")) await fetch(GAS_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}); 
        }
        function log(t,d) { if(t!=='ACT'&&t!=='CHAT') sendToGAS({type:'LOG',studentId,action:t,detail:d}); }
        function stopTherapy() { document.getElementById('therapy-overlay').style.display='none'; stressScore=40; isPaused=false; }
        
    </script>
</body>
</html>
