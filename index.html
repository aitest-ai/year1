<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç¬¬ä¸€å¹´è¨ˆç•«ï¼šScratch åµŒå…¥èˆ‡è¦–è¦º AI ç³»çµ±</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --primary: #4C97FF; --bg: #e0e0e0; }
        body { margin: 0; display: flex; height: 100vh; font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); overflow: hidden; }

        /* å·¦å´ç›£æ§èˆ‡ AI é¢æ¿ */
        .sidebar { 
            width: 300px; background: white; padding: 10px; 
            display: flex; flex-direction: column; border-right: 1px solid #ccc; z-index: 10;
        }
        .cam-box { 
            width: 100%; height: 180px; background: #000; 
            border-radius: 8px; overflow: hidden; margin-bottom: 10px; border: 3px solid #ff6b6b;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* ç‹€æ…‹æ¢ */
        .status-box { padding: 10px; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; margin-bottom: 10px; }
        .stress-bar-bg { height: 8px; background: #ddd; border-radius: 4px; margin-top: 5px; overflow:hidden; }
        .stress-fill { height: 100%; width: 0%; background: #ff4757; transition: width 0.5s; }

        /* AI èŠå¤©å€ */
        .chat-area { flex: 1; display: flex; flex-direction: column; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 10px; background: #fafafa; font-size: 0.9em; }
        .msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 12px; max-width: 90%; }
        .msg.ai { background: #E6F7FF; color: #333; align-self: flex-start; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; }
        
        .screenshot-btn {
            background: var(--primary); color: white; border: none; padding: 12px; 
            border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 10px;
            display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .screenshot-btn:hover { opacity: 0.9; }
        .screenshot-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* å³å´ï¼šçœŸæ­£çš„ Scratch åµŒå…¥ */
        .scratch-container { flex: 1; position: relative; background: white; }
        iframe { width: 100%; height: 100%; border: none; }

        /* éš±è—çš„ Canvas èˆ‡ Video (ç”¨æ–¼æˆªåœ–è™•ç†) */
        #capture-video { display: none; }
        #capture-canvas { display: none; }

        /* å½ˆçª— */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 999; display: none; 
            justify-content: center; align-items: center; 
        }
        .modal { 
            background: white; width: 400px; padding: 25px; 
            border-radius: 10px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
        }
    </style>
</head>
<body>

    <div id="ai-modal" class="overlay">
        <div class="modal">
            <h2 style="color: #FFAB19;">ğŸ± éœ€è¦å¹«å¿™å—ï¼Ÿ</h2>
            <p>åµæ¸¬åˆ°æ‚¨ä¼¼ä¹æœ‰é»å¡é—œã€‚è¦è®“ AI å¹«æ‚¨çœ‹çœ‹ç¾åœ¨çš„ç©æœ¨å—ï¼Ÿ</p>
            <div style="font-size: 0.8em; color: #666; background: #eee; padding: 8px; border-radius: 5px; margin: 10px 0;">
                â„¹ï¸ é»æ“ŠæŒ‰éˆ•å¾Œï¼Œè«‹åœ¨å½ˆå‡ºçš„è¦–çª—é¸æ“‡ <strong>ã€Œç›®å‰çš„æ¨™ç±¤é ã€</strong> ä»¥å…è¨± AI è§€çœ‹ç•«é¢ã€‚
            </div>
            <button class="screenshot-btn" style="width:100%" onclick="captureScreenAndAnalyze('auto')">
                ğŸ“¸ å¥½ï¼Œè®“ AI çœ‹çœ‹æˆ‘çš„ç©æœ¨
            </button>
            <button class="screenshot-btn" style="width:100%; background:#ccc; margin-top:5px;" onclick="closeModal()">
                æˆ‘è‡ªå·±è©¦è©¦
            </button>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="margin:0 0 10px 0; color:var(--primary);">Scratch AI å¯¦é©—å®¤</h3>
        
        <div class="cam-box"><video id="video" autoplay muted playsinline></video></div>
        <div class="status-box">
            æƒ…ç·’: <strong id="emo-val" style="color:#e67e22">åµæ¸¬ä¸­...</strong>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-fill"></div></div>
        </div>

        <div class="chat-area">
            <div class="chat-msgs" id="chat-box">
                <div class="msg ai">å—¨ï¼å³é‚Šæ˜¯çœŸæ­£çš„ Scratch ç·¨è¼¯å™¨ã€‚å¦‚æœä½ å¡ä½äº†ï¼Œé»æ“Šä¸‹æ–¹çš„æŒ‰éˆ•ï¼Œæˆ‘æœƒå¹«ä½ çœ‹ç•«é¢å–”ï¼</div>
            </div>
        </div>

        <button id="manual-btn" class="screenshot-btn" onclick="captureScreenAndAnalyze('manual')">
            <span>ğŸ‘ï¸</span> AI æˆªåœ–åˆ†æåŠ©æ‰‹
        </button>
    </div>

    <div class="scratch-container">
        <iframe id="scratch-frame" 
            src="https://turbowarp.org/editor?addons=0" 
            allow="autoplay; camera; microphone; display-capture">
        </iframe>
    </div>

    <video id="capture-video" autoplay></video>
    <canvas id="capture-canvas"></canvas>

    <script>
        // ==========================================
        // 1. è¨­å®š API Key (Gemini 1.5 Flash)
        // ==========================================
        const API_KEY = "AIzaSyBXZ7enyD8BdWbuE7lR8V_Akj1KFKucYl0"; // â˜… è«‹å¡«å…¥æ‚¨çš„ API Key â˜…

        // ==========================================
        // 2. æ ¸å¿ƒæŠ€è¡“ï¼šç¹é CORS çš„æˆªåœ–å¤§æ³• (getDisplayMedia)
        // ==========================================
        async function captureScreenAndAnalyze(source) {
            const btn = document.getElementById('manual-btn');
            const originalText = btn.innerHTML;
            
            if(source === 'auto') closeModal();
            
            btn.disabled = true;
            btn.innerHTML = "â³ ç­‰å¾…æˆæ¬Šæˆªåœ–...";

            try {
                // 1. è«‹æ±‚ä½¿ç”¨è€…åˆ†äº«è¢å¹• (é€™æ˜¯å”¯ä¸€èƒ½åˆæ³•æˆªå– iframe çš„æ–¹å¼)
                // è¨­å®š preferCurrentTab å˜—è©¦å¼•å°ä½¿ç”¨è€…é¸é€™å€‹åˆ†é 
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "never" },
                    audio: false,
                    preferCurrentTab: true 
                });

                btn.innerHTML = "ğŸ“¸ æ­£åœ¨æ“·å–ç•«é¢...";

                // 2. å°‡ä¸²æµå°å‘éš±è—çš„ Video å…ƒç´ 
                const videoEl = document.getElementById('capture-video');
                videoEl.srcObject = stream;

                // ç­‰å¾…å½±ç‰‡è¼‰å…¥
                await new Promise((resolve) => videoEl.onloadedmetadata = resolve);
                videoEl.play();

                // 3. ç•«åˆ° Canvas ä¸Š (é€™å°±æ˜¯æˆªåœ–)
                const canvas = document.getElementById('capture-canvas');
                canvas.width = videoEl.videoWidth;
                canvas.height = videoEl.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);

                // 4. åœæ­¢åˆ†äº« (é‡è¦ï¼å¦å‰‡ç€è¦½å™¨æœƒä¸€ç›´é¡¯ç¤ºã€Œæ­£åœ¨åˆ†äº«ç•«é¢ã€)
                stream.getTracks().forEach(track => track.stop());
                videoEl.srcObject = null;

                // 5. å–å¾— Base64 åœ–ç‰‡æ•¸æ“š
                const base64Image = canvas.toDataURL('image/jpeg', 0.8); // ä½¿ç”¨ JPEG å£“ç¸®åŠ å¿«å‚³è¼¸

                // 6. å‚³é€çµ¦ Gemini
                addMsg('user', 'ğŸ“¸ (å·²å‚³é€ç•«é¢æˆªåœ–)');
                btn.innerHTML = "ğŸ¤– AI åˆ†æä¸­...";
                await callGeminiVision(base64Image);

            } catch (err) {
                console.error("æˆªåœ–å¤±æ•—:", err);
                if (err.name === 'NotAllowedError') {
                    addMsg('ai', 'æ‚¨å–æ¶ˆäº†ç•«é¢åˆ†äº«ï¼Œæˆ‘ç„¡æ³•çœ‹åˆ°æ‚¨çš„ç©æœ¨ã€‚');
                } else {
                    addMsg('ai', 'æˆªåœ–ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ==========================================
        // 3. å‘¼å« Gemini Vision API
        // ==========================================
        async function callGeminiVision(base64Data) {
            const cleanBase64 = base64Data.split(',')[1];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            
            const prompt = `
            ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ Scratch ç¨‹å¼è¨­è¨ˆå°å¸«ã€‚
            é€™æ˜¯ä¸€å¼µå­¸ç”Ÿæ­£åœ¨ä½¿ç”¨ Scratch çš„è¢å¹•æˆªåœ–ã€‚
            
            è«‹å°ˆæ³¨æ–¼åœ–ç‰‡ä¸­çš„ã€Œç©æœ¨ç¨‹å¼å€ã€(é€šå¸¸åœ¨ä¸­é–“æˆ–å·¦å´)ã€‚
            1. è¾¨è­˜å­¸ç”Ÿç›®å‰æ‹¼æ¹Šçš„ç©æœ¨é‚è¼¯ã€‚
            2. å¦‚æœç¨‹å¼çœ‹èµ·ä¾†é‚„æ²’å¯«å®Œæˆ–æœ‰éŒ¯èª¤ï¼ˆä¾‹å¦‚åªæœ‰äº‹ä»¶ç©æœ¨ä½†æ²’æœ‰å‹•ä½œï¼‰ï¼Œè«‹çµ¦äºˆã€Œå¼•å°å¼ã€çš„æç¤ºã€‚
            3. ç›¡é‡ç”¨ç©æœ¨çš„é¡è‰²ï¼ˆè—è‰²å‹•ä½œã€é»ƒè‰²äº‹ä»¶ã€æ©˜è‰²æ§åˆ¶ï¼‰ä¾†å¼•å°å­¸ç”Ÿã€‚
            4. è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£è¦ªåˆ‡é¼“å‹µã€‚
            
            (å¦‚æœåœ–ç‰‡ä¸æ¸…æ¥šæˆ–æ²’æœ‰ç©æœ¨ï¼Œè«‹å‘Šè¨´å­¸ç”Ÿä½ æ²’çœ‹æ¸…æ¥š)
            `;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: cleanBase64 } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                if(data.candidates && data.candidates[0].content) {
                    addMsg('ai', data.candidates[0].content.parts[0].text);
                } else {
                    addMsg('ai', 'AI æš«æ™‚ç„¡æ³•å›æ‡‰ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            } catch (e) {
                addMsg('ai', 'é€£ç·šéŒ¯èª¤: ' + e.message);
            }
        }

        function addMsg(role, text) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = marked.parse(text);
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // ==========================================
        // 4. æƒ…ç·’åµæ¸¬èˆ‡å½ˆçª—æ§åˆ¶
        // ==========================================
        let stress = 0;
        function closeModal() { document.getElementById('ai-modal').style.display = 'none'; }

        async function initMonitor() {
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);

            const video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;

            setInterval(async () => {
                const dets = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                if(dets.length) {
                    const exps = dets[0].expressions;
                    const top = Object.keys(exps).reduce((a,b)=>exps[a]>exps[b]?a:b);
                    
                    document.getElementById('emo-val').innerText = top;
                    
                    if(['sad','angry','fearful'].includes(top)) stress += 10;
                    else stress = Math.max(0, stress - 2);

                    document.getElementById('stress-bar').style.width = Math.min(100, stress) + "%";

                    // å£“åŠ›éé«˜ä¸” AI å°šæœªä»‹å…¥æ™‚
                    if(stress > 90) {
                        stress = 0; 
                        document.getElementById('ai-modal').style.display = 'flex';
                    }
                }
            }, 1000);
        }

        initMonitor();
    </script>
</body>
</html>
