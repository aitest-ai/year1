<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç¬¬ä¸€å¹´è¨ˆç•«ï¼šScratch åµŒå…¥èˆ‡è¦–è¦º AI ç³»çµ± (V3 ç©©å®šç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --primary: #4C97FF; --bg: #e0e0e0; }
        body { margin: 0; display: flex; height: 100vh; font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); overflow: hidden; }

        /* å·¦å´ç›£æ§èˆ‡ AI é¢æ¿ */
        .sidebar { 
            width: 320px; background: white; padding: 15px; 
            display: flex; flex-direction: column; border-right: 1px solid #ccc; z-index: 10;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .cam-box { 
            width: 100%; height: 180px; background: #000; 
            border-radius: 8px; overflow: hidden; margin-bottom: 10px; border: 3px solid #ff6b6b;
            position: relative;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .status-box { padding: 10px; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; margin-bottom: 10px; }
        .stress-bar-bg { height: 8px; background: #ddd; border-radius: 4px; margin-top: 5px; overflow:hidden; }
        .stress-fill { height: 100%; width: 0%; background: #ff4757; transition: width 0.5s; }

        .chat-area { flex: 1; display: flex; flex-direction: column; border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #fcfcfc; }
        .chat-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.9em; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 12px; max-width: 90%; line-height: 1.5; word-wrap: break-word; }
        .msg.ai { background: #E6F7FF; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #B3E0FF; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        .screenshot-btn {
            background: var(--primary); color: white; border: none; padding: 12px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; font-size: 1em;
        }
        .screenshot-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .screenshot-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* å³å´ï¼šScratch åµŒå…¥å®¹å™¨ */
        .scratch-container { flex: 1; position: relative; background: white; }
        
        /* é®ç½© */
        .capture-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 50; display: none;
            flex-direction: column; justify-content: center; align-items: center; 
            font-size: 1.2em; color: var(--primary); font-weight: bold;
        }

        /* iframe è¨­å®š */
        iframe { width: 100%; height: 100%; border: none; }

        /* éš±è—æˆªåœ–å…ƒä»¶ */
        #capture-video { display: none; }
        #capture-canvas { display: none; }

        /* å½ˆçª— */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 999; display: none; 
            justify-content: center; align-items: center; 
        }
        .modal { 
            background: white; width: 420px; padding: 30px; 
            border-radius: 12px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.4); 
        }
    </style>
</head>
<body>

    <div id="ai-modal" class="overlay">
        <div class="modal">
            <h2 style="color: #FFAB19; margin-top:0;">ğŸ± é‡åˆ°å›°é›£äº†å—ï¼Ÿ</h2>
            <p style="color:#555;">AI åµæ¸¬åˆ°æ‚¨ä¼¼ä¹æœ‰é»ç„¦æ…®ã€‚è®“æˆ‘å¹«æ‚¨çœ‹çœ‹ç¾åœ¨çš„ç©æœ¨ç¨‹å¼ï¼Œçµ¦ä¸€é»æç¤ºå¥½å—ï¼Ÿ</p>
            
            <div style="font-size: 0.85em; color: #444; background: #eef; padding: 12px; border-radius: 6px; margin: 20px 0; text-align: left; border-left: 4px solid var(--primary);">
                <strong>ğŸ”” æ“ä½œæ­¥é©Ÿï¼š</strong><br>
                1. é»æ“Šä¸‹æ–¹æŒ‰éˆ•ã€‚<br>
                2. åœ¨å½ˆå‡ºçš„è¦–çª—ä¸­ï¼Œé¸æ“‡ <strong>ã€Œç›®å‰çš„æ¨™ç±¤é  (This Tab)ã€</strong>ã€‚<br>
                3. é»æ“Šã€Œåˆ†äº«ã€ã€‚
            </div>
            
            <button class="screenshot-btn" style="width:100%" onclick="captureScreenAndAnalyze('auto')">
                ğŸ“¸ å¥½ï¼Œæˆªåœ–åˆ†æç©æœ¨
            </button>
            <button class="screenshot-btn" style="width:100%; background:#ccc; color:#555; margin-top:10px;" onclick="closeModal()">
                æˆ‘è‡ªå·±å†è©¦è©¦
            </button>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="margin:0 0 15px 0; color:var(--primary); display:flex; align-items:center; gap:10px;">
            <span>ğŸ§©</span> Scratch AI å¯¦é©—å®¤
        </h3>
        
        <div class="cam-box">
            <div style="position:absolute; top:5px; left:5px; color:white; font-size:0.8em; background:rgba(0,0,0,0.5); padding:2px 5px; border-radius:4px;">Face Monitor</div>
            <video id="video" autoplay muted playsinline></video>
        </div>
        <div class="status-box">
            <div style="display:flex; justify-content:space-between;">
                <span>æƒ…ç·’ç‹€æ…‹:</span>
                <strong id="emo-val" style="color:#e67e22">åµæ¸¬ä¸­...</strong>
            </div>
            <div style="margin-top:5px; font-size:0.8em; color:#888;">AI ä»‹å…¥æŒ‡æ¨™ (ç„¦æ…®/æŒ«æŠ˜)</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-fill"></div></div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <span>ğŸ¤– AI è¦–è¦ºåŠ©æ•™</span>
                <span style="font-size:0.8em; opacity:0.8;">Gemini 1.5 Flash</span>
            </div>
            <div class="chat-msgs" id="chat-box">
                <div class="msg ai">
                    å—¨ï¼å³é‚Šæ˜¯ Scratch ç·¨è¼¯å™¨ã€‚<br>
                    å¦‚æœä½ å¡é—œäº†ï¼Œæˆ‘æœƒä¸»å‹•è·³å‡ºä¾†å¹«ä½ çœ‹ç•«é¢å–”ï¼<br>
                    (è¨˜å¾—å…è¨±ç•«é¢åˆ†äº«æ¬Šé™ï¼Œæˆ‘æ‰èƒ½çœ‹åˆ°ç©æœ¨)
                </div>
            </div>
        </div>

        <button id="manual-btn" class="screenshot-btn" onclick="captureScreenAndAnalyze('manual')">
            <span>ğŸ‘ï¸</span> è®“ AI çœ‹ç•«é¢çµ¦å»ºè­°
        </button>
    </div>

    <div class="scratch-container">
        <div id="capture-loading" class="capture-mask">
            <div style="font-size:30px; margin-bottom:10px;">ğŸ“¸</div>
            æ­£åœ¨æˆªå–ç©æœ¨ç•«é¢...
        </div>
        
        <iframe id="scratch-frame" 
            src="https://stretch3.github.io/" 
            allow="autoplay; camera; microphone; display-capture">
        </iframe>
    </div>

    <video id="capture-video" autoplay></video>
    <canvas id="capture-canvas"></canvas>

    <script>
        // ==========================================
        // 1. è¨­å®š API Key (Gemini 1.5 Flash)
        // ==========================================
        const API_KEY = "AIzaSyBXZ7enyD8BdWbuE7lR8V_Akj1KFKucYl0"; // â˜…â˜…â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ API Key â˜…â˜…â˜…

        // ==========================================
        // 2. æ ¸å¿ƒæŠ€è¡“ï¼šç¹é CORS çš„æˆªåœ–å¤§æ³•
        // ==========================================
        async function captureScreenAndAnalyze(source) {
            const btn = document.getElementById('manual-btn');
            const originalText = btn.innerHTML;
            const mask = document.getElementById('capture-loading');
            
            if(source === 'auto') closeModal();
            
            btn.disabled = true;
            btn.innerHTML = "â³ ç­‰å¾…ç•«é¢æˆæ¬Š...";

            try {
                // 1. è«‹æ±‚ä½¿ç”¨è€…åˆ†äº«è¢å¹•
                // preferCurrentTab: true æœƒæç¤ºç€è¦½å™¨è®“ä½¿ç”¨è€…é¸ã€Œé€™å€‹åˆ†é ã€
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "never" },
                    audio: false,
                    preferCurrentTab: true 
                });

                mask.style.display = 'flex'; // é¡¯ç¤ºé®ç½©
                btn.innerHTML = "ğŸ“¸ æˆªåœ–è™•ç†ä¸­...";

                const videoEl = document.getElementById('capture-video');
                videoEl.srcObject = stream;

                // ç­‰å¾…å½±ç‰‡è¼‰å…¥
                await new Promise((resolve) => videoEl.onloadedmetadata = resolve);
                videoEl.play();
                
                // ç­‰å¾… 0.5 ç§’ç¢ºä¿ç•«é¢å®Œæ•´
                await new Promise(r => setTimeout(r, 500));

                // 2. ç•«åˆ° Canvas (æˆªåœ–)
                const canvas = document.getElementById('capture-canvas');
                canvas.width = videoEl.videoWidth;
                canvas.height = videoEl.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);

                // 3. åœæ­¢åˆ†äº« (é‡è¦ï¼ç«‹å³åˆ‡æ–·)
                stream.getTracks().forEach(track => track.stop());
                videoEl.srcObject = null;
                mask.style.display = 'none';

                // 4. å–å¾—åœ–ç‰‡ (Base64 JPEG)
                const base64Image = canvas.toDataURL('image/jpeg', 0.7);

                // 5. å‘¼å« AI
                addMsg('user', 'ğŸ“¸ (å·²å‚³é€ç•«é¢æˆªåœ–)');
                btn.innerHTML = "ğŸ¤– AI åˆ†æä¸­...";
                await callGeminiVision(base64Image);

            } catch (err) {
                console.error("æˆªåœ–å¤±æ•—:", err);
                mask.style.display = 'none';
                if (err.name === 'NotAllowedError') {
                    addMsg('ai', 'âš ï¸ æ‚¨å–æ¶ˆäº†ç•«é¢åˆ†äº«ï¼Œæˆ‘ç„¡æ³•çœ‹åˆ°æ‚¨çš„ç©æœ¨ã€‚è«‹å†è©¦ä¸€æ¬¡ä¸¦é»é¸ã€Œåˆ†äº«ã€ã€‚');
                } else {
                    addMsg('ai', 'âŒ æˆªåœ–ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ==========================================
        // 3. å‘¼å« Gemini Vision API
        // ==========================================
        async function callGeminiVision(base64Data) {
            const cleanBase64 = base64Data.split(',')[1];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            
            const prompt = `
            ä½ æ˜¯ä¸€ä½è¦ªåˆ‡çš„ Scratch ç¨‹å¼è¨­è¨ˆåŠ©æ•™ã€‚
            é€™æ˜¯ä¸€å¼µå­¸ç”Ÿæ­£åœ¨æ“ä½œ Scratch çš„è¢å¹•æˆªåœ–ã€‚
            
            è«‹å°ˆæ³¨è¾¨è­˜ç•«é¢ä¸­çš„ã€Œç©æœ¨ç¨‹å¼å€ã€ï¼š
            1. åˆ†æå­¸ç”Ÿç›®å‰æ‹¼å‡ºçš„ç©æœ¨é‚è¼¯ã€‚
            2. å¦‚æœæ˜¯ç©ºç™½çš„ï¼Œå»ºè­°ä»–å¾ã€Œç•¶ç¶ æ——è¢«é»æ“Šã€é–‹å§‹ã€‚
            3. å¦‚æœæœ‰é‚è¼¯éŒ¯èª¤ï¼ˆä¾‹å¦‚ï¼šç§»å‹•äº†ä½†æ²’æœ‰è¿´åœˆï¼‰ï¼Œè«‹å¼•å°ä»–ã€‚
            4. è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œèªæ°£è¦é¼“å‹µå­¸ç”Ÿï¼Œå­—æ•¸ 100 å­—å…§ã€‚
            
            (å¦‚æœæˆªåœ–ä¸æ¸…æ¥šæˆ–ä¸æ˜¯ Scratch ç•«é¢ï¼Œè«‹å‘Šè¨´å­¸ç”Ÿ)
            `;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: cleanBase64 } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                if(data.candidates && data.candidates[0].content) {
                    addMsg('ai', data.candidates[0].content.parts[0].text);
                } else {
                    addMsg('ai', 'AI æš«æ™‚ç„¡æ³•è¾¨è­˜ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            } catch (e) {
                addMsg('ai', 'API é€£ç·šéŒ¯èª¤: ' + e.message);
            }
        }

        function addMsg(role, text) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = marked.parse(text);
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // ==========================================
        // 4. æƒ…ç·’åµæ¸¬
        // ==========================================
        let stress = 0;
        function closeModal() { document.getElementById('ai-modal').style.display = 'none'; }

        async function initMonitor() {
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
                
                const video = document.getElementById('video');
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;

                setInterval(async () => {
                    const dets = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                    if(dets.length) {
                        const exps = dets[0].expressions;
                        const top = Object.keys(exps).reduce((a,b)=>exps[a]>exps[b]?a:b);
                        
                        const emoMap = {neutral:"å¹³éœ", happy:"é–‹å¿ƒ", sad:"æ²®å–ª", angry:"ç”Ÿæ°£", fearful:"ç„¦æ…®", disgusted:"å­æƒ¡"};
                        document.getElementById('emo-val').innerText = emoMap[top] || top;
                        
                        if(['sad','angry','fearful'].includes(top)) stress += 15;
                        else stress = Math.max(0, stress - 2);

                        document.getElementById('stress-bar').style.width = Math.min(100, stress) + "%";

                        if(stress > 90) {
                            stress = 0; 
                            document.getElementById('ai-modal').style.display = 'flex';
                        }
                    }
                }, 1000);
            } catch(e) {
                console.error("Face API Error:", e);
                addMsg('ai', 'âš ï¸ ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿã€‚');
            }
        }

        initMonitor();
    </script>
</body>
</html>
