<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç¬¬ä¸€å¹´è¨ˆç•«ï¼šé›™ AI æƒ…æ„Ÿé‹ç®—å­¸ç¿’ç³»çµ± (V12 å®Œæ•´åŠŸèƒ½ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { 
            --primary: #4C97FF; --accent: #FFAB19; --danger: #FF5555; 
            --bg: #F0F2F5; --chat-bg: #ffffff;
        }
        body { margin: 0; display: flex; height: 100vh; font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); overflow: hidden; }

        /* å·¦å´ï¼šæƒ…ç·’ç›£æ§ */
        .sidebar { 
            width: 320px; background: white; padding: 15px; 
            display: flex; flex-direction: column; border-right: 1px solid #ccc; 
            z-index: 10; box-shadow: 2px 0 15px rgba(0,0,0,0.05);
        }
        
        .task-card {
            background: #E9F1FC; border-left: 5px solid var(--primary);
            padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9em;
        }

        .cam-wrapper {
            position: relative; width: 100%; height: 180px; 
            background: #000; border-radius: 8px; overflow: hidden; 
            border: 2px solid #ddd; margin-bottom: 5px;
            display: flex; justify-content: center; align-items: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .cam-placeholder { position: absolute; text-align: center; color: #fff; display: none; width: 100%; z-index: 5; }
        .retry-btn { background: var(--primary); border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        .face-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.6); color: white; padding: 5px;
            text-align: center; font-size: 0.8em;
        }

        /* å£“åŠ›å„€è¡¨æ¿ */
        .monitor-panel {
            background: #fff; border: 1px solid #eee; border-radius: 8px;
            padding: 10px; margin-bottom: 10px;
        }
        .metric-row { display: flex; justify-content: space-between; font-size: 0.8em; margin-bottom: 3px; color: #666; }
        .stress-bar-bg { height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .stress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.5s, background 0.5s; }

        /* å³å´ï¼šä¸»ç•«é¢ */
        .main-area { flex: 1; position: relative; display: flex; flex-direction: column; }
        .scratch-frame { flex: 1; width: 100%; border: none; }

        /* åŠ©æ•™ AI (TA) é¢æ¿ - å‡ç´šç‰ˆ */
        .ta-panel {
            height: 300px; background: white; border-top: 1px solid #ccc;
            display: flex; flex-direction: column; padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 20;
        }
        .ta-header { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .ta-chat-box { flex: 1; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 5px; border: 1px solid #eee; font-size: 0.9em; margin-bottom: 5px; }
        
        /* è¨Šæ¯æ¨£å¼ */
        .msg { margin-bottom: 8px; padding: 8px 12px; border-radius: 10px; max-width: 95%; line-height: 1.4; word-wrap: break-word; }
        .msg.ai { background: #E6F7FF; color: #333; align-self: flex-start; border: 1px solid #B3E0FF; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; margin-left: auto; }
        .msg.system { background: #FFF3E0; color: #E65100; text-align: center; font-size: 0.85em; border: 1px solid #FFE0B2; align-self: center; width: 90%; }

        /* è¼¸å…¥å€å¡Š (æ–‡å­— + æˆªåœ–) */
        .ta-input-row { display: flex; gap: 5px; }
        .ta-input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
        .btn-icon { background: #eee; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2em; }
        .btn-icon:hover { background: #ddd; }
        .btn-send { background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .btn-send:hover { background: #357abd; }

        /* æš–å¿ƒ AI å½ˆçª— */
        .empathy-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 9999; display: none;
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .empathy-box {
            background: white; width: 450px; max-height: 80vh; 
            border-radius: 20px; overflow: hidden; display: flex; flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: popIn 0.4s;
            border: 3px solid #FFD180;
        }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        .empathy-header { background: #FFF8E1; padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #FFE0B2; flex-shrink: 0; }
        .avatar-heart { font-size: 3em; animation: beat 1.5s infinite; }
        @keyframes beat { 0%, 100% {transform: scale(1);} 50% {transform: scale(1.1);} }
        .empathy-content { padding: 20px; color: #5D4037; line-height: 1.6; overflow-y: auto; flex: 1; }
        .empathy-actions { padding: 15px; background: #fff; border-top: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; flex-shrink: 0; }
        .btn-comfort { padding: 12px 20px; border-radius: 25px; border: none; cursor: pointer; font-weight: bold; font-size: 1em; transition: 0.2s; }
        .btn-warm { background: #FFAB00; color: white; box-shadow: 0 4px 10px rgba(255, 171, 0, 0.3); }
        .btn-warm:hover { transform: translateY(-2px); }
        .btn-close { background: #f0f0f0; color: #666; }

        #capture-video, #capture-canvas { display: none; }
    </style>
</head>
<body>

    <div id="empathy-modal" class="empathy-modal">
        <div class="empathy-box">
            <div class="empathy-header">
                <div class="avatar-heart">â¤ï¸</div>
                <div>
                    <h2 style="margin:0; color:#F57F17;">æ·±å‘¼å¸...</h2>
                    <small style="color:#F9A825;">æš–å¿ƒå¤¥ä¼´</small>
                </div>
            </div>
            <div class="empathy-content" id="empathy-msg">
                åµæ¸¬åˆ°æ‚¨ä¼¼ä¹æœ‰äº›ç„¦æ…®ï¼Œæ“ä½œæ»‘é¼ å’Œéµç›¤çš„é€Ÿåº¦ä¹Ÿè®Šå¿«äº†ã€‚<br><br>
                å­¸ç¿’ç¨‹å¼æœ‰æ™‚å€™çœŸçš„å¾ˆä»¤äººæŒ«æŠ˜ï¼Œæˆ‘å®Œå…¨ç†è§£ã€‚æˆ‘å€‘ä¸æ€¥ï¼Œå…ˆä¼‘æ¯ä¸€ä¸‹ã€‚å¦‚æœæ‚¨é¡˜æ„ï¼Œå¯ä»¥æŠŠä»»å‹™äº¤çµ¦åŠ©æ•™ AIï¼Œè®“ä»–å¹«æ‚¨æ‰¾æ‰¾å•é¡Œåœ¨å“ªè£¡ï¼Œå¥½å—ï¼Ÿ
            </div>
            <div class="empathy-actions">
                <button class="btn-comfort btn-warm" onclick="handoverToTA()">ğŸ“¸ è«‹åŠ©æ•™å¹«æˆ‘çœ‹ç©æœ¨</button>
                <button class="btn-comfort btn-close" onclick="closeEmpathy()">æ²’äº‹ï¼Œæˆ‘ä¼‘æ¯å¥½äº†</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="margin:0 0 10px 0; color:#333;">ğŸ“ æƒ…ç·’æ„ŸçŸ¥ç³»çµ±</h3>
        
        <div class="task-card">
            <strong>ğŸ¯ æœ¬é€±ä»»å‹™ï¼šè·³èºè²“å’ª</strong><br>
            1. ç©ºç™½éµäº‹ä»¶<br>
            2. Y + 100 (è·³èµ·)<br>
            3. ç­‰å¾… 0.5 ç§’<br>
            4. Y - 100 (è½ä¸‹)
        </div>

        <div class="cam-wrapper">
            <video id="video" autoplay muted playsinline></video>
            <div id="cam-error" class="cam-placeholder">
                âš ï¸ ç›¸æ©Ÿæœªå•Ÿå‹•<br><button class="retry-btn" onclick="initSystem()">é»æ“Šå•Ÿç”¨</button>
            </div>
            <div class="face-overlay">ç‹€æ…‹: <span id="emo-val">åˆå§‹åŒ–ä¸­...</span></div>
        </div>

        <div class="monitor-panel">
            <div class="metric-row"><span>ğŸ˜Ÿ è² é¢è¡¨æƒ…</span><span id="score-face">0%</span></div>
            <div class="metric-row"><span>ğŸ–±ï¸ ç‹‚é»/äº‚å‹•</span><span id="score-mouse">0%</span></div>
            <div class="metric-row"><span>âŒ¨ï¸ éµç›¤ç„¦æ…®</span><span id="score-key">0%</span></div>
            <hr style="border:0; border-top:1px solid #eee; margin:5px 0;">
            <div style="display:flex; justify-content:space-between; font-size:0.9em; font-weight:bold;">
                <span>ç¸½å£“åŠ›æŒ‡æ•¸</span><span id="stress-val">0%</span>
            </div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-fill"></div></div>
        </div>

        <div style="font-size:0.8em; color:#888; margin-top:auto;">
            * å·¦å´ï¼šæƒ…ç·’èˆ‡è¡Œç‚ºåµæ¸¬<br>
            * å³ä¸‹ï¼šé›™åŠŸèƒ½ AI åŠ©æ•™ (æˆªåœ–+å°è©±)
        </div>
    </div>

    <div class="main-area">
        <iframe class="scratch-frame" src="https://stretch3.github.io/" allow="autoplay; camera; microphone; display-capture"></iframe>
        
        <div class="ta-panel">
            <div class="ta-header">
                <span>ğŸ¤– æ™ºèƒ½åŠ©æ•™ (TA)</span>
            </div>
            <div class="ta-chat-box" id="ta-chat">
                <div class="msg ai">å—¨ï¼æˆ‘æ˜¯ä½ çš„ç¨‹å¼åŠ©æ•™ã€‚ä½ å¯ä»¥ç”¨æ‰“å­—çš„å•æˆ‘å•é¡Œï¼Œæˆ–è€…æŒ‰ç›¸æ©ŸæŒ‰éˆ•è®“æˆ‘çœ‹ä½ çš„ç©æœ¨å–”ï¼</div>
            </div>
            <div class="ta-input-row">
                <button class="btn-icon" title="æˆªåœ–åˆ†æ" onclick="captureAndAnalyze('TA_NORMAL')">ğŸ“¸</button>
                <input type="text" id="ta-input" class="ta-input" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter') sendTextChat()">
                <button class="btn-send" onclick="sendTextChat()">é€å‡º</button>
            </div>
        </div>
    </div>

    <video id="capture-video"></video>
    <canvas id="capture-canvas"></canvas>

    <script>
        const API_KEY = "AIzaSyBXZ7enyD8BdWbuE7lR8V_Akj1KFKucYl0"; // â˜…â˜…â˜… è«‹å‹™å¿…å¡«å…¥æ‚¨çš„ API Key â˜…â˜…â˜…

        // ç³»çµ±ç‹€æ…‹èˆ‡å£“åŠ›åƒæ•¸
        let state = {
            stress: 0,
            faceScore: 0,
            mouseScore: 0,
            keyScore: 0,
            isInterventionActive: false,
            // è¡Œç‚ºè¨ˆæ•¸å™¨
            clickCount: 0,
            keyPressCount: 0,
            mousePositions: []
        };

        // ==========================================
        // 1. è¡Œç‚ºåµæ¸¬ (æ»‘é¼ ã€éµç›¤ã€é»æ“Š)
        // ==========================================
        
        // A. æ»‘é¼ ç§»å‹• (åµæ¸¬ç„¡æ„ç¾©äº‚å‹•)
        document.addEventListener('mousemove', (e) => {
            const now = Date.now();
            state.mousePositions.push({x: e.clientX, y: e.clientY, t: now});
            // åªä¿ç•™ 1 ç§’å…§çš„è»Œè·¡
            state.mousePositions = state.mousePositions.filter(p => now - p.t < 1000);
            
            if(state.mousePositions.length > 5) {
                let dist = 0;
                for(let i=1; i<state.mousePositions.length; i++) {
                    const p1 = state.mousePositions[i-1];
                    const p2 = state.mousePositions[i];
                    dist += Math.sqrt(Math.pow(p2.x-p1.x, 2) + Math.pow(p2.y-p1.y, 2));
                }
                // å¦‚æœ 1 ç§’å…§ç§»å‹•è¶…é 2000px (éå¸¸å¿«ä¸”äº‚)
                if(dist > 2000) state.mouseScore = Math.min(100, state.mouseScore + 5);
            }
        });

        // B. é»æ“Šåµæ¸¬ (åµæ¸¬ç‹‚é»)
        document.addEventListener('mousedown', () => {
            state.clickCount++;
        });

        // C. éµç›¤åµæ¸¬ (åµæ¸¬äº‚æŒ‰)
        document.addEventListener('keydown', () => {
            state.keyPressCount++;
        });

        // D. å®šæ™‚è¨ˆç®—è¡Œç‚ºå£“åŠ› (æ¯ç§’)
        setInterval(() => {
            // è¨ˆç®—é»æ“Šé »ç‡
            if(state.clickCount > 3) state.mouseScore = Math.min(100, state.mouseScore + 20); // 1ç§’é»3æ¬¡ä»¥ä¸Š
            else state.mouseScore = Math.max(0, state.mouseScore - 5); // å†·å»

            // è¨ˆç®—æŒ‰éµé »ç‡
            if(state.keyPressCount > 5) state.keyScore = Math.min(100, state.keyScore + 20); // 1ç§’æŒ‰5æ¬¡ä»¥ä¸Š
            else state.keyScore = Math.max(0, state.keyScore - 5); // å†·å»

            // é‡ç½®è¨ˆæ•¸å™¨
            state.clickCount = 0;
            state.keyPressCount = 0;

            // æ›´æ–° UI é¡¯ç¤º
            document.getElementById('score-mouse').innerText = state.mouseScore + "%";
            document.getElementById('score-key').innerText = state.keyScore + "%";

        }, 1000);


        // ==========================================
        // 2. åˆå§‹åŒ–èˆ‡ç›¸æ©Ÿ
        // ==========================================
        window.onload = function() { initSystem(); };

        async function initSystem() {
            const video = document.getElementById('video');
            const errorMsg = document.getElementById('cam-error');
            const emoVal = document.getElementById('emo-val');

            try {
                errorMsg.style.display = 'none';
                emoVal.innerText = "è«‹æ±‚ç›¸æ©Ÿ...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.onloadedmetadata = () => { video.play(); };

                emoVal.innerText = "è¼‰å…¥æ¨¡å‹...";
                await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
                
                emoVal.innerText = "åµæ¸¬ä¸­...";
                startStressLoop();

            } catch(e) {
                console.error(e);
                errorMsg.style.display = 'block';
                emoVal.innerText = "å•Ÿå‹•å¤±æ•—";
            }
        }

        // ==========================================
        // 3. ç¶œåˆå£“åŠ›è¨ˆç®—è¿´åœˆ
        // ==========================================
        function startStressLoop() {
            const video = document.getElementById('video');
            const emoVal = document.getElementById('emo-val');
            
            setInterval(async () => {
                if(video.paused || video.ended || state.isInterventionActive) return;

                // è‡‰éƒ¨è¾¨è­˜
                const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
                const dets = await faceapi.detectAllFaces(video, options).withFaceExpressions();
                
                if(dets.length > 0) {
                    const exps = dets[0].expressions;
                    const top = Object.keys(exps).reduce((a,b)=>exps[a]>exps[b]?a:b);
                    const map = {neutral:"å¹³éœ", happy:"é–‹å¿ƒ", sad:"æ²®å–ª", angry:"ç”Ÿæ°£", fearful:"ç„¦æ…®", disgusted:"å­æƒ¡", surprised:"é©šè¨"};
                    emoVal.innerText = map[top] || top;
                    emoVal.style.color = "#fff";

                    if(['sad', 'angry', 'fearful', 'disgusted'].includes(top)) state.faceScore = Math.min(100, state.faceScore + 10); 
                    else if(top === 'happy') state.faceScore = Math.max(0, state.faceScore - 10); 
                    else state.faceScore = Math.max(0, state.faceScore - 2); 
                } else {
                    emoVal.innerText = "æœªåµæ¸¬åˆ°äººè‡‰";
                    emoVal.style.color = "#FFAB19";
                }
                
                // æ›´æ–°è‡‰éƒ¨ UI
                document.getElementById('score-face').innerText = state.faceScore + "%";

                // â˜… ç¸½å£“åŠ›è¨ˆç®—å…¬å¼ â˜…
                // è¡¨æƒ…(50%) + æ»‘é¼ (30%) + éµç›¤(20%)
                state.stress = Math.floor(
                    (state.faceScore * 0.5) + 
                    (state.mouseScore * 0.3) + 
                    (state.keyScore * 0.2)
                );

                document.getElementById('stress-val').innerText = state.stress + "%";
                const bar = document.getElementById('stress-bar');
                bar.style.width = state.stress + "%";
                
                if(state.stress < 50) bar.style.background = "#4C97FF";
                else if(state.stress < 80) bar.style.background = "#FFAB19";
                else bar.style.background = "#FF5555";

                if(state.stress > 80) triggerEmpathyAI();

            }, 1000);
        }

        // ==========================================
        // 4. AI äº’å‹• (æ–‡å­— + æˆªåœ–)
        // ==========================================
        
        function triggerEmpathyAI() {
            state.isInterventionActive = true;
            state.faceScore = 50; state.mouseScore = 0; state.keyScore = 0;
            document.getElementById('empathy-modal').style.display = 'flex';
        }

        function closeEmpathy() {
            document.getElementById('empathy-modal').style.display = 'none';
            setTimeout(() => { state.isInterventionActive = false; }, 5000);
        }

        function handoverToTA() {
            document.getElementById('empathy-modal').style.display = 'none';
            const taBox = document.getElementById('ta-chat');
            taBox.innerHTML += `<div class="msg system">â¤ï¸ æš–å¿ƒå¤¥ä¼´å·²å°‡ä»»å‹™è½‰äº¤çµ¦åŠ©æ•™...</div>`;
            captureAndAnalyze('TA_STRESSED');
            setTimeout(() => { state.isInterventionActive = false; }, 5000);
        }

        // --- æ–‡å­—å°è©±åŠŸèƒ½ ---
        async function sendTextChat() {
            const input = document.getElementById('ta-input');
            const val = input.value.trim();
            if(!val) return;

            const taBox = document.getElementById('ta-chat');
            taBox.innerHTML += `<div class="msg user">${val}</div>`;
            taBox.scrollTop = taBox.scrollHeight;
            input.value = "";

            // å‘¼å« AI (æ–‡å­—æ¨¡å¼)
            await callGeminiText(val);
        }

        // --- æˆªåœ–å°è©±åŠŸèƒ½ ---
        async function captureAndAnalyze(mode) {
            const taBox = document.getElementById('ta-chat');
            if(mode.includes('TA')) {
                taBox.innerHTML += `<div class="msg user">ğŸ“¸ æ­£åœ¨æˆªåœ–...</div>`;
            }

            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "never" }, audio: false, preferCurrentTab: true
                });
                const videoEl = document.getElementById('capture-video');
                videoEl.srcObject = stream;
                await new Promise(r => videoEl.onloadedmetadata = r);
                videoEl.play();
                await new Promise(r => setTimeout(r, 500)); 

                const canvas = document.getElementById('capture-canvas');
                canvas.width = videoEl.videoWidth; canvas.height = videoEl.videoHeight;
                canvas.getContext('2d').drawImage(videoEl, 0, 0);
                stream.getTracks().forEach(t => t.stop()); 
                const base64 = canvas.toDataURL('image/jpeg', 0.7);

                await callGeminiVision(mode, base64);

            } catch(e) {
                if(mode.includes('TA')) taBox.innerHTML += `<div class="msg ai">âš ï¸ æˆªåœ–å¤±æ•—ï¼Œè«‹æŒ‰ã€Œåˆ†äº«ã€ã€‚</div>`;
            }
        }

        // --- Gemini API (æ–‡å­—ç‰ˆ) ---
        async function callGeminiText(userText) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
            const taBox = document.getElementById('ta-chat');
            
            const prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ Scratch ç¨‹å¼åŠ©æ•™ã€‚å­¸ç”Ÿå•ï¼š${userText}ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ç°¡çŸ­å›ç­”ï¼Œå¼•å°å­¸ç”Ÿæ€è€ƒï¼Œä¸è¦ç›´æ¥çµ¦å®Œæ•´ç¨‹å¼ç¢¼ã€‚`;

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                taBox.innerHTML += `<div class="msg ai">${marked.parse(reply)}</div>`;
                taBox.scrollTop = taBox.scrollHeight;
            } catch(e) {
                taBox.innerHTML += `<div class="msg ai">é€£ç·šéŒ¯èª¤ã€‚</div>`;
            }
        }

        // --- Gemini API (è¦–è¦ºç‰ˆ) ---
        async function callGeminiVision(mode, image64) {
            const cleanBase64 = image64.split(',')[1];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            const taBox = document.getElementById('ta-chat');

            let systemPrompt = "";
            if (mode === 'TA_STRESSED') {
                systemPrompt = `ä½ æ˜¯ä¸€ä½ Scratch åŠ©æ•™ã€‚å­¸ç”Ÿå‰›å‰›ç¶“æ­·æŒ«æŠ˜ï¼Œè«‹ç”¨"æ¥µåº¦æº«æŸ”"çš„èªæ°£ã€‚è«‹çœ‹æˆªåœ–(å¿½ç•¥å·¦å³å´ï¼Œå°ˆæ³¨ä¸­é–“ç©æœ¨å€)ï¼Œæª¢æŸ¥è·³èºè²“å’ªä»»å‹™(ç©ºç™½éµ->Y+100->ç­‰å¾…->Y-100)æ˜¯å¦æœ‰éŒ¯ï¼Ÿçµ¦å‡ºä¸€å€‹ç°¡å–®å»ºè­°å³å¯ã€‚`;
            } else {
                systemPrompt = `ä½ æ˜¯ä¸€ä½ Scratch åŠ©æ•™ã€‚è«‹çœ‹æˆªåœ–(å°ˆæ³¨ä¸­é–“ç©æœ¨å€)ï¼Œæª¢æŸ¥ç¨‹å¼é‚è¼¯æ˜¯å¦ç¬¦åˆä»»å‹™(è·³èºè²“å’ª)ã€‚è«‹æŒ‡å‡ºå•é¡Œä¸¦çµ¦äºˆæç¤ºã€‚`;
            }

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: systemPrompt },
                                { inlineData: { mimeType: "image/jpeg", data: cleanBase64 } }
                            ]
                        }]
                    })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                taBox.innerHTML += `<div class="msg ai">${marked.parse(reply)}</div>`;
                taBox.scrollTop = taBox.scrollHeight;
            } catch(e) {
                taBox.innerHTML += `<div class="msg ai">é€£ç·šéŒ¯èª¤ã€‚</div>`;
            }
        }
    </script>
</body>
</html>
