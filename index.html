<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç¬¬ä¸€å¹´è¨ˆç•«ï¼šScratch åµŒå…¥èˆ‡è¦–è¦º AI ç³»çµ± (ä¿®æ­£ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root { --primary: #4C97FF; --bg: #e0e0e0; }
        body { margin: 0; display: flex; height: 100vh; font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); overflow: hidden; }

        /* å·¦å´ç›£æ§èˆ‡ AI é¢æ¿ */
        .sidebar { 
            width: 320px; background: white; padding: 15px; 
            display: flex; flex-direction: column; border-right: 1px solid #ccc; z-index: 10;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .cam-box { 
            width: 100%; height: 180px; background: #000; 
            border-radius: 8px; overflow: hidden; margin-bottom: 10px; border: 3px solid #ff6b6b;
            position: relative;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* ç‹€æ…‹æ¢ */
        .status-box { padding: 10px; background: #f5f5f5; border-radius: 8px; font-size: 0.9em; margin-bottom: 10px; }
        .stress-bar-bg { height: 8px; background: #ddd; border-radius: 4px; margin-top: 5px; overflow:hidden; }
        .stress-fill { height: 100%; width: 0%; background: #ff4757; transition: width 0.5s; }

        /* AI èŠå¤©å€ */
        .chat-area { flex: 1; display: flex; flex-direction: column; border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: #fcfcfc; }
        .chat-header { background: var(--primary); color: white; padding: 10px; font-weight: bold; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.9em; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 12px; max-width: 90%; line-height: 1.5; word-wrap: break-word; }
        .msg.ai { background: #E6F7FF; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #B3E0FF; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        .screenshot-btn {
            background: var(--primary); color: white; border: none; padding: 12px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; font-size: 1em;
        }
        .screenshot-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .screenshot-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* å³å´ï¼šçœŸæ­£çš„ Scratch åµŒå…¥ */
        .scratch-container { flex: 1; position: relative; background: white; }
        
        /* é®ç½©ï¼šç•¶æ­£åœ¨æˆªåœ–æ™‚é¡¯ç¤ºï¼Œé¿å…ç•«é¢é–ƒçˆ */
        .capture-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 50; display: none;
            justify-content: center; align-items: center; font-size: 1.5em; color: var(--primary);
        }

        /* é€™è£¡æ”¹ç”¨ Scratch å®˜æ–¹é–‹ç™¼ç‰ˆé¡åƒï¼Œé€šå¸¸å…è¨±åµŒå…¥ */
        iframe { width: 100%; height: 100%; border: none; }

        /* éš±è—çš„ Canvas èˆ‡ Video (ç”¨æ–¼æˆªåœ–è™•ç†) */
        #capture-video { display: none; }
        #capture-canvas { display: none; }

        /* å½ˆçª— */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 999; display: none; 
            justify-content: center; align-items: center; 
        }
        .modal { 
            background: white; width: 420px; padding: 30px; 
            border-radius: 12px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.4); 
        }
    </style>
</head>
<body>

    <div id="ai-modal" class="overlay">
        <div class="modal">
            <h2 style="color: #FFAB19; margin-top:0;">ğŸ± éœ€è¦å¹«å¿™å—ï¼Ÿ</h2>
            <p style="color:#555;">åµæ¸¬åˆ°æ‚¨ä¼¼ä¹æœ‰é»ç„¦æ…®ã€‚è®“ AI å¹«æ‚¨çœ‹çœ‹ç¾åœ¨çš„ç©æœ¨ç¨‹å¼ï¼Œçµ¦ä¸€é»æç¤ºå¥½å—ï¼Ÿ</p>
            
            <div style="font-size: 0.85em; color: #444; background: #eef; padding: 12px; border-radius: 6px; margin: 20px 0; text-align: left; border-left: 4px solid var(--primary);">
                <strong>ğŸ”” æ“ä½œèªªæ˜ï¼š</strong><br>
                1. é»æ“Šä¸‹æ–¹æŒ‰éˆ•ã€‚<br>
                2. ç€è¦½å™¨æœƒå½ˆå‡ºè©¢å•è¦–çª—ã€‚<br>
                3. è«‹é¸æ“‡ <strong>ã€Œç›®å‰çš„æ¨™ç±¤é  (This Tab)ã€</strong> ä¸¦é»æ“Šã€Œåˆ†äº«ã€ã€‚
            </div>
            
            <button class="screenshot-btn" style="width:100%" onclick="captureScreenAndAnalyze('auto')">
                ğŸ“¸ å¥½ï¼Œæˆªåœ–åˆ†æç©æœ¨
            </button>
            <button class="screenshot-btn" style="width:100%; background:#ccc; color:#555; margin-top:10px;" onclick="closeModal()">
                æˆ‘è‡ªå·±å†è©¦è©¦
            </button>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="margin:0 0 15px 0; color:var(--primary); display:flex; align-items:center; gap:10px;">
            <span>ğŸ§©</span> Scratch AI å¯¦é©—å®¤
        </h3>
        
        <div class="cam-box">
            <div style="position:absolute; top:5px; left:5px; color:white; font-size:0.8em; background:rgba(0,0,0,0.5); padding:2px 5px; border-radius:4px;">Face Monitor</div>
            <video id="video" autoplay muted playsinline></video>
        </div>
        <div class="status-box">
            <div style="display:flex; justify-content:space-between;">
                <span>æƒ…ç·’ç‹€æ…‹:</span>
                <strong id="emo-val" style="color:#e67e22">åµæ¸¬ä¸­...</strong>
            </div>
            <div style="margin-top:5px; font-size:0.8em; color:#888;">AI ä»‹å…¥æŒ‡æ¨™ (ç„¦æ…®/æŒ«æŠ˜)</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-fill"></div></div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <span>ğŸ¤– AI è¦–è¦ºåŠ©æ•™</span>
                <span style="font-size:0.8em; opacity:0.8;">Gemini 1.5 Flash</span>
            </div>
            <div class="chat-msgs" id="chat-box">
                <div class="msg ai">å—¨ï¼å³é‚Šæ˜¯ Scratch ç·¨è¼¯å™¨ã€‚<br>å¦‚æœä½ å¡é—œäº†ï¼Œæˆ‘æœƒä¸»å‹•è·³å‡ºä¾†å¹«ä½ çœ‹ç•«é¢å–”ï¼ä½ ä¹Ÿå¯ä»¥éš¨æ™‚æŒ‰ä¸‹é¢çš„æŒ‰éˆ•å‘¼å«æˆ‘ã€‚</div>
            </div>
        </div>

        <button id="manual-btn" class="screenshot-btn" onclick="captureScreenAndAnalyze('manual')">
            <span>ğŸ‘ï¸</span> è®“ AI çœ‹ç•«é¢çµ¦å»ºè­°
        </button>
    </div>

    <div class="scratch-container">
        <div id="capture-loading" class="capture-mask">ğŸ“¸ æ­£åœ¨æ“·å–ç•«é¢...</div>
        
        <iframe id="scratch-frame" 
            src="https://llk.github.io/scratch-gui/develop/" 
            allow="autoplay; camera; microphone; display-capture">
        </iframe>
    </div>

    <video id="capture-video" autoplay></video>
    <canvas id="capture-canvas"></canvas>

    <script>
        // ==========================================
        // 1. è¨­å®š API Key (Gemini 1.5 Flash)
        // ==========================================
        const API_KEY = "AIzaSyBXZ7enyD8BdWbuE7lR8V_Akj1KFKucYl0"; // â˜…â˜…â˜… è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ API Key â˜…â˜…â˜…

        // ==========================================
        // 2. æ ¸å¿ƒæŠ€è¡“ï¼šç¹é CORS çš„æˆªåœ–å¤§æ³• (getDisplayMedia)
        // ==========================================
        async function captureScreenAndAnalyze(source) {
            const btn = document.getElementById('manual-btn');
            const originalText = btn.innerHTML;
            const mask = document.getElementById('capture-loading');
            
            if(source === 'auto') closeModal();
            
            btn.disabled = true;
            btn.innerHTML = "â³ ç­‰å¾…ç•«é¢æˆæ¬Š...";

            try {
                // 1. è«‹æ±‚ä½¿ç”¨è€…åˆ†äº«è¢å¹•
                // é€™æ˜¯ç›®å‰å”¯ä¸€èƒ½åˆæ³•æˆªå–è·¨åŸŸ iframe çš„æ–¹å¼
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "never" },
                    audio: false,
                    preferCurrentTab: true // æç¤ºç€è¦½å™¨å„ªå…ˆé¡¯ç¤ºç•¶å‰åˆ†é é¸é …
                });

                mask.style.display = 'flex'; // é¡¯ç¤ºé®ç½©ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“æ­£åœ¨è™•ç†
                btn.innerHTML = "ğŸ“¸ è™•ç†ä¸­...";

                // 2. å°‡ä¸²æµå°å‘éš±è—çš„ Video å…ƒç´ 
                const videoEl = document.getElementById('capture-video');
                videoEl.srcObject = stream;

                // ç­‰å¾…å½±ç‰‡è¼‰å…¥
                await new Promise((resolve) => videoEl.onloadedmetadata = resolve);
                videoEl.play();
                
                // ç¨å¾®ç­‰å¾…ä¸€ä¸‹ç¢ºä¿ç•«é¢æ¸²æŸ“å®Œæˆ (0.5ç§’)
                await new Promise(r => setTimeout(r, 500));

                // 3. ç•«åˆ° Canvas ä¸Š (æˆªåœ–)
                const canvas = document.getElementById('capture-canvas');
                canvas.width = videoEl.videoWidth;
                canvas.height = videoEl.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);

                // 4. åœæ­¢åˆ†äº« (é‡è¦ï¼ç«‹å³åˆ‡æ–·éŒ„å½±)
                stream.getTracks().forEach(track => track.stop());
                videoEl.srcObject = null;
                mask.style.display = 'none';

                // 5. å–å¾— Base64 åœ–ç‰‡æ•¸æ“š (JPEG æ ¼å¼)
                const base64Image = canvas.toDataURL('image/jpeg', 0.7);

                // 6. å‚³é€çµ¦ Gemini
                addMsg('user', 'ğŸ“¸ (å·²å‚³é€ç•«é¢æˆªåœ–)');
                btn.innerHTML = "ğŸ¤– AI åˆ†æä¸­...";
                await callGeminiVision(base64Image);

            } catch (err) {
                console.error("æˆªåœ–å¤±æ•—:", err);
                mask.style.display = 'none';
                if (err.name === 'NotAllowedError') {
                    addMsg('ai', 'âš ï¸ æ‚¨å–æ¶ˆäº†ç•«é¢åˆ†äº«ï¼Œæˆ‘ç„¡æ³•çœ‹åˆ°æ‚¨çš„ç©æœ¨ã€‚è«‹å†è©¦ä¸€æ¬¡ä¸¦é¸æ“‡ã€Œåˆ†äº«ã€ã€‚');
                } else {
                    addMsg('ai', 'âŒ æˆªåœ–ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // ==========================================
        // 3. å‘¼å« Gemini Vision API
        // ==========================================
        async function callGeminiVision(base64Data) {
            const cleanBase64 = base64Data.split(',')[1];
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
            
            const prompt = `
            ä½ ç¾åœ¨æ˜¯ä¸€ä½è¦ªåˆ‡çš„ Scratch ç¨‹å¼è¨­è¨ˆè€å¸«ã€‚
            é€™æ˜¯ä¸€å¼µå­¸ç”Ÿè¢å¹•çš„æˆªåœ–ï¼Œç•«é¢ä¸­åŒ…å«äº† Scratch çš„ç·¨è¼¯å™¨ä»‹é¢ã€‚
            
            ä»»å‹™ï¼š
            1. è«‹ä»”ç´°è§€å¯Ÿç•«é¢ä¸­å¤®æˆ–å·¦å´çš„ã€Œç©æœ¨ç¨‹å¼å€ã€ã€‚
            2. è¾¨è­˜å­¸ç”Ÿç›®å‰æ‹¼å‡ºçš„ç©æœ¨é‚è¼¯æ˜¯ä»€éº¼ï¼Ÿ(ä¾‹å¦‚ï¼šè²“å’ªç§»å‹•ã€è¿´åœˆæ§åˆ¶ç­‰)
            3. å¦‚æœç¨‹å¼çœ‹èµ·ä¾†æ˜¯ç©ºçš„ï¼Œè«‹å»ºè­°å­¸ç”Ÿå¾ã€Œäº‹ä»¶ã€(é»ƒè‰²) é¡åˆ¥é–‹å§‹ï¼Œæ‹‰å‡ºã€Œç•¶ç¶ æ——è¢«é»æ“Šã€ã€‚
            4. å¦‚æœæœ‰æ˜é¡¯é‚è¼¯éŒ¯èª¤(ä¾‹å¦‚åªæœ‰ç§»å‹•æ²’æœ‰è¿´åœˆ)ï¼Œè«‹ç”¨å¼•å°çš„æ–¹å¼æç¤ºä»–ï¼Œç›¡é‡æåˆ°ç©æœ¨çš„é¡è‰²(è—è‰²å‹•ä½œã€æ©˜è‰²æ§åˆ¶)ã€‚
            5. è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œå­—æ•¸æ§åˆ¶åœ¨ 100 å­—ä»¥å…§ï¼Œèªæ°£è¦é¼“å‹µå­¸ç”Ÿã€‚
            
            (å¦‚æœç•«é¢å¤ªæ¨¡ç³Šæˆ–çœ‹ä¸åˆ°ç©æœ¨ï¼Œè«‹èª å¯¦å‘ŠçŸ¥)
            `;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: "image/jpeg", data: cleanBase64 } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                if(data.candidates && data.candidates[0].content) {
                    addMsg('ai', data.candidates[0].content.parts[0].text);
                } else {
                    addMsg('ai', 'AI æš«æ™‚ç„¡æ³•è¾¨è­˜å›æ‡‰ï¼Œè«‹ç¢ºèª API Key æ˜¯å¦æ­£ç¢ºã€‚');
                }
            } catch (e) {
                addMsg('ai', 'é€£ç·šéŒ¯èª¤: ' + e.message);
            }
        }

        function addMsg(role, text) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = marked.parse(text);
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        // ==========================================
        // 4. æƒ…ç·’åµæ¸¬èˆ‡å½ˆçª—æ§åˆ¶
        // ==========================================
        let stress = 0;
        function closeModal() { document.getElementById('ai-modal').style.display = 'none'; }

        async function initMonitor() {
            const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            try {
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
                
                const video = document.getElementById('video');
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;

                setInterval(async () => {
                    const dets = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                    if(dets.length) {
                        const exps = dets[0].expressions;
                        const top = Object.keys(exps).reduce((a,b)=>exps[a]>exps[b]?a:b);
                        
                        const emoMap = {neutral:"å¹³éœ", happy:"é–‹å¿ƒ", sad:"æ²®å–ª", angry:"ç”Ÿæ°£", fearful:"ç„¦æ…®", disgusted:"å­æƒ¡", surprised:"é©šè¨"};
                        document.getElementById('emo-val').innerText = emoMap[top] || top;
                        
                        // å£“åŠ›ç´¯ç©é‚è¼¯
                        if(['sad','angry','fearful'].includes(top)) stress += 15;
                        else stress = Math.max(0, stress - 2);

                        document.getElementById('stress-bar').style.width = Math.min(100, stress) + "%";

                        // å£“åŠ›éé«˜ä¸” AI å°šæœªä»‹å…¥æ™‚
                        if(stress > 90) {
                            stress = 0; 
                            document.getElementById('ai-modal').style.display = 'flex';
                        }
                    }
                }, 1000); // æ¯ç§’åµæ¸¬ä¸€æ¬¡
            } catch(e) {
                console.error("Face API Error:", e);
                addMsg('ai', 'âš ï¸ ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿï¼Œæƒ…ç·’åµæ¸¬åŠŸèƒ½æš«åœã€‚');
            }
        }

        initMonitor();
    </script>
</body>
</html>
