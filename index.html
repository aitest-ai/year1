<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI Scratch å­¸ç¿’ç³»çµ± (å®Œæ•´æ¨¡æ“¬ç‰ˆ)</title>
    
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed.js"></script> <script src="https://unpkg.com/blockly/javascript_compressed.js"></script> <script src="https://unpkg.com/blockly/msg/zh-hant.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Scratch 3.0 è‰²ç¥¨èˆ‡é¢¨æ ¼ */
        :root {
            --motion: #4C97FF; --looks: #9966FF; --sound: #CF63CF;
            --events: #FFBF00; --control: #FFAB19; --sensing: #5CB1D6;
            --operators: #59C059; --variables: #FF8C1A; --myblocks: #FF6680;
            --stage-bg: #fff; --ui-bg: #E9F1FC;
        }

        body { margin: 0; display: flex; height: 100vh; font-family: "Helvetica Neue", sans-serif; background: var(--ui-bg); overflow: hidden; }

        /* å·¦å´ï¼šæƒ…ç·’ç›£æ§ */
        .sidebar { width: 240px; background: #fff; border-right: 1px solid #ccc; padding: 10px; display: flex; flex-direction: column; z-index: 2; }
        .cam-box { width: 100%; height: 160px; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px; border: 3px solid #ddd; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .status-panel { font-size: 0.85em; color: #555; background: #f0f0f0; padding: 10px; border-radius: 8px; }
        .stress-bar-bg { height: 6px; background: #ccc; border-radius: 3px; margin-top: 5px; }
        .stress-fill { height: 100%; width: 0%; background: #FF5555; transition: width 0.5s; }

        /* ä¸­é–“ï¼šç©æœ¨å€ */
        .workspace { flex: 1; position: relative; }
        #blocklyDiv { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }

        /* å³å´ï¼šèˆå°èˆ‡ AI */
        .stage-area { width: 420px; background: #fff; border-left: 1px solid #ccc; display: flex; flex-direction: column; padding: 10px; }
        
        /* èˆå°é è¦½ (480x360 æ¯”ä¾‹) */
        .stage-container {
            width: 400px; height: 300px;
            background: #fff; border: 2px solid #ccc; border-radius: 10px;
            position: relative; overflow: hidden; margin: 0 auto;
            background-image: url('https://raw.githubusercontent.com/LLK/scratch-gui/develop/src/lib/assets/stage-background.png'); /* ç¶²æ ¼èƒŒæ™¯ */
            background-size: cover;
        }
        .sprite {
            width: 60px; height: 60px;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/2/22/Scratch_Cat_2023.svg'); /* Scratch è²“ */
            background-size: contain; background-repeat: no-repeat;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); transition: top 0.1s, left 0.1s, transform 0.1s;
        }
        /* æ°£æ³¡å°è©±æ¡† */
        .bubble {
            position: absolute; background: white; border: 2px solid #333; border-radius: 10px;
            padding: 5px 10px; font-size: 12px; white-space: nowrap; display: none; z-index: 10;
        }

        /* æ§åˆ¶æŒ‰éˆ• */
        .controls { display: flex; gap: 10px; margin: 10px 0; justify-content: center; }
        .flag-btn { cursor: pointer; font-size: 24px; filter: grayscale(0.2); transition: 0.2s; }
        .flag-btn:hover { filter: grayscale(0); transform: scale(1.1); }
        
        /* AI å°è©±è¦–çª— */
        .ai-chat { flex: 1; border: 1px solid #ddd; border-radius: 8px; display: flex; flex-direction: column; background: #f9f9f9; overflow: hidden; }
        .ai-header { background: var(--motion); color: white; padding: 8px; font-weight: bold; font-size: 0.9em; display: flex; justify-content: space-between; }
        .chat-history { flex: 1; padding: 10px; overflow-y: auto; font-size: 0.9em; }
        .msg { padding: 8px 12px; margin-bottom: 8px; border-radius: 12px; max-width: 90%; line-height: 1.4; }
        .msg.ai { background: #E6F7FF; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.user { background: var(--motion); color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .chat-input { display: flex; padding: 5px; border-top: 1px solid #ddd; background: white; }
        .chat-input input { flex: 1; border: 1px solid #ccc; padding: 8px; border-radius: 20px; outline: none; }
        .chat-input button { background: var(--motion); color: white; border: none; padding: 0 15px; border-radius: 20px; margin-left: 5px; cursor: pointer; }

        /* æ¼¸é€²å¼æç¤ºå½ˆçª— */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; justify-content: center; align-items: center; }
        .modal { background: white; width: 450px; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: pop 0.3s; }
        @keyframes pop { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
    </style>
</head>
<body>

    <div id="hint-overlay" class="overlay">
        <div class="modal">
            <h2 style="color: var(--control);">ğŸ± é‡åˆ°å›°é›£äº†å—ï¼Ÿ</h2>
            <p style="color:#666;">AI åµæ¸¬åˆ°æ‚¨ä¼¼ä¹æœ‰é»ç„¦æ…®ã€‚éœ€è¦æˆ‘å¹«æ‚¨çœ‹çœ‹ç›®å‰çš„ç¨‹å¼ç©æœ¨ï¼Œçµ¦ä¸€é»æç¤ºå—ï¼Ÿ</p>
            <div id="ai-hint-content" style="background:#fff3cd; padding:15px; border-radius:8px; margin:15px 0; text-align:left; font-size:0.9em; min-height:50px;">
                (é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼ŒAI å°‡è®€å–æ‚¨çš„ç©æœ¨é‚è¼¯...)
            </div>
            <button onclick="getAIHelp('hint')" style="background:var(--motion); color:white; border:none; padding:10px 20px; border-radius:20px; cursor:pointer;">ğŸ” åˆ†æç©æœ¨çµ¦æç¤º</button>
            <button onclick="document.getElementById('hint-overlay').style.display='none'" style="background:#ccc; border:none; padding:10px 20px; border-radius:20px; cursor:pointer; margin-left:10px;">æˆ‘è‡ªå·±è©¦è©¦</button>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="color:var(--motion); margin:0 0 10px 0;">Scratch AI</h3>
        <div class="cam-box"><video id="video" autoplay muted playsinline></video></div>
        <div class="status-panel">
            <div>æƒ…ç·’: <strong id="emo-val" style="color:var(--control)">åµæ¸¬ä¸­...</strong></div>
            <div style="margin-top:8px;">ç„¦æ…®æŒ‡æ•¸ (AI ä»‹å…¥):</div>
            <div class="stress-bar-bg"><div id="stress-bar" class="stress-fill"></div></div>
        </div>
        <div style="margin-top:20px; font-size:0.85em; color:#666; background:#fff9e6; padding:10px; border-radius:5px; border:1px solid #ffe082;">
            <strong>æœ¬é€±ä»»å‹™ï¼š</strong><br>
            è®“è²“å’ªåœ¨èˆå°ä¸Šä¸€ç›´èµ°å‹•ï¼Œç¢°åˆ°é‚Šç·£å°±åå½ˆã€‚
        </div>
    </div>

    <div class="workspace">
        <div id="blocklyDiv"></div>
    </div>

    <div class="stage-area">
        <div class="stage-container" id="stage">
            <div id="sprite" class="sprite"><div id="sprite-bubble" class="bubble">Hello!</div></div>
        </div>
        
        <div class="controls">
            <div class="flag-btn" onclick="runCode()">ğŸ</div> <div class="flag-btn" onclick="stopCode()">ğŸ›‘</div> </div>

        <div class="ai-chat">
            <div class="ai-header">
                <span>ğŸ¤– AI åŠ©æ•™ (Gemini 1.5 Flash)</span>
                <span id="api-status" style="font-size:0.8em; opacity:0.8;">â— é€£ç·šå°±ç·’</span>
            </div>
            <div class="chat-history" id="chat-msgs">
                <div class="msg ai">å—¨ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ•™ã€‚æˆ‘æœƒçœ‹ä½ æ‹¼çš„ç©æœ¨å–”ï¼å¦‚æœæœ‰å•é¡Œå¯ä»¥ç›´æ¥å•æˆ‘ã€‚</div>
            </div>
            <div class="chat-input">
                <input id="user-input" placeholder="å•å•é¡Œ..." onkeypress="if(event.key==='Enter') sendChat()">
                <button onclick="sendChat()">é€å‡º</button>
            </div>
        </div>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="å‹•ä½œ" colour="#4C97FF">
            <block type="motion_movesteps"><value name="STEPS"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
            <block type="motion_turnright"><value name="DEGREES"><shadow type="math_number"><field name="NUM">15</field></shadow></value></block>
            <block type="motion_turnleft"><value name="DEGREES"><shadow type="math_number"><field name="NUM">15</field></shadow></value></block>
            <block type="motion_gotoxy">
                <value name="X"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="Y"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
            </block>
            <block type="motion_glidesecs">
                <value name="SECS"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
                <value name="X"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                <value name="Y"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
            </block>
        </category>
        <category name="å¤–è§€" colour="#9966FF">
            <block type="looks_sayforsecs">
                <value name="MESSAGE"><shadow type="text"><field name="TEXT">Hello!</field></shadow></value>
                <value name="SECS"><shadow type="math_number"><field name="NUM">2</field></shadow></value>
            </block>
            <block type="looks_changeeffectby"><value name="CHANGE"><shadow type="math_number"><field name="NUM">25</field></shadow></value></block>
            <block type="looks_setsizen"><value name="SIZE"><shadow type="math_number"><field name="NUM">100</field></shadow></value></block>
        </category>
        <category name="éŸ³æ•ˆ" colour="#CF63CF">
            <block type="sound_playuntildone"><field name="SOUND">Meow</field></block>
        </category>
        <category name="äº‹ä»¶" colour="#FFBF00">
            <block type="event_whenflagclicked"></block>
            <block type="event_whenkeypressed"></block>
        </category>
        <category name="æ§åˆ¶" colour="#FFAB19">
            <block type="control_wait"><value name="DURATION"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
            <block type="control_repeat"><value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
            <block type="control_forever"></block>
            <block type="control_if"></block>
            <block type="control_if_else"></block>
        </category>
        <category name="åµæ¸¬" colour="#5CB1D6">
            <block type="sensing_touchingobject"></block>
            <block type="sensing_mousex"></block>
            <block type="sensing_mousey"></block>
        </category>
        <category name="é‹ç®—" colour="#59C059">
            <block type="operator_add"><value name="NUM1"><shadow type="math_number"><field name="NUM"></field></shadow></value><value name="NUM2"><shadow type="math_number"><field name="NUM"></field></shadow></value></block>
            <block type="operator_random"><value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value><value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
            <block type="operator_gt"><value name="OPERAND1"><shadow type="math_number"><field name="NUM"></field></shadow></value><value name="OPERAND2"><shadow type="math_number"><field name="NUM">50</field></shadow></value></block>
            <block type="logic_boolean"></block>
        </category>
        <category name="è®Šæ•¸" colour="#FF8C1A" custom="VARIABLE"></category>
    </xml>

    <script>
        // ==========================================
        // 1. å®šç¾© Scratch é¢¨æ ¼çš„è‡ªè¨‚ç©æœ¨ (Custom Blocks)
        // ==========================================
        
        // è¼”åŠ©å‡½æ•¸ï¼šè¨»å†Šç©æœ¨
        function registerBlock(name, category, args, codeGenJS, codeGenPy) {
            Blockly.Blocks[name] = {
                init: function() {
                    this.jsonInit(args);
                    this.setColour(category);
                }
            };
            Blockly.JavaScript[name] = codeGenJS;
            Blockly.Python[name] = codeGenPy;
        }

        // --- äº‹ä»¶ (Events) ---
        registerBlock('event_whenflagclicked', '#FFBF00', 
            { "message0": "ç•¶ ğŸ è¢«é»æ“Š", "nextStatement": null },
            () => '', 
            () => '# ç•¶ç¶ æ——è¢«é»æ“Š\n'
        );

        // --- å‹•ä½œ (Motion) ---
        registerBlock('motion_movesteps', '#4C97FF',
            { "message0": "ç§»å‹• %1 é»", "args0": [{"type": "input_value", "name": "STEPS"}], "previousStatement": null, "nextStatement": null },
            (b) => `await moveSteps(${Blockly.JavaScript.valueToCode(b, 'STEPS', Blockly.JavaScript.ORDER_ATOMIC) || 0});\n`,
            (b) => `sprite.move(${Blockly.Python.valueToCode(b, 'STEPS', Blockly.Python.ORDER_ATOMIC) || 0})\n`
        );
        registerBlock('motion_turnright', '#4C97FF',
            { "message0": "å³è½‰ â†» %1 åº¦", "args0": [{"type": "input_value", "name": "DEGREES"}], "previousStatement": null, "nextStatement": null },
            (b) => `turn(${Blockly.JavaScript.valueToCode(b, 'DEGREES', Blockly.JavaScript.ORDER_ATOMIC) || 0});\n`,
            (b) => `sprite.turn_right(${Blockly.Python.valueToCode(b, 'DEGREES', Blockly.Python.ORDER_ATOMIC) || 0})\n`
        );
        registerBlock('motion_gotoxy', '#4C97FF',
            { "message0": "å®šä½åˆ° x: %1 y: %2", "args0": [{"type": "input_value", "name": "X"}, {"type": "input_value", "name": "Y"}], "previousStatement": null, "nextStatement": null },
            (b) => `goTo(${Blockly.JavaScript.valueToCode(b, 'X', 0) || 0}, ${Blockly.JavaScript.valueToCode(b, 'Y', 0) || 0});\n`,
            (b) => `sprite.goto(${Blockly.Python.valueToCode(b, 'X', 0) || 0}, ${Blockly.Python.valueToCode(b, 'Y', 0) || 0})\n`
        );

        // --- æ§åˆ¶ (Control) - é—œéµåœ¨æ–¼æŠŠ JS çš„è¿´åœˆè®Šæˆ async ä»¥å…å¡æ­»ç€è¦½å™¨ ---
        registerBlock('control_wait', '#FFAB19',
            { "message0": "ç­‰å¾… %1 ç§’", "args0": [{"type": "input_value", "name": "DURATION"}], "previousStatement": null, "nextStatement": null },
            (b) => `await waitSecs(${Blockly.JavaScript.valueToCode(b, 'DURATION', 0) || 0});\n`,
            (b) => `time.sleep(${Blockly.Python.valueToCode(b, 'DURATION', 0) || 0})\n`
        );
        
        Blockly.Blocks['control_forever'] = {
            init: function() {
                this.jsonInit({ "message0": "é‡è¤‡ç„¡é™æ¬¡ %1 %2", "args0": [{"type": "input_dummy"}, {"type": "input_statement", "name": "DO"}], "previousStatement": null, "colour": "#FFAB19" });
            }
        };
        Blockly.JavaScript['control_forever'] = function(block) {
            var branch = Blockly.JavaScript.statementToCode(block, 'DO');
            // æ’å…¥ await new Promise... è®“ JS è¿´åœˆèƒ½æš«åœï¼ŒæŠŠæ§åˆ¶æ¬Šé‚„çµ¦ UI
            return `while (isRunning) { ${branch} await new Promise(r => setTimeout(r, 0)); }\n`;
        };
        Blockly.Python['control_forever'] = function(block) {
            var branch = Blockly.Python.statementToCode(block, 'DO') || '  pass\n';
            return `while True:\n${branch}`;
        };

        // --- å¤–è§€ (Looks) ---
        registerBlock('looks_sayforsecs', '#9966FF',
            { "message0": "èªª %1 %2 ç§’", "args0": [{"type": "input_value", "name": "MESSAGE"}, {"type": "input_value", "name": "SECS"}], "previousStatement": null, "nextStatement": null },
            (b) => `await say(${Blockly.JavaScript.valueToCode(b, 'MESSAGE', 0)}, ${Blockly.JavaScript.valueToCode(b, 'SECS', 0)});\n`,
            (b) => `sprite.say(${Blockly.Python.valueToCode(b, 'MESSAGE', 0)}, ${Blockly.Python.valueToCode(b, 'SECS', 0)})\n`
        );

        // ==========================================
        // 2. åˆå§‹åŒ– Blockly
        // ==========================================
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            renderer: 'zelos', // é–‹å•Ÿ Scratch 3.0 é¢¨æ ¼æ¸²æŸ“
            zoom: { startScale: 0.75 },
            grid: { spacing: 20, length: 3, colour: '#ddd', snap: true },
            trashcan: true
        });

        // è¨­ç½® Scratch ä¸»é¡Œè‰²
        workspace.setTheme(Blockly.Theme.defineTheme('scratch', {
            'base': Blockly.Themes.Classic,
            'blockStyles': {
                'hat_blocks': {'colourPrimary': '#FFBF00'},
                'loop_blocks': {'colourPrimary': '#FFAB19'},
                'logic_blocks': {'colourPrimary': '#FFAB19'}
            }
        }));

        // ==========================================
        // 3. èˆå°é‹è¡Œé‚è¼¯ (Runtime)
        // ==========================================
        let isRunning = false;
        let sprite = { x: 0, y: 0, direction: 90, element: document.getElementById('sprite') };

        // æ›´æ–°èˆå°ç•«é¢
        function updateStage() {
            // Scratch åº§æ¨™: ä¸­å¿ƒ(0,0), å³X+, ä¸ŠY+
            // CSS åº§æ¨™: å·¦ä¸Š(0,0)
            const stageW = 400, stageH = 300;
            const cssLeft = (stageW / 2) + sprite.x;
            const cssTop = (stageH / 2) - sprite.y;
            
            sprite.element.style.left = cssLeft + 'px';
            sprite.element.style.top = cssTop + 'px';
            sprite.element.style.transform = `translate(-50%, -50%) rotate(${sprite.direction - 90}deg)`;
        }

        // ç©æœ¨åŸ·è¡Œå‡½å¼åº« (çµ¦ generated JS å‘¼å«)
        async function moveSteps(steps) {
            const rad = (sprite.direction - 90) * (Math.PI / 180); // CSS 0åº¦æ˜¯å‘ä¸Šï¼ŒScratch 90åº¦æ˜¯å‘å³
            sprite.x += steps * Math.cos(rad);
            sprite.y -= steps * Math.sin(rad); // Y è»¸å‘ä¸Šç‚ºæ­£ï¼ŒCSS å‘ä¸‹ç‚ºæ­£
            updateStage();
            await new Promise(r => setTimeout(r, 10)); // å‹•ç•«å»¶é²
        }
        async function turn(deg) { sprite.direction += deg; updateStage(); }
        async function goTo(x, y) { sprite.x = x; sprite.y = y; updateStage(); }
        async function waitSecs(s) { await new Promise(r => setTimeout(r, s * 1000)); }
        async function say(msg, secs) {
            const b = document.getElementById('sprite-bubble');
            b.innerText = msg; b.style.display = 'block';
            await waitSecs(secs);
            b.style.display = 'none';
        }

        async function runCode() {
            if(isRunning) return;
            isRunning = true;
            // 1. ç”¢ç”Ÿ JS ä»£ç¢¼
            const code = Blockly.JavaScript.workspaceToCode(workspace);
            console.log("Running JS:", code);
            
            try {
                // 2. å°è£æˆ Async Function åŸ·è¡Œ
                const runFn = new Function('moveSteps', 'turn', 'goTo', 'waitSecs', 'say', 'isRunning', `return (async () => { ${code} })();`);
                await runFn(moveSteps, turn, goTo, waitSecs, say, true);
            } catch(e) {
                console.error(e);
            }
            isRunning = false;
        }

        function stopCode() { isRunning = false; }

        // ==========================================
        // 4. AI ä¸²æ¥ (Gemini API)
        // ==========================================
        
        // â˜…â˜…â˜… å¡«å¯«æ‚¨çš„ API è¨­å®š â˜…â˜…â˜…
        const API_KEY = "YOUR_GEMINI_API_KEY"; // âš ï¸ è«‹å¡«å…¥æ‚¨çš„ API Key
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
        // å¦‚æœæ‚¨ä½¿ç”¨ GAS Proxyï¼Œè«‹å°‡ API_URL æ›æˆæ‚¨çš„ GAS ç¶²å€ï¼Œä¸¦ä¿®æ”¹ fetch æ–¹æ³•

        async function getAIHelp(triggerSource) {
            const hintContent = document.getElementById('ai-hint-content');
            if(triggerSource === 'hint') hintContent.innerText = "ğŸ¤– åˆ†æä¸­...";
            else addMsg('ai', "ğŸ¤– æ­£åœ¨è®€å–ä½ çš„ç©æœ¨...");

            // 1. ç”¢ç”Ÿ Python ä»£ç¢¼ (çµ¦ AI çœ‹)
            const pythonCode = Blockly.Python.workspaceToCode(workspace);
            
            // 2. æº–å‚™ Prompt
            const prompt = `
            ä½ æ˜¯ä¸€ä½ Scratch ç¨‹å¼è¨­è¨ˆè€å¸«ã€‚
            å­¸ç”Ÿç›®å‰çš„ä»»å‹™æ˜¯ï¼š[è®“è²“å’ªç§»å‹•ä¸¦ç¢°åˆ°é‚Šç·£åå½ˆ]ã€‚
            å­¸ç”Ÿç›®å‰çš„ç©æœ¨é‚è¼¯ (è½‰æ›ç‚ºPython) å¦‚ä¸‹ï¼š
            \`\`\`python
            ${pythonCode || "# å·¥ä½œå€æ˜¯ç©ºçš„"}
            \`\`\`
            è«‹ç”¨ç¹é«”ä¸­æ–‡çµ¦äºˆç°¡çŸ­ã€é¼“å‹µæ€§çš„æç¤ºã€‚
            ä¸è¦ç›´æ¥çµ¦å‡ºå®Œæ•´ç¨‹å¼ç¢¼ï¼Œè€Œæ˜¯ç”¨ç©æœ¨çš„é¡è‰²æˆ–å½¢ç‹€ä¾†å¼•å°ã€‚
            å¦‚æœç©æœ¨é‚è¼¯çœ‹èµ·ä¾†æ­£ç¢ºï¼Œè«‹ç¨±è®šå­¸ç”Ÿã€‚
            `;

            try {
                // 3. å‘¼å« API
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();
                let reply = "AI æš«æ™‚ç„¡æ³•å›æ‡‰ã€‚";
                
                if (data.candidates && data.candidates[0].content) {
                    reply = data.candidates[0].content.parts[0].text;
                }

                if(triggerSource === 'hint') {
                    hintContent.innerHTML = marked.parse(reply);
                } else {
                    addMsg('ai', reply);
                }

            } catch(e) {
                console.error(e);
                const errMsg = "é€£ç·šå¤±æ•— (è«‹æª¢æŸ¥ API Key)";
                if(triggerSource === 'hint') hintContent.innerText = errMsg;
                else addMsg('ai', errMsg);
            }
        }

        function sendChat() {
            const input = document.getElementById('user-input');
            const msg = input.value;
            if(!msg) return;
            addMsg('user', msg);
            input.value = "";
            getAIHelp('chat'); // ç°¡å–®èµ·è¦‹ï¼ŒèŠå¤©æ™‚ä¹Ÿä¸€ä½µæŠŠç©æœ¨å‚³çµ¦ AI
        }

        function addMsg(role, text) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = marked.parse(text);
            document.getElementById('chat-msgs').appendChild(div);
            document.getElementById('chat-msgs').scrollTop = 99999;
        }

        // ==========================================
        // 5. æƒ…ç·’åµæ¸¬ (Face API)
        // ==========================================
        let stress = 0;
        async function initEmotion() {
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
            await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
            
            const video = document.getElementById('video');
            navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => video.srcObject = stream);

            setInterval(async () => {
                const det = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                if(det.length) {
                    const exps = det[0].expressions;
                    const top = Object.keys(exps).reduce((a,b)=>exps[a]>exps[b]?a:b);
                    document.getElementById('emo-val').innerText = top;
                    
                    if(['sad','angry','fearful'].includes(top)) stress += 10;
                    else stress = Math.max(0, stress - 2);
                    
                    document.getElementById('stress-bar').style.width = Math.min(100, stress) + "%";
                    
                    [cite_start]// [cite: 225] æƒ…ç·’ä»‹å…¥
                    if(stress > 80) {
                        stress = 0;
                        document.getElementById('hint-overlay').style.display = 'flex';
                    }
                }
            }, 1000);
        }
        
        initEmotion();

    </script>
</body>
</html>
