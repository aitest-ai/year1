<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç¬¬ä¸€å¹´è¨ˆç•«ï¼šScratch 3.0 é¢¨æ ¼ AI å­¸ç¿’ç³»çµ±</title>
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/python_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/zh-hant.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Scratch 3.0 é¢¨æ ¼å®šç¾© */
        :root {
            --scratch-bg: #F9F9F9;
            --scratch-ui-bg: #E9F1FC;
            --motion-color: #4C97FF;
            --control-color: #FFAB19;
            --events-color: #FFBF00;
            --looks-color: #9966FF;
            --stage-border: #E0E0E0;
        }

        body { margin: 0; display: flex; height: 100vh; font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background: var(--scratch-ui-bg); overflow: hidden; }

        /* å·¦å´ï¼šæƒ…ç·’åµæ¸¬èˆ‡ä»»å‹™ */
        .sidebar {
            width: 260px;
            background: #fff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            z-index: 10;
        }
        .cam-container {
            width: 100%; height: 180px; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 10px; border: 3px solid #FF6666;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .stress-meter { height: 6px; background: #eee; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .stress-fill { height: 100%; width: 0%; background: #FF6666; transition: width 0.5s; }

        /* ä¸­é–“ï¼šç©æœ¨å·¥ä½œå€ */
        .workspace-area {
            flex: 1;
            position: relative;
        }
        #blocklyDiv {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        }

        /* å³å´ï¼šèˆå°èˆ‡ AI */
        .stage-area {
            width: 350px;
            background: #fff;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        /* æ¨¡æ“¬èˆå° */
        .stage {
            width: 100%;
            height: 250px; /* 4:3 */
            background: #fff;
            border: 2px solid var(--stage-border);
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .sprite {
            font-size: 50px;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.5s;
        }

        /* AI å°è©±æ¡† */
        .chat-box {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            background: #fdfdfd;
        }
        .chat-history {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-size: 0.9em;
        }
        .ai-msg { background: #E6F7FF; padding: 8px; border-radius: 8px; margin-bottom: 5px; color: #333; }
        .user-msg { background: var(--motion-color); color: white; padding: 8px; border-radius: 8px; margin-bottom: 5px; align-self: flex-end; text-align: right; }
        .chat-input-area {
            display: flex; padding: 5px; border-top: 1px solid #eee;
        }
        input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
        
        /* å½ˆçª—æ¨£å¼ */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 999; display: none;
            justify-content: center; align-items: center;
        }
        .modal {
            background: white; width: 400px; padding: 20px; border-radius: 12px;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .btn {
            background: var(--motion-color); color: white; border: none;
            padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; margin: 5px;
        }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background: #999; }
    </style>
</head>
<body>

    <div id="ai-overlay" class="overlay">
        <div class="modal">
            <h2 style="color:#FFAB19;">ğŸ± é‡åˆ°å›°é›£äº†å—ï¼Ÿ</h2>
            <p>åµæ¸¬åˆ°æ‚¨ä¼¼ä¹æœ‰äº›ç„¦æ…®ã€‚AI åŠ©æ•™å¯ä»¥å¹«æ‚¨æª¢æŸ¥ç›®å‰çš„ç©æœ¨ï¼Œçµ¦ä¸€é»æç¤ºå–”ï¼</p>
            <div id="hint-text" style="background:#f0f0f0; padding:10px; margin:10px 0; border-radius:5px; text-align:left; font-size:0.9em; color:#555;">
                (é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼ŒAI å°‡è®€å–æ‚¨çš„ç©æœ¨çµæ§‹...)
            </div>
            <button class="btn" onclick="askAIForHelp()">ğŸ” å¹«æˆ‘çœ‹ç©æœ¨çµ¦å»ºè­°</button>
            <button class="btn btn-secondary" onclick="closeOverlay()">å†è©¦è©¦çœ‹</button>
        </div>
    </div>

    <div class="sidebar">
        <h3 style="color:var(--motion-color); margin:0 0 10px 0;">Scratch AI å¯¦é©—å®¤</h3>
        
        <div class="cam-container"><video id="video" autoplay muted playsinline></video></div>
        <div style="font-size:0.8em; color:#666;">
            æƒ…ç·’ç‹€æ…‹: <span id="emo-label" style="font-weight:bold; color:var(--control-color)">åµæ¸¬ä¸­...</span>
            <div class="stress-meter"><div id="stress-bar" class="stress-fill"></div></div>
        </div>

        <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">
        
        <div style="background:#FFF9E6; padding:10px; border-radius:5px; border:1px solid #FFE082;">
            <strong>ğŸ¯ æœ¬é€±ä»»å‹™</strong><br>
            <small>è«‹ä½¿ç”¨ã€Œäº‹ä»¶ã€å’Œã€Œæ§åˆ¶ã€ç©æœ¨ï¼Œè®“è²“å’ªæ¯éš” 1 ç§’è½‰å‹•ä¸€æ¬¡ï¼Œé‡è¤‡ 10 æ¬¡ã€‚</small>
        </div>
    </div>

    <div class="workspace-area">
        <div id="blocklyDiv"></div>
    </div>

    <div class="stage-area">
        <div class="stage">
            <div id="sprite" class="sprite">ğŸ±</div>
        </div>
        <button class="btn" style="background:#4CAF50; width:100%; margin-bottom:10px;" onclick="runBlocks()">ğŸ åŸ·è¡Œç¨‹å¼ (Green Flag)</button>

        <div class="chat-box">
            <div class="chat-history" id="chat-history">
                <div class="ai-msg">å—¨ï¼è©¦è‘—å¾å·¦é‚Šæ‹–æ‹‰ç©æœ¨ã€‚æˆ‘çœ‹å¾—æ‡‚ä½ æ‹¼äº†ä»€éº¼å–”ï¼</div>
            </div>
            <div class="chat-input-area">
                <input id="chat-input" placeholder="å•å• AI..." onkeypress="if(event.key==='Enter') sendChat()">
            </div>
        </div>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="å‹•ä½œ (Motion)" colour="#4C97FF">
            <block type="move_steps"></block>
            <block type="turn_right"></block>
        </category>
        <category name="æ§åˆ¶ (Control)" colour="#FFAB19">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <shadow type="math_number"><field name="NUM">10</field></shadow>
                </value>
            </block>
            <block type="wait_seconds"></block>
        </category>
        <category name="äº‹ä»¶ (Events)" colour="#FFBF00">
            <block type="event_whenflagclicked"></block>
        </category>
        <category name="é‹ç®— (Operators)" colour="#59C059">
            <block type="math_number"></block>
        </category>
    </xml>

    <script>
        // ==========================================
        // 1. å®šç¾© Scratch é¢¨æ ¼çš„è‡ªè¨‚ç©æœ¨
        // ==========================================
        
        // ç•¶ç¶ æ——è¢«é»æ“Š
        Blockly.Blocks['event_whenflagclicked'] = {
            init: function() {
                this.appendDummyInput().appendField("ç•¶ ğŸ è¢«é»æ“Š");
                this.setNextStatement(true, null);
                this.setColour("#FFBF00"); // Scratch Event Yellow
            }
        };
        Blockly.Python['event_whenflagclicked'] = function(block) { return ''; };

        // ç§»å‹• 10 é»
        Blockly.Blocks['move_steps'] = {
            init: function() {
                this.appendDummyInput().appendField("ç§»å‹•").appendField(new Blockly.FieldNumber(10), "STEPS").appendField("é»");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour("#4C97FF"); // Scratch Motion Blue
            }
        };
        Blockly.Python['move_steps'] = function(block) { return 'move(' + block.getFieldValue('STEPS') + ')\n'; };

        // å³è½‰
        Blockly.Blocks['turn_right'] = {
            init: function() {
                this.appendDummyInput().appendField("å³è½‰ â†»").appendField(new Blockly.FieldNumber(15), "DEG").appendField("åº¦");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour("#4C97FF");
            }
        };
        Blockly.Python['turn_right'] = function(block) { return 'turn(' + block.getFieldValue('DEG') + ')\n'; };

        // ç­‰å¾…
        Blockly.Blocks['wait_seconds'] = {
            init: function() {
                this.appendDummyInput().appendField("ç­‰å¾…").appendField(new Blockly.FieldNumber(1), "SEC").appendField("ç§’");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour("#FFAB19"); // Scratch Control Orange
            }
        };
        Blockly.Python['wait_seconds'] = function(block) { return 'wait(' + block.getFieldValue('SEC') + ')\n'; };

        // ==========================================
        // 2. åˆå§‹åŒ– Blockly (å•Ÿç”¨ Zelos æ¸²æŸ“å™¨)
        // ==========================================
        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            renderer: 'zelos',  // â˜… é—œéµï¼šé€™æœƒè®“ç©æœ¨è®Šåƒ Scratch 3.0
            zoom: { startScale: 0.8 },
            grid: { spacing: 20, length: 3, colour: '#ccc', snap: true },
            trashcan: true
        });

        // å®šç¾© Scratch 3.0 ä¸»é¡Œé¡è‰²
        const scratchTheme = Blockly.Theme.defineTheme('scratch', {
            'base': Blockly.Themes.Classic,
            'blockStyles': {
                'hat_blocks': { 'colourPrimary': '#FFBF00' },
                'loop_blocks': { 'colourPrimary': '#FFAB19' }
            }
        });
        workspace.setTheme(scratchTheme);

        // ==========================================
        // 3. AI é‚è¼¯æ ¸å¿ƒ (GAS API)
        // ==========================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzkAH1B96FAMUhSf-n6ET5x8h8BXtXpxgIApmQraqk39rIZOhgUuOi94zmy1AuZMXAqXg/exec";

        async function askAIForHelp() {
            const hintText = document.getElementById('hint-text');
            hintText.innerText = "ğŸ¤– æ­£åœ¨åˆ†ææ‚¨çš„ç©æœ¨çµæ§‹...";
            
            // â˜…â˜…â˜… æ ¸å¿ƒæŠ€è¡“ï¼šæŠŠç©æœ¨è½‰æˆé‚è¼¯ä»£ç¢¼ â˜…â˜…â˜…
            const codeLogic = Blockly.Python.workspaceToCode(workspace);
            console.log("Extracted Code:", codeLogic); // æ‚¨å¯ä»¥åœ¨ Console çœ‹åˆ°æŠ½å–å‡ºçš„ç¨‹å¼ç¢¼

            // å»ºæ§‹ Prompt
            const prompt = `
            ä½ æ˜¯ä¸€å€‹ Scratch ç¨‹å¼è¨­è¨ˆåŠ©æ•™ã€‚
            å­¸ç”Ÿçš„ä»»å‹™æ˜¯ï¼š[è®“è²“å’ªæ¯éš”1ç§’è½‰å‹•ä¸€æ¬¡ï¼Œé‡è¤‡10æ¬¡]ã€‚
            
            ç›®å‰å­¸ç”Ÿæ‹¼å‡ºçš„ç©æœ¨é‚è¼¯å¦‚ä¸‹ (Pythonæ ¼å¼)ï¼š
            \`\`\`python
            ${codeLogic || "ç›®å‰å·¥ä½œå€æ˜¯ç©ºçš„"}
            \`\`\`
            
            è«‹é‡å°ä»–çš„é€²åº¦çµ¦äºˆæç¤ºã€‚
            - å¦‚æœä»–æ˜¯ç©ºçš„ï¼Œå»ºè­°ä»–å…ˆæ‰¾ã€Œäº‹ä»¶ã€ç©æœ¨ã€‚
            - å¦‚æœä»–æ²’ç”¨è¿´åœˆï¼Œå»ºè­°ä»–æ‰¾æ©˜è‰²çš„ã€Œæ§åˆ¶ã€ç©æœ¨ã€‚
            - ç”¨ç¹é«”ä¸­æ–‡ï¼Œèªæ°£æ´»æ½‘ï¼Œä¸è¦ç›´æ¥çµ¦ç¨‹å¼ç¢¼ã€‚
            `;

            try {
                // é€™è£¡æ¨¡æ“¬ AI å›æ‡‰ (å¯¦éš›å°ˆæ¡ˆè«‹é–‹å•Ÿ fetch)
                /* const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({type:'CALL_GEMINI', prompt: prompt}) });
                */
                
                // æ¨¡æ“¬å»¶é²èˆ‡å›æ‡‰
                setTimeout(() => {
                    let advice = "";
                    if(!codeLogic) advice = "çœ‹èµ·ä¾†å·¥ä½œå€ç©ºç©ºçš„å‘¢ï¼æ‰€æœ‰ç¨‹å¼éƒ½æ˜¯å¾é»ƒè‰²çš„ã€Œç•¶ç¶ æ——è¢«é»æ“Šã€é–‹å§‹çš„å–”ï¼Œè¦ä¸è¦å»äº‹ä»¶å€æ‰¾æ‰¾çœ‹ï¼Ÿ";
                    else if(!codeLogic.includes("for")) advice = "ä½ å·²ç¶“è®“è²“å’ªå‹•èµ·ä¾†äº†ï¼Œå¾ˆæ£’ï¼ä½†æ˜¯è¦è®“å®ƒã€Œé‡è¤‡ã€åšé€™ä»¶äº‹ï¼Œæ˜¯ä¸æ˜¯å°‘äº†ä¸€å€‹æ©˜è‰²çš„ç©æœ¨å‘¢ï¼Ÿ";
                    else if(!codeLogic.includes("wait")) advice = "æœ‰é‡è¤‡äº†ï¼ä½†æ˜¯è²“å’ªè½‰å¾—å¤ªå¿«äº†ï¼Œçœ¼ç›çœ‹ä¸æ¸…æ¥šã€‚è©¦è‘—åœ¨è¿´åœˆè£¡åŠ ä¸€å€‹ã€Œç­‰å¾…ã€ç©æœ¨çœ‹çœ‹ï¼Ÿ";
                    else advice = "çœ‹èµ·ä¾†å¾ˆå®Œç¾ï¼è©¦è‘—æŒ‰ä¸‹ç¶ æ——åŸ·è¡Œçœ‹çœ‹å§ï¼";

                    hintText.innerHTML = `<strong>ğŸ’¡ AI å»ºè­°ï¼š</strong><br>${advice}`;
                }, 1500);

            } catch(e) { hintText.innerText = "é€£ç·šå¤±æ•—"; }
        }

        function closeOverlay() { document.getElementById('ai-overlay').style.display = 'none'; }

        // ==========================================
        // 4. æƒ…ç·’åµæ¸¬èˆ‡æ¨¡æ“¬åŸ·è¡Œ
        // ==========================================
        let stress = 0;
        async function initFaceAPI() {
            const URL = 'https://justadudewhohacks.github.io/face-api.js/models';
            await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(URL);
            
            const video = document.getElementById('video');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            
            video.addEventListener('play', () => {
                setInterval(async () => {
                    const dets = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                    if(dets.length > 0) {
                        const exps = dets[0].expressions;
                        const top = Object.keys(exps).reduce((a, b) => exps[a] > exps[b] ? a : b);
                        
                        const map = {neutral:"å¹³éœ", happy:"é–‹å¿ƒ", sad:"æ²®å–ª", angry:"ç”Ÿæ°£", fearful:"ç„¦æ…®"};
                        document.getElementById('emo-label').innerText = map[top] || top;

                        // å£“åŠ›æ¨¡æ“¬
                        if(['sad','angry','fearful'].includes(top)) stress += 10;
                        else stress = Math.max(0, stress - 5);
                        
                        document.getElementById('stress-bar').style.width = Math.min(100, stress) + "%";

                        if(stress > 80) {
                            stress = 0;
                            document.getElementById('ai-overlay').style.display = 'flex';
                        }
                    }
                }, 1000);
            });
        }

        // ç°¡å–®çš„ç©æœ¨åŸ·è¡Œæ¨¡æ“¬ (ä½¿ç”¨ eval, æ³¨æ„å®‰å…¨ä½†åœ¨é€™å€‹å°é–‰ç’°å¢ƒå¯æ¥å—)
        function runBlocks() {
            const code = Blockly.Python.workspaceToCode(workspace);
            // é€™è£¡å¯«ä¸€å€‹ç°¡å–®çš„ç›´è­¯å™¨ä¾†è®“è²“å’ªå‹•
            // å¯¦éš›ä¸Šéœ€è¦æŠŠ Python code å°æ‡‰åˆ° JS å‹•ç•«
            alert("æ¨¡æ“¬åŸ·è¡Œé‚è¼¯ï¼š\n" + code);
            
            // ç°¡å–®å‹•ç•«æ¼”ç¤º
            const sprite = document.getElementById('sprite');
            let deg = 0;
            const interval = setInterval(() => {
                deg += 15;
                sprite.style.transform = `translate(-50%, -50%) rotate(${deg}deg)`;
            }, 500);
            setTimeout(() => clearInterval(interval), 5000);
        }

        function sendChat() {
            const v = document.getElementById('chat-input').value;
            if(!v) return;
            const h = document.getElementById('chat-history');
            h.innerHTML += `<div class="user-msg">${v}</div>`;
            document.getElementById('chat-input').value = "";
            h.scrollTop = h.scrollHeight;
            setTimeout(() => {
                 h.innerHTML += `<div class="ai-msg">é—œæ–¼ã€Œ${v}ã€ï¼Œä½ å¯ä»¥åƒè€ƒå·¦é‚Šçš„ç©æœ¨å€...</div>`;
                 h.scrollTop = h.scrollHeight;
            }, 1000);
        }

        initFaceAPI();

    </script>
</body>
</html>
